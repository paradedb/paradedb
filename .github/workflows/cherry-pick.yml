name: Cherry Pick

on:
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  validate-cherry-pick-labels:
    name: Validate Cherry Pick Labels
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Check for explicit cherry pick behavior
        run: |
          labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          has_cherry_pick=$(echo "$labels" | jq '[.[] | select(startswith("cherry-pick/"))] | length')
          has_do_not_cherry_pick=$(echo "$labels" | jq '[.[] | . == "Do Not Cherry Pick"] | length')

          if [ "$has_cherry_pick" -eq 0 ] && [ "$has_do_not_cherry_pick" -eq 0 ]; then
            echo "❌ PR must have either cherry-pick/* labels OR 'Do Not Cherry Pick' label"
            echo "Please add appropriate labels to define the cherry pick behavior for this PR."
            exit 1
          fi

          if [ "$has_cherry_pick" -gt 0 ] && [ "$has_do_not_cherry_pick" -gt 0 ]; then
            echo "❌ PR has both 'Do Not Cherry Pick' and cherry-pick labels"
            echo "Please choose either 'Do Not Cherry Pick' OR cherry-pick/* labels, not both."
            exit 1
          fi

  get-branches:
    name: Get Cherry Pick Branches
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.set-branches.outputs.branches }}
    steps:
      - name: Set cherry-pick branches
        id: set-branches
        run: |
          labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          has_do_not_cherry_pick=$(echo "$labels" | jq '[.[] | . == "Do Not Cherry Pick"] | length')

          if [ "$has_do_not_cherry_pick" -gt 0 ]; then
            echo "branches=[]" >> $GITHUB_OUTPUT
          else
            branches=$(echo "$labels" | jq -c '[.[] | select(startswith("cherry-pick/")) | sub("cherry-pick/"; "")]')
            echo "branches=${branches}" >> $GITHUB_OUTPUT
          fi

  cherry-pick:
    name: Cherry Pick
    needs: [validate-cherry-pick-labels, get-branches]
    if: needs.get-branches.outputs.branches != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJSON(needs.get-branches.outputs.branches) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
      - name: Cherry Pick to ${{ matrix.branch }}
        uses: carloscastrojumo/github-cherry-pick-action@v1
        with:
          branch: ${{ matrix.branch }}
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
          inherit_labels: false
          labels: automated-cherry-pick
