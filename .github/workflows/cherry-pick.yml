name: Cherry Pick

on:
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  get-branches:
    name: Get Cherry Pick Branches
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.set-branches.outputs.branches }}

    steps:
      - name: Set cherry-pick branches
        id: set-branches
        run: |
          labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          branches=$(echo "$labels" | jq -c '[.[] | select(startswith("cherry-pick/")) | sub("cherry-pick/"; "")]')
          echo "branches=${branches}" >> $GITHUB_OUTPUT

  cherry-pick:
    name: Cherry Pick
    needs: [get-branches]
    if: needs.get-branches.outputs.branches != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJSON(needs.get-branches.outputs.branches) }}

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}

      - name: Cherry pick to ${{ matrix.branch }}
        id: cherry_pick_action
        uses: carloscastrojumo/github-cherry-pick-action@v1
        continue-on-error: true
        with:
          branch: ${{ matrix.branch }}
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
          inherit_labels: false
          labels: automated-cherry-pick

      - name: Open PR from original changes to target on conflict
        if: steps.cherry_pick_action.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
        run: |
          set -euxo pipefail

          TARGET_BRANCH="${{ matrix.branch }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          REPO="${{ github.repository }}"

          # Create a new branch from the original PR's head commit,
          # independent of whether the original branch still exists.
          NEW_BRANCH="cherry-pick/${TARGET_BRANCH}/${PR_NUMBER}-from-head"

          git fetch origin
          git checkout -b "${NEW_BRANCH}" "${HEAD_SHA}"
          git push -u origin "${NEW_BRANCH}"

          TITLE="Cherry pick #${PR_NUMBER} to ${TARGET_BRANCH}"
          BODY="Backport of #${PR_NUMBER} to \`${TARGET_BRANCH}\`. The automated cherry-pick via \`github-cherry-pick-action\` failed due to conflicts. This PR is raised from a branch created at the original PR head commit (\`${HEAD_SHA}\`) against \`${TARGET_BRANCH}\` without any rebase or cherry-pick. Please resolve any conflicts and adjust the changes manually."

          gh pr create \
            --repo "${REPO}" \
            --base "${TARGET_BRANCH}" \
            --head "${NEW_BRANCH}" \
            --title "${TITLE}" \
            --body "${BODY}" \
            --label "automated-cherry-pick"
