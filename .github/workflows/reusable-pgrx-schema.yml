# Reusable workflow to generate pgrx schema from a git ref
# Used by schemabot-generate-diff.yml to parallelize schema generation

name: Generate pgrx Schema

on:
  workflow_call:
    inputs:
      git_ref:
        description: "Git ref to checkout and generate schema from"
        required: true
        type: string
      pg_version:
        description: "PostgreSQL version"
        required: false
        type: string
        default: "14"
      artifact_name:
        description: "Name for the output artifact"
        required: true
        type: string
    outputs:
      pgrx_version:
        description: "The pgrx version used"
        value: ${{ jobs.generate-schema.outputs.pgrx_version }}

jobs:
  generate-schema:
    name: Generate Schema
    runs-on: ubicloud-standard-8-ubuntu-2404
    outputs:
      pgrx_version: ${{ steps.pgrx.outputs.version }}
    defaults:
      run:
        shell: bash -eo pipefail {0}

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.git_ref }}

      - name: Extract pgrx Version
        id: pgrx
        working-directory: pg_search/
        run: |
          version=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache"
          shared-key: pg${{ inputs.pg_version }}-${{ hashFiles('**/Cargo.lock') }}
          cache-targets: true
          cache-all-crates: true

      - name: Cache cargo-pgrx binary
        id: cache-pgrx-bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-pgrx
          key: cargo-pgrx-${{ steps.pgrx.outputs.version }}

      - name: Cache pgrx init
        id: cache-pgrx-init
        uses: actions/cache@v4
        with:
          path: ~/.pgrx
          key: pgrx-init-pg${{ inputs.pg_version }}-${{ steps.pgrx.outputs.version }}

      - name: Install & Configure Supported PostgreSQL Version
        run: |
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update && sudo apt-get install -y postgresql-${{ inputs.pg_version }} postgresql-server-dev-${{ inputs.pg_version }}
          echo "/usr/lib/postgresql/${{ inputs.pg_version }}/bin" >> $GITHUB_PATH

      - name: Install cargo-pgrx
        if: steps.cache-pgrx-bin.outputs.cache-hit != 'true'
        run: cargo install -j $(nproc) --locked cargo-pgrx --version ${{ steps.pgrx.outputs.version }} --debug

      - name: Initialize pgrx
        if: steps.cache-pgrx-init.outputs.cache-hit != 'true'
        run: cargo pgrx init "--pg${{ inputs.pg_version }}=/usr/lib/postgresql/${{ inputs.pg_version }}/bin/pg_config"

      - name: Generate Schema
        run: cargo pgrx schema -p pg_search pg${{ inputs.pg_version }} > schema.sql

      - name: Upload Schema Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: schema.sql
          retention-days: 1
