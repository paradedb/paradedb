# workflows/schemabot-generate-diff.yml
#
# SchemaBot Generate Diff
# Determine if a commit introduces an extension schema change for pg_search and post a comment to the PR.

name: SchemaBot Generate Diff

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/schemabot-generate-diff.yml"
      - "pg_search/**"
      - "!pg_search/README.md"
  workflow_dispatch:

# Required to post a comment to the PR
permissions:
  pull-requests: write
  issues: write

concurrency:
  group: schemabot-generate-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  schemabot-generate-diff:
    name: SchemaBot
    # TODO: See https://github.com/paradedb/paradedb/issues/3613
    runs-on: ubicloud-standard-8-ubuntu-2204
    defaults:
      run:
        shell: bash -eo pipefail {0}
    strategy:
      matrix:
        pg_version: [14] # pg_search's minimum supported Postgres version

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch the entire history
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Extract pgrx Version
        id: pgrx
        working-directory: pg_search/
        run: |
          version=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache"
          shared-key: pg${{ matrix.pg_version }}-${{ hashFiles('**/Cargo.lock') }}
          cache-targets: true
          cache-all-crates: true

      - name: Install & Configure Supported PostgreSQL Version
        run: |
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update && sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
          echo "/usr/lib/postgresql/${{ matrix.pg_version }}/bin" >> $GITHUB_PATH

      - name: Install pg-schema-diff and its Required Dependencies
        run: |
          sudo apt install clang llvm diffutils
          cargo install --git https://github.com/zombodb/pg-schema-diff.git --debug --force

      - name: Install cargo-pgrx
        run: |
          cargo install -j $(nproc) --locked cargo-pgrx --version ${{ steps.pgrx.outputs.version }} --debug
          cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"

          # Save the pgrx version for comparison later
          echo "FIRST_PGRX_VERSION=${PGRX_VERSION}" >> $GITHUB_ENV

      - name: Generate Schema from this git rev
        run: |
          cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/this.sql
          cp ~/this.sql ~/this_raw.sql  # Keep raw copy for artifacts

      - name: Switch to Base git rev and Generate Schema Again
        run: |
          # Switch to the base git rev
          git checkout .
          git checkout ${{ github.event.pull_request.base.ref }}

          # See if we need a different cargo-pgrx and install it if so
          THIS_PGRX_VERSION=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ "${THIS_PGRX_VERSION}" != "${FIRST_PGRX_VERSION}" ]]; then
            # Install cargo-pgrx
            cargo install -j $(nproc) --locked cargo-pgrx --version ${THIS_PGRX_VERSION} --force --debug

            # Initialize it (again) -- probably unnecessary, but might as well in case ~/.pgrx/config.toml ever changes
            cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"
          fi

          # Generate schema
          cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/old.sql
          cp ~/old.sql ~/old_raw.sql  # Keep raw copy for artifacts

      - name: Generate Schema Diffs
        run: |
          # Show schema sizes for diagnostics
          echo "Schema file sizes:"
          echo "  Old schema: $(wc -l < ~/old_raw.sql) lines, $(wc -c < ~/old_raw.sql) bytes"
          echo "  New schema: $(wc -l < ~/this_raw.sql) lines, $(wc -c < ~/this_raw.sql) bytes"
          echo

          # Show raw schemas in collapsed sections for inline reference
          echo "<details>"
          echo "<summary>üìÑ Raw Old Schema (before normalization) - click to expand</summary>"
          echo ""
          echo '```sql'
          head -100 ~/old_raw.sql
          if [ $(wc -l < ~/old_raw.sql) -gt 100 ]; then
            echo "... (truncated to first 100 lines, see artifacts for full file)"
          fi
          echo '```'
          echo "</details>"
          echo
          echo "<details>"
          echo "<summary>üìÑ Raw New Schema (before normalization) - click to expand</summary>"
          echo ""
          echo '```sql'
          head -100 ~/this_raw.sql
          if [ $(wc -l < ~/this_raw.sql) -gt 100 ]; then
            echo "... (truncated to first 100 lines, see artifacts for full file)"
          fi
          echo '```'
          echo "</details>"
          echo

          # Normalize schemas by removing pgrx-generated noise
          echo "Normalizing schemas to remove pgrx-generated hashes..."

          # Remove hash-based function names and comments that change on every build
          normalize_schema() {
            sed -E \
              -e 's/_[0-9a-f]{32}/_HASH/g' \
              -e 's/-- pg_search::[^:]+::[^:]+::_[0-9a-f]+/-- HASH_COMMENT/g' \
              "$1"
          }

          normalize_schema ~/old.sql > ~/old_normalized.sql
          normalize_schema ~/this.sql > ~/this_normalized.sql

          # Run pg-schema-diff with increased stack size on normalized schemas
          set +e  # Temporarily disable exit on error
          RUST_MIN_STACK=8388608 pg-schema-diff diff ~/old_normalized.sql ~/this_normalized.sql 2>&1 | grep -v "^$" > ~/diff.sql
          PG_SCHEMA_DIFF_EXIT=$?
          set -e  # Re-enable exit on error

          # Check if pg-schema-diff crashed or had an error
          if [ $PG_SCHEMA_DIFF_EXIT -ne 0 ]; then
            echo "‚ö†Ô∏è  WARNING: pg-schema-diff failed with exit code $PG_SCHEMA_DIFF_EXIT"
            echo "Output:"
            cat ~/diff.sql
            echo
            echo "Falling back to filtered diff..."

            # Generate a filtered diff that focuses on actual SQL changes
            diff ~/old_normalized.sql ~/this_normalized.sql 2>&1 | \
              grep -E "^[<>].*\b(CREATE|ALTER|DROP|RETURNS|AS 'MODULE_PATHNAME')" | \
              grep -v "HASH" | \
              sort -u > ~/diff_filtered.txt || true

            if [ -s ~/diff_filtered.txt ]; then
              echo "-- Filtered schema changes (normalized):" > ~/diff.sql
              cat ~/diff_filtered.txt >> ~/diff.sql
            else
              echo "‚úÖ No significant schema differences detected after normalization"
              > ~/diff.sql  # Empty the diff file
            fi
          fi

          # Generate a full traditional diff for detailed review (exit code doesn't matter)
          (diff -u ~/old_normalized.sql ~/this_normalized.sql > ~/diff.patch) || true

          # Show the schema diff
          if [ -s ~/diff.sql ]; then
            echo "Schema diff (normalized):"
            cat ~/diff.sql
          else
            echo "‚úÖ No schema differences detected"
          fi

      - name: Check Schema Diff and Validate Migration
        id: check_schema_diff
        run: |
          if test -s ~/diff.sql; then
            echo "=========================================="
            echo "SCHEMA DIFFERENCE DETECTED"
            echo "=========================================="
            echo

            # Check if this is a filtered diff (pg-schema-diff failed)
            if grep -q "^-- Filtered schema changes" ~/diff.sql; then
              echo "‚ö†Ô∏è  Note: pg-schema-diff tool failed, showing filtered changes"
              echo
              echo "Key SQL changes detected:"
              grep -v "^-- Filtered" ~/diff.sql | head -50

              if [ $(wc -l < ~/diff.sql) -gt 50 ]; then
                echo "... (truncated, see full diff below)"
              fi

              echo
            echo "--- BEGIN DETAILED DIFF (first 200 lines) ---"
              head -200 ~/diff.patch
              echo "--- END DETAILED DIFF ---"
              echo
              echo "‚ö†Ô∏è  WARNING: Schema differences detected."
              echo "The schemas have been normalized to remove pgrx hash noise."
              echo "Please review the key changes above and update the migration file."
              echo
              echo "üì¶ Full schema files are available as GitHub Actions artifacts for detailed inspection."

              # Don't fail immediately - let the function check below determine if this is significant
            else
              echo "A suggested upgrade.sql script follows. Please review it carefully as SchemaBot is not infallible."
              echo
              echo "--- BEGIN SUGGESTED UPGRADE SCRIPT ---"
              cat ~/diff.sql
              echo "--- END SUGGESTED UPGRADE SCRIPT ---"
              echo
              echo "=========================================="
              echo "FULL SCHEMA DIFF"
              echo "=========================================="
              cat ~/diff.patch
              echo
              echo "=========================================="
            fi

            # Find the most recent migration file for pg_search
            MIGRATION_FILE=$(ls -t pg_search/sql/pg_search--*.sql 2>/dev/null | head -n 1)

            if [ -z "$MIGRATION_FILE" ]; then
              echo "‚ùå ERROR: Schema changed but no migration file found in pg_search/sql/"
              echo "Please create a migration file (e.g., pg_search--X.Y.Z--X.Y.Z+1.sql) with the schema changes."
              exit 1
            fi

            echo "Found migration file: $MIGRATION_FILE"
            echo
            echo "Checking if migration file contains the necessary schema changes..."

            # Extract meaningful changes from the diff
            # Look for CREATE/ALTER/DROP statements and RETURNS type changes
            DIFF_FUNCTIONS=$(grep -oP "(?<=FUNCTION )[\w.\"]+\.[\w\"]+(?=\()" ~/diff.sql | grep -v "HASH" | sort -u || true)
            DIFF_RETURNS=$(grep "RETURNS" ~/diff.sql | grep -v "HASH" || true)

            # Count meaningful changes (ignore hash-only changes)
            MEANINGFUL_CHANGES=$(grep -E "^[<>].*\b(CREATE|ALTER|DROP|RETURNS)" ~/diff.sql 2>/dev/null | grep -v "HASH" | wc -l || echo "0")

            echo "Meaningful SQL changes detected: $MEANINGFUL_CHANGES"

            if [ "$MEANINGFUL_CHANGES" -eq 0 ]; then
              echo "‚úÖ No meaningful schema changes detected (only pgrx-generated hash changes)"
              echo "Migration file update not required."
              exit 0
            fi

            if [ -n "$DIFF_FUNCTIONS" ]; then
              echo
              echo "Functions affected by schema change:"
              echo "$DIFF_FUNCTIONS"
              echo

              MIGRATION_MISSING=""
              # Check if each function appears in the migration file
              while IFS= read -r func; do
                [ -z "$func" ] && continue
                # Remove quotes and extract just the function name
                func_name=$(echo "$func" | sed 's/"//g' | awk -F. '{print $NF}')
                if ! grep -qi "$func_name" "$MIGRATION_FILE"; then
                  MIGRATION_MISSING="${MIGRATION_MISSING}  - $func (function: $func_name)\n"
                fi
              done <<< "$DIFF_FUNCTIONS"

              if [ -n "$MIGRATION_MISSING" ]; then
                echo "‚ùå ERROR: Migration file is missing changes for the following functions:"
                echo -e "$MIGRATION_MISSING"
                echo
                echo "The migration file at $MIGRATION_FILE needs to be updated."
                echo "Please add the suggested upgrade script shown above to your migration file."
                exit 1
              fi
            fi

            # Check for return type changes
            if [ -n "$DIFF_RETURNS" ]; then
              echo
              echo "Return type changes detected:"
              echo "$DIFF_RETURNS" | head -10
              echo
            fi

            echo "‚úÖ Migration file appears to contain references to the affected functions"
            echo
            echo "‚ö†Ô∏è  Please manually verify that the migration file:"
            echo "   $MIGRATION_FILE"
            echo "   correctly implements all changes shown in the suggested upgrade script."
            echo
            echo "=========================================="
            echo "REFERENCE FILES"
            echo "=========================================="
            echo
            echo "üì¶ The following files are available as GitHub Actions artifacts:"
            echo "  ‚Ä¢ old_raw.sql - Base branch schema (raw, before normalization)"
            echo "  ‚Ä¢ this_raw.sql - Current branch schema (raw, before normalization)"
            echo "  ‚Ä¢ old_normalized.sql - Base branch schema (normalized)"
            echo "  ‚Ä¢ this_normalized.sql - Current branch schema (normalized)"
            echo "  ‚Ä¢ diff.sql - Suggested upgrade script"
            echo "  ‚Ä¢ diff.patch - Full unified diff"
            echo
            echo "Download artifacts from the GitHub Actions run summary page."
          else
            echo "‚úÖ No schema difference detected"
            echo "schema_diff_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy Schema Files to Workspace for Artifacts
        if: always()
        run: |
          mkdir -p schema-artifacts
          cp ~/old_raw.sql schema-artifacts/ || true
          cp ~/this_raw.sql schema-artifacts/ || true
          cp ~/old_normalized.sql schema-artifacts/ || true
          cp ~/this_normalized.sql schema-artifacts/ || true
          cp ~/diff.sql schema-artifacts/ || true
          cp ~/diff.patch schema-artifacts/ || true
          ls -lh schema-artifacts/

      - name: Upload Schema Files as Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-files-pg${{ matrix.pg_version }}
          path: schema-artifacts/
          retention-days: 30
          if-no-files-found: warn
