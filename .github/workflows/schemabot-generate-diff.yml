# workflows/schemabot-generate-diff.yml
#
# SchemaBot Generate Diff
# Determine if a commit introduces an extension schema change for pg_search and post a comment to the PR.

name: SchemaBot Generate Diff

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/schemabot-generate-diff.yml"
      - "pg_search/**"
      - "!pg_search/README.md"
  workflow_dispatch:

# Required to post a comment to the PR
permissions:
  pull-requests: write
  issues: write

concurrency:
  group: schemabot-generate-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  schemabot-generate-diff:
    name: SchemaBot
    # TODO: See https://github.com/paradedb/paradedb/issues/3613
    runs-on: ubicloud-standard-8-ubuntu-2204
    defaults:
      run:
        shell: bash -eo pipefail {0}
    strategy:
      matrix:
        pg_version: [14] # pg_search's minimum supported Postgres version

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch the entire history
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Extract pgrx Version
        id: pgrx
        working-directory: pg_search/
        run: |
          version=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache"
          shared-key: pg${{ matrix.pg_version }}-${{ hashFiles('**/Cargo.lock') }}
          cache-targets: true
          cache-all-crates: true

      - name: Install & Configure Supported PostgreSQL Version
        run: |
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update && sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
          echo "/usr/lib/postgresql/${{ matrix.pg_version }}/bin" >> $GITHUB_PATH

      - name: Install pg-schema-diff and its Required Dependencies
        run: |
          sudo apt install clang llvm diffutils
          cargo install --git https://github.com/zombodb/pg-schema-diff.git --debug --force

      - name: Install cargo-pgrx
        run: |
          cargo install -j $(nproc) --locked cargo-pgrx --version ${{ steps.pgrx.outputs.version }} --debug
          cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"

          # Save the pgrx version for comparison later
          echo "FIRST_PGRX_VERSION=${PGRX_VERSION}" >> $GITHUB_ENV

      - name: Generate Schema from this git rev
        run: cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/this.sql

      - name: Switch to Base git rev and Generate Schema Again
        run: |
          # Switch to the base git rev
          git checkout .
          git checkout ${{ github.event.pull_request.base.ref }}

          # See if we need a different cargo-pgrx and install it if so
          THIS_PGRX_VERSION=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ "${THIS_PGRX_VERSION}" != "${FIRST_PGRX_VERSION}" ]]; then
            # Install cargo-pgrx
            cargo install -j $(nproc) --locked cargo-pgrx --version ${THIS_PGRX_VERSION} --force --debug

            # Initialize it (again) -- probably unnecessary, but might as well in case ~/.pgrx/config.toml ever changes
            cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"
          fi

          # Generate schema
          cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/old.sql

      - name: Generate Schema Diffs
        run: |
          # Show schema sizes for diagnostics
          echo "Schema file sizes:"
          echo "  Old schema: $(wc -l < ~/old.sql) lines, $(wc -c < ~/old.sql) bytes"
          echo "  New schema: $(wc -l < ~/this.sql) lines, $(wc -c < ~/this.sql) bytes"
          echo

          # Run pg-schema-diff with increased stack size to handle large schemas
          set +e  # Temporarily disable exit on error
          RUST_MIN_STACK=8388608 pg-schema-diff diff ~/old.sql ~/this.sql 2>&1 | grep -v "^$" > ~/diff.sql
          PG_SCHEMA_DIFF_EXIT=$?
          set -e  # Re-enable exit on error

          # Check if pg-schema-diff crashed or had an error
          if [ $PG_SCHEMA_DIFF_EXIT -ne 0 ]; then
            echo "⚠️  WARNING: pg-schema-diff failed with exit code $PG_SCHEMA_DIFF_EXIT"
            echo "Output:"
            cat ~/diff.sql
            echo
            echo "Falling back to traditional diff..."

            # Use traditional diff as fallback
            if diff ~/old.sql ~/this.sql > /dev/null 2>&1; then
              echo "✅ No schema differences detected (via diff)"
              > ~/diff.sql  # Empty the diff file
            else
              echo "⚠️  Schema differences detected via traditional diff"
              echo "Please manually review the changes in the full diff output below"
              # Create a simple marker file to indicate changes were detected
              echo "-- Schema changes detected. Please review the full diff below." > ~/diff.sql
            fi
          fi

          # Generate a traditional diff for informational purposes (exit code doesn't matter)
          (diff ~/old.sql ~/this.sql > ~/diff.patch) || true

          # Show the schema diff
          if [ -s ~/diff.sql ]; then
            echo "Schema diff:"
            cat ~/diff.sql
          else
            echo "✅ No schema differences detected"
          fi

      - name: Check Schema Diff and Validate Migration
        id: check_schema_diff
        run: |
          if test -s ~/diff.sql; then
            echo "=========================================="
            echo "SCHEMA DIFFERENCE DETECTED"
            echo "=========================================="
            echo

            # Check if this is a fallback diff (pg-schema-diff failed)
            if grep -q "^-- Schema changes detected" ~/diff.sql; then
              echo "⚠️  Note: pg-schema-diff tool failed, using traditional diff for comparison"
              echo
              echo "--- BEGIN FULL SCHEMA DIFF ---"
              cat ~/diff.patch
              echo "--- END FULL SCHEMA DIFF ---"
              echo
              echo "❌ ERROR: Schema difference detected, but unable to generate upgrade script."
              echo
              echo "Please manually review the diff above and update the migration file accordingly."
              echo "This may indicate that the schemas are too complex for pg-schema-diff to analyze."
              echo
              echo "Consider:"
              echo "  1. Reviewing the diff output above"
              echo "  2. Manually creating the necessary migration SQL"
              echo "  3. Ensuring the migration file contains all schema changes"
              exit 1
            fi

            echo "A suggested upgrade.sql script follows. Please review it carefully as SchemaBot is not infallible."
            echo
            echo "--- BEGIN SUGGESTED UPGRADE SCRIPT ---"
            cat ~/diff.sql
            echo "--- END SUGGESTED UPGRADE SCRIPT ---"
            echo
            echo "=========================================="
            echo "FULL SCHEMA DIFF"
            echo "=========================================="
            cat ~/diff.patch
            echo
            echo "=========================================="

            # Find the most recent migration file for pg_search
            MIGRATION_FILE=$(ls -t pg_search/sql/pg_search--*.sql 2>/dev/null | head -n 1)

            if [ -z "$MIGRATION_FILE" ]; then
              echo "❌ ERROR: Schema changed but no migration file found in pg_search/sql/"
              echo "Please create a migration file (e.g., pg_search--X.Y.Z--X.Y.Z+1.sql) with the schema changes."
              exit 1
            fi

            echo "Found migration file: $MIGRATION_FILE"
            echo
            echo "Checking if migration file contains the necessary schema changes..."

            # Check if migration file appears to contain the relevant changes
            # We look for key identifiers from the diff in the migration file
            DIFF_FUNCTIONS=$(grep -oP "(?<=FUNCTION )[\w.\"]+\.[\w\"]+(?=\()" ~/diff.sql | sort -u || true)
            MIGRATION_MISSING=""

            if [ -n "$DIFF_FUNCTIONS" ]; then
              echo "Functions affected by schema change:"
              echo "$DIFF_FUNCTIONS"
              echo

              # Check if each function appears in the migration file
              while IFS= read -r func; do
                # Remove quotes and extract just the function name
                func_name=$(echo "$func" | sed 's/"//g' | awk -F. '{print $NF}')
                if ! grep -qi "$func_name" "$MIGRATION_FILE"; then
                  MIGRATION_MISSING="${MIGRATION_MISSING}  - $func\n"
                fi
              done <<< "$DIFF_FUNCTIONS"
            fi

            if [ -n "$MIGRATION_MISSING" ]; then
              echo "❌ ERROR: Migration file is missing changes for the following functions:"
              echo -e "$MIGRATION_MISSING"
              echo
              echo "The migration file at $MIGRATION_FILE needs to be updated."
              echo "Please add the suggested upgrade script shown above to your migration file."
              exit 1
            else
              echo "✅ Migration file appears to contain the necessary schema changes"
              echo
              echo "⚠️  Please manually verify that the migration file:"
              echo "   $MIGRATION_FILE"
              echo "   correctly implements all changes shown in the suggested upgrade script."
            fi
          else
            echo "✅ No schema difference detected"
            echo "schema_diff_detected=false" >> $GITHUB_OUTPUT
          fi
