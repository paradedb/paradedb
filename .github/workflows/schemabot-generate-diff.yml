# workflows/schemabot-generate-diff.yml
#
# SchemaBot Generate Diff
# Determine if a commit introduces an extension schema change for pg_search and enforce upgrade script updates.

name: SchemaBot Generate Diff

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/schemabot-generate-diff.yml"
      - "pg_search/**"
      - "!pg_search/README.md"
  workflow_dispatch:

# Required to post a comment to the PR
permissions:
  pull-requests: write
  issues: write

concurrency:
  group: schemabot-generate-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  schemabot-generate-diff:
    name: SchemaBot
    # TODO: See https://github.com/paradedb/paradedb/issues/3613
    runs-on: ubicloud-standard-8-ubuntu-2204
    defaults:
      run:
        shell: bash -eo pipefail {0}
    strategy:
      matrix:
        pg_version: [14] # pg_search's minimum supported Postgres version

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch the entire history
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Extract pgrx Version
        id: pgrx
        working-directory: pg_search/
        run: |
          version=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache"
          shared-key: pg${{ matrix.pg_version }}-${{ hashFiles('**/Cargo.lock') }}
          cache-targets: true
          cache-all-crates: true

      - name: Install & Configure Supported PostgreSQL Version
        run: |
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update && sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
          echo "/usr/lib/postgresql/${{ matrix.pg_version }}/bin" >> $GITHUB_PATH

      - name: Install pg-schema-diff and its Required Dependencies
        run: |
          sudo apt install -y clang llvm diffutils
          cargo install --git https://github.com/zombodb/pg-schema-diff.git --debug --force

      - name: Install cargo-pgrx
        run: |
          cargo install -j $(nproc) --locked cargo-pgrx --version ${{ steps.pgrx.outputs.version }} --debug
          cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"

          # Save the pgrx version for comparison later
          echo "FIRST_PGRX_VERSION=${PGRX_VERSION}" >> $GITHUB_ENV

      - name: Generate Schema from this git rev
        run: cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/this.sql

      - name: Switch to Base git rev and Generate Schema Again
        run: |
          # Switch to the base git rev
          git checkout .
          git checkout ${{ github.event.pull_request.base.ref }}

          # See if we need a different cargo-pgrx and install it if so
          THIS_PGRX_VERSION=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ "${THIS_PGRX_VERSION}" != "${FIRST_PGRX_VERSION}" ]]; then
            # Install cargo-pgrx
            cargo install -j $(nproc) --locked cargo-pgrx --version ${THIS_PGRX_VERSION} --force --debug

            # Initialize it (again) -- probably unnecessary, but might as well in case ~/.pgrx/config.toml ever changes
            cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"
          fi

          # Generate schema
          cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/old.sql

      - name: Generate Schema Diffs
        id: generate_schema_diffs
        run: |
          # Run pg-schema-diff and capture both stdout and stderr in diff.sql,
          # ignoring empty lines. Don't fail the step yet on non-zero exit.
          (pg-schema-diff diff ~/old.sql ~/this.sql | grep -v "^$" > ~/diff.sql 2>&1) || true

          # Generate a traditional patch diff for informational purposes.
          (diff ~/old.sql ~/this.sql > ~/diff.patch) || true

          # Fail hard on stack overflow / fatal runtime errors.
          if grep -qiE "stack overflow|fatal runtime error" ~/diff.sql; then
            echo "::error::pg-schema-diff failed with a stack overflow; failing the job."
            exit 1
          fi

          if test -s ~/diff.sql; then
            echo "schema_diff_detected=true" >> $GITHUB_OUTPUT
          else
            echo "schema_diff_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Ensure Schema Diff Is Reflected in SQL Upgrade Script
        if: steps.generate_schema_diffs.outputs.schema_diff_detected == 'true'
        working-directory: pg_search
        run: |
          echo "SchemaBot: A schema difference was detected for pg_search."
          echo
          echo "Suggested upgrade statements generated by pg-schema-diff:"
          echo "=================================================================="
          cat ~/diff.sql
          echo "=================================================================="

          # Extract current pg_search version from Cargo.toml
          EXT_VERSION=$(grep -m1 '^version' Cargo.toml | sed -E 's/version\s*=\s*"(.*)"/\1/')
          echo "Detected pg_search version from Cargo.toml: ${EXT_VERSION}"

          # Find SQL upgrade script(s) for this version.
          # Common pgrx patterns:
          #   pg_search--PREVIOUS_VERSION--CURRENT_VERSION.sql (upgrade)
          #   pg_search--CURRENT_VERSION.sql (base)
          SQL_FILES=$(find sql -maxdepth 1 -type f \( -name "pg_search--*--${EXT_VERSION}.sql" -o -name "pg_search--${EXT_VERSION}.sql" \) || true)

          if [ -z "${SQL_FILES}" ]; then
            echo "::error::No SQL upgrade script found for pg_search version ${EXT_VERSION} under pg_search/sql."
            echo "Expected a file like pg_search/sql/pg_search--PREVIOUS_VERSION--${EXT_VERSION}.sql"
            echo
            echo "Please add/modify an upgrade script that contains at least the following statements:"
            cat ~/diff.sql
            exit 1
          fi

          echo "Found candidate SQL script(s) for version ${EXT_VERSION}:"
          echo "${SQL_FILES}"
          echo

          # Check if all lines from diff.sql appear in at least one target SQL file.
          # This is a conservative check: each line from diff.sql must be present somewhere
          # in the SQL file (order not enforced, but good enough to catch missing statements).
          missing=1
          while IFS= read -r sql_file; do
            [ -z "$sql_file" ] && continue

            echo "Checking whether schema diff is present in ${sql_file}..."

            # For each line in diff.sql, ensure it appears (as fixed string) in the SQL file.
            line_missing=0
            while IFS= read -r diff_line; do
              # Skip blank lines.
              if [ -z "${diff_line// }" ]; then
                continue
              fi

              if ! grep -Fq -- "$diff_line" "$sql_file"; then
                line_missing=1
                break
              fi
            done < ~/diff.sql

            if [ "$line_missing" -eq 0 ]; then
              echo "âœ… Schema diff appears to be fully present in ${sql_file}."
              missing=0
              break
            else
              echo "Schema diff is not fully present in ${sql_file}."
            fi
          done <<< "${SQL_FILES}"

          if [ "$missing" -ne 0 ]; then
            echo "::error::The generated schema diff is not present in any SQL script for version ${EXT_VERSION}."
            echo
            echo "Please update the appropriate file under pg_search/sql (e.g. pg_search--PREVIOUS_VERSION--${EXT_VERSION}.sql)"
            echo "to include the following statements:"
            echo "------------------------------------------------------------------"
            cat ~/diff.sql
            echo "------------------------------------------------------------------"
            exit 1
          fi

          echo "Schema diff already present in SQL upgrade script; nothing else to do."
