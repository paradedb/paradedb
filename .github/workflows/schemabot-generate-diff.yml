# workflows/schemabot-generate-diff.yml
#
# SchemaBot Generate Diff
# Determine if a commit introduces an extension schema change for pg_search and post a comment to the PR.

name: SchemaBot Generate Diff

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/schemabot-generate-diff.yml"
      - ".github/workflows/reusable-pgrx-schema.yml"
      - ".github/scripts/check_migration_diff.py"
      - "pg_search/**"
      - "!pg_search/README.md"
  workflow_dispatch:

concurrency:
  group: schemabot-generate-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Generate schema from PR head (runs in parallel with base)
  schema-head:
    name: Schema (PR)
    uses: ./.github/workflows/reusable-pgrx-schema.yml
    with:
      git_ref: ${{ github.event.pull_request.head.ref || github.ref }}
      pg_version: "14"
      artifact_name: schema-head

  # Generate schema from base branch (runs in parallel with head)
  schema-base:
    name: Schema (Base)
    uses: ./.github/workflows/reusable-pgrx-schema.yml
    with:
      git_ref: ${{ github.event.pull_request.base.ref }}
      pg_version: "14"
      artifact_name: schema-base

  # Compare schemas and validate migration
  compare:
    name: Compare & Validate
    needs: [schema-head, schema-base]
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -eo pipefail {0}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Download head schema
        uses: actions/download-artifact@v4
        with:
          name: schema-head
          path: ~/head

      - name: Download base schema
        uses: actions/download-artifact@v4
        with:
          name: schema-base
          path: ~/base

      - name: Cache pg-schema-diff
        id: cache-diff-tool
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/pg-schema-diff
          key: pg-schema-diff-v1

      - name: Install Rust (for pg-schema-diff)
        if: steps.cache-diff-tool.outputs.cache-hit != 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install pg-schema-diff
        if: steps.cache-diff-tool.outputs.cache-hit != 'true'
        run: cargo install --git https://github.com/paradedb/pg-schema-diff.git --debug

      - name: Generate Schema Diff
        run: |
          set +e
          ~/.cargo/bin/pg-schema-diff diff ~/base/schema.sql ~/head/schema.sql > ~/diff.sql 2>&1
          PG_SCHEMA_DIFF_EXIT=$?
          set -e

          if [ $PG_SCHEMA_DIFF_EXIT -ne 0 ]; then
            echo "❌ ERROR: pg-schema-diff failed with exit code $PG_SCHEMA_DIFF_EXIT"
            echo "Output:"
            cat ~/diff.sql
            exit 1
          fi

          echo "Schema diff generated successfully:"
          cat ~/diff.sql

          # Remove trailing newlines for comparison
          perl -i -pe 'chomp if eof' ~/diff.sql

      - name: Validate Migration
        run: |
          if test -s ~/diff.sql; then
            echo "=========================================="
            echo "SCHEMA DIFFERENCE DETECTED"
            echo "=========================================="
            echo
            echo "A suggested upgrade.sql script follows. Please review it carefully as SchemaBot is not infallible."
            echo
            echo "--- BEGIN SUGGESTED UPGRADE SCRIPT ---"
            cat ~/diff.sql
            echo "--- END SUGGESTED UPGRADE SCRIPT ---"
            echo
            echo "=========================================="

            # Extract the version from Cargo.toml
            CURRENT_VERSION=$(grep -m 1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
            echo "Current version from Cargo.toml: $CURRENT_VERSION"

            # Find the migration file ending with the current version
            MIGRATION_FILE=$(ls pg_search/sql/pg_search--*--${CURRENT_VERSION}.sql 2>/dev/null | head -n 1)

            if [ -z "$MIGRATION_FILE" ]; then
              echo "❌ ERROR: Schema changed but no migration file found ending with version $CURRENT_VERSION"
              echo "Expected file: pg_search/sql/pg_search--<prev_version>--${CURRENT_VERSION}.sql"
              echo "Please create a migration file with the schema changes."
              exit 1
            fi

            echo "Found migration file: $MIGRATION_FILE"
            echo
            echo "Checking if migration file contains all schema changes (order-independent)..."

            # Compare schema changes independent of order, since pg-schema-diff output order is non-deterministic
            if ! python3 .github/scripts/check_migration_diff.py ~/diff.sql "$MIGRATION_FILE" --debug; then
              echo
              echo "The migration file at $MIGRATION_FILE needs to be updated."
              echo "Please ensure all the schema changes shown above are in your migration file."
              echo
              echo "ℹ️  NOTE: If you need to modify the SchemaBot-generated diff because it's incorrect,"
              echo "   please update the schema diff generation logic at:"
              echo "   https://github.com/paradedb/pg-schema-diff"
              exit 1
            fi
          else
            echo "✅ No schema difference detected"
          fi
