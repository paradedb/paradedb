# workflows/schemabot-generate-diff.yml
#
# SchemaBot Generate Diff
# Determine if a commit introduces an extension schema change for pg_search and post a comment to the PR.

name: SchemaBot Generate Diff

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/schemabot-generate-diff.yml"
      - "pg_search/**"
      - "!pg_search/README.md"
  workflow_dispatch:

concurrency:
  group: schemabot-generate-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  schemabot-generate-diff:
    name: SchemaBot
    # TODO: See https://github.com/paradedb/paradedb/issues/3613
    runs-on: ubicloud-standard-8-ubuntu-2204
    defaults:
      run:
        shell: bash -eo pipefail {0}
    strategy:
      matrix:
        pg_version: [14] # pg_search's minimum supported Postgres version

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch the entire history

      - name: Extract pgrx Version
        id: pgrx
        working-directory: pg_search/
        run: |
          version=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache"
          shared-key: pg${{ matrix.pg_version }}-${{ hashFiles('**/Cargo.lock') }}
          cache-targets: true
          cache-all-crates: true

      - name: Install & Configure Supported PostgreSQL Version
        run: |
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update && sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
          echo "/usr/lib/postgresql/${{ matrix.pg_version }}/bin" >> $GITHUB_PATH

      - name: Install pg-schema-diff and its Required Dependencies
        run: |
          sudo apt install clang llvm diffutils
          cargo install --git https://github.com/paradedb/pg-schema-diff.git --debug --force

      - name: Install cargo-pgrx
        run: |
          cargo install -j $(nproc) --locked cargo-pgrx --version ${{ steps.pgrx.outputs.version }} --debug
          cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"

          # Save the pgrx version for comparison later
          echo "FIRST_PGRX_VERSION=${PGRX_VERSION}" >> $GITHUB_ENV

      - name: Generate Schema from this git rev
        run: cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/this.sql

      - name: Switch to Base git rev and Generate Schema Again
        run: |
          # Switch to the base git rev
          git checkout .
          git checkout ${{ github.event.pull_request.base.ref }}

          # See if we need a different cargo-pgrx and install it if so
          THIS_PGRX_VERSION=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ "${THIS_PGRX_VERSION}" != "${FIRST_PGRX_VERSION}" ]]; then
            # Install cargo-pgrx
            cargo install -j $(nproc) --locked cargo-pgrx --version ${THIS_PGRX_VERSION} --force --debug

            # Initialize it (again) -- probably unnecessary, but might as well in case ~/.pgrx/config.toml ever changes
            cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"
          fi

          # Generate schema
          cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/old.sql

      - name: Generate Schema Diffs
        run: |
          # Run pg-schema-diff and capture its exit code
          # Note: Only capture stdout (the actual diff), stderr goes to terminal for debugging
          set +e  # Temporarily disable exit on error
          pg-schema-diff diff ~/old.sql ~/this.sql > ~/diff.sql 2>&1
          PG_SCHEMA_DIFF_EXIT=$?
          set -e  # Re-enable exit on error

          # Check if pg-schema-diff crashed or had an error
          if [ $PG_SCHEMA_DIFF_EXIT -ne 0 ]; then
            echo "❌ ERROR: pg-schema-diff failed with exit code $PG_SCHEMA_DIFF_EXIT"
            echo "Output:"
            cat ~/diff.sql
            exit 1
          fi

          # Show the schema diff
          echo "Schema diff generated successfully:"
          cat ~/diff.sql

          # Remove trailing newlines from diff for comparison
          perl -i -pe 'chomp if eof' ~/diff.sql

      - name: Check Schema Diff and Validate Migration
        id: check_schema_diff
        run: |
          if test -s ~/diff.sql; then
            echo "=========================================="
            echo "SCHEMA DIFFERENCE DETECTED"
            echo "=========================================="
            echo
            echo "A suggested upgrade.sql script follows. Please review it carefully as SchemaBot is not infallible."
            echo
            echo "--- BEGIN SUGGESTED UPGRADE SCRIPT ---"
            cat ~/diff.sql
            echo "--- END SUGGESTED UPGRADE SCRIPT ---"
            echo
            echo "=========================================="

            # Extract the version from Cargo.toml
            CURRENT_VERSION=$(grep -m 1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
            echo "Current version from Cargo.toml: $CURRENT_VERSION"

            # Find the migration file ending with the current version
            MIGRATION_FILE=$(ls pg_search/sql/pg_search--*--${CURRENT_VERSION}.sql 2>/dev/null | head -n 1)

            if [ -z "$MIGRATION_FILE" ]; then
              echo "❌ ERROR: Schema changed but no migration file found ending with version $CURRENT_VERSION"
              echo "Expected file: pg_search/sql/pg_search--<prev_version>--${CURRENT_VERSION}.sql"
              echo "Please create a migration file with the schema changes."
              exit 1
            fi

            echo "Found migration file: $MIGRATION_FILE"
            echo "Current branch: $(git rev-parse --abbrev-ref HEAD)"
            echo "Current commit: $(git rev-parse HEAD)"
            echo "File last modified in commit: $(git log -1 --format='%H %s' -- "$MIGRATION_FILE")"
            echo
            echo "Checking if migration file contains the exact schema diff as a contiguous block..."

            # Debug: Show what we're comparing
            echo
            echo "=== DEBUG: diff.sql (with line numbers) ==="
            nl -ba ~/diff.sql
            echo
            echo "=== DEBUG: migration file (with line numbers) ==="
            nl -ba "$MIGRATION_FILE"
            echo "=== END DEBUG ==="
            echo

            # Use awk to check if the diff exists as a contiguous block in the migration file
            # This is more reliable than grep -Fzo for multi-line patterns
            if awk '
              BEGIN {
                diff_file = ARGV[1]
                migration_file = ARGV[2]

                # Read the diff into an array
                diff_lines = 0
                while ((getline line < diff_file) > 0) {
                  diff[++diff_lines] = line
                }
                close(diff_file)

                # Search for the diff as a contiguous block in the migration file
                found = 0
                match_pos = 0
                while ((getline line < migration_file) > 0) {
                  if (match_pos > 0) {
                    # We are in the middle of matching
                    if (line == diff[match_pos]) {
                      match_pos++
                      if (match_pos > diff_lines) {
                        found = 1
                        break
                      }
                    } else {
                      match_pos = 0
                    }
                  }
                  # Check if this line starts a new match
                  if (match_pos == 0 && line == diff[1]) {
                    match_pos = 2
                    if (diff_lines == 1) {
                      found = 1
                      break
                    }
                  }
                }
                close(migration_file)

                exit !found
              }
            ' ~/diff.sql "$MIGRATION_FILE"; then
              echo "✅ Migration file contains the exact schema diff in the correct sequence"
            else
              echo "❌ ERROR: Migration file does not contain the exact schema diff as a contiguous block."
              echo
              echo "The migration file at $MIGRATION_FILE needs to be updated."
              echo "Please copy the entire suggested upgrade script shown above into your migration file as-is."
              echo
              echo "ℹ️  NOTE: If you need to modify the SchemaBot-generated diff because it's incorrect,"
              echo "   please update the schema diff generation logic at:"
              echo "   https://github.com/paradedb/pg-schema-diff"
              echo "   Do not manually modify the diff in the migration file, as CI will fail."
              exit 1
            fi
          else
            echo "✅ No schema difference detected"
            echo "schema_diff_detected=false" >> $GITHUB_OUTPUT
          fi
