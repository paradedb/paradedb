# workflows/schemabot-generate-diff.yml
#
# SchemaBot Generate Diff
# Determine if a commit introduces an extension schema change for pg_search and post a comment to the PR.

name: SchemaBot Generate Diff

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/schemabot-generate-diff.yml"
      - "pg_search/**"
      - "!pg_search/README.md"
  workflow_dispatch:

# Required to post a comment to the PR
permissions:
  pull-requests: write
  issues: write

concurrency:
  group: schemabot-generate-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  schemabot-generate-diff:
    name: SchemaBot
    # TODO: See https://github.com/paradedb/paradedb/issues/3613
    runs-on: ubicloud-standard-8-ubuntu-2204
    defaults:
      run:
        shell: bash -eo pipefail {0}
    strategy:
      matrix:
        pg_version: [14] # pg_search's minimum supported Postgres version

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch the entire history
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Extract pgrx Version
        id: pgrx
        working-directory: pg_search/
        run: |
          version=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache"
          shared-key: pg${{ matrix.pg_version }}-${{ hashFiles('**/Cargo.lock') }}
          cache-targets: true
          cache-all-crates: true

      - name: Install & Configure Supported PostgreSQL Version
        run: |
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update && sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
          echo "/usr/lib/postgresql/${{ matrix.pg_version }}/bin" >> $GITHUB_PATH

      - name: Install pg-schema-diff and its Required Dependencies
        run: |
          sudo apt install clang llvm diffutils
          cargo install --git https://github.com/zombodb/pg-schema-diff.git --debug --force

      - name: Install cargo-pgrx
        run: |
          cargo install -j $(nproc) --locked cargo-pgrx --version ${{ steps.pgrx.outputs.version }} --debug
          cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"

          # Save the pgrx version for comparison later
          echo "FIRST_PGRX_VERSION=${PGRX_VERSION}" >> $GITHUB_ENV

      - name: Generate Schema from this git rev
        run: cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/this.sql

      - name: Switch to Base git rev and Generate Schema Again
        run: |
          # Switch to the base git rev
          git checkout .
          git checkout ${{ github.event.pull_request.base.ref }}

          # See if we need a different cargo-pgrx and install it if so
          THIS_PGRX_VERSION=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ "${THIS_PGRX_VERSION}" != "${FIRST_PGRX_VERSION}" ]]; then
            # Install cargo-pgrx
            cargo install -j $(nproc) --locked cargo-pgrx --version ${THIS_PGRX_VERSION} --force --debug

            # Initialize it (again) -- probably unnecessary, but might as well in case ~/.pgrx/config.toml ever changes
            cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"
          fi

          # Generate schema
          cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/old.sql

      - name: Generate Schema Diffs
        run: |
          (pg-schema-diff diff ~/old.sql ~/this.sql | grep -v "^$" > ~/diff.sql 2>&1) || true
          (diff ~/old.sql ~/this.sql > ~/diff.patch) || true
          cat ~/diff.sql

      - name: Generate Commit Message
        id: generate_commit_message
        run: |
          if test -s ~/diff.sql; then
            echo "Generating GitHub comment message"

            # GitHub has a 65,536 character limit for comments
            MAX_COMMENT_SIZE=60000

            # Generate the full message first
            {
              echo 'A schema difference was detected.'
              echo
              echo 'A suggested "upgrade.sql" script follows.  Please review it carefully as SchemaBot is not infallible.'
              echo
              echo '```sql'
              cat ~/diff.sql
              echo '```'

              #
              # Include the full schema diff, for informational purposes
              #

              echo
              echo '<details>'
              echo '<summary>The full diff between both schemas is:</summary>'
              echo
              echo '```diff'
              cat ~/diff.patch
              echo '```'
              echo '</details>'
            } > commit-message-full.md

            # Check if the message exceeds the limit
            MESSAGE_SIZE=$(wc -c < commit-message-full.md)
            if [ "$MESSAGE_SIZE" -gt "$MAX_COMMENT_SIZE" ]; then
              echo "Message size ($MESSAGE_SIZE) exceeds limit ($MAX_COMMENT_SIZE), truncating..."
              # Create a truncated version with just the upgrade script
              {
                echo 'A schema difference was detected.'
                echo
                echo '> **Note:** The full diff is too large to display in this comment. Download the artifacts below for the complete diff.'
                echo
                echo 'A suggested "upgrade.sql" script follows.  Please review it carefully as SchemaBot is not infallible.'
                echo
                echo '```sql'
                cat ~/diff.sql
                echo '```'
              } > commit-message.md

              # Check if even this is too large (unlikely but possible)
              TRUNCATED_SIZE=$(wc -c < commit-message.md)
              if [ "$TRUNCATED_SIZE" -gt "$MAX_COMMENT_SIZE" ]; then
                echo "Even truncated message is too large, truncating upgrade script..."
                {
                  echo 'A schema difference was detected.'
                  echo
                  echo '> **Note:** The schema diff is too large to display in this comment. Download the artifacts below for the complete diff and upgrade script.'
                  echo
                  echo 'The upgrade script and full diff have been uploaded as artifacts.'
                } > commit-message.md
              fi
            else
              mv commit-message-full.md commit-message.md
            fi

            # Set a flag to indicate a schema difference was detected
            echo "schema_diff_detected=true" >> $GITHUB_OUTPUT
          else
            echo "No schema difference detected"
            echo "schema_diff_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Schema Diff Artifacts
        uses: actions/upload-artifact@v4
        if: steps.generate_commit_message.outputs.schema_diff_detected == 'true'
        with:
          name: schema-diff-pg${{ matrix.pg_version }}
          path: |
            ~/diff.sql
            ~/diff.patch
          retention-days: 30

      - name: Attach Schema Diff to PR
        uses: actions/github-script@v8
        if: steps.generate_commit_message.outputs.schema_diff_detected == 'true'
        with:
          script: |
            const fs = require('fs');
            const commit_message = fs.readFileSync('commit-message.md', 'utf8');

            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('A schema difference was detected.')
            );

            const body = `${commit_message}`;

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }
