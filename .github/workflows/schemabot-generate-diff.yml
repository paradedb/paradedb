# workflows/schemabot-generate-diff.yml
#
# SchemaBot Generate Diff
# Determine if a commit introduces an extension schema change for pg_search.
#
# This workflow:
# 1. Generates SQL schemas from both base and PR branches using pgrx
# 2. Loads schemas into temporary PostgreSQL databases
# 3. Uses Stripe's pg-schema-diff to analyze database differences semantically
# 4. Generates a migration plan with the SQL needed to migrate from old to new schema
# 5. Validates that migration files contain necessary changes for modified functions
# 6. Uploads schema artifacts and migration plan for manual review
#
# Note: pg-schema-diff compares database structures semantically, so statement ordering
# in the SQL files doesn't matter. It understands PostgreSQL schemas, not just text diffs.

name: SchemaBot Generate Diff

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/schemabot-generate-diff.yml"
      - "pg_search/**"
      - "!pg_search/README.md"
  workflow_dispatch:

# Required to post a comment to the PR
permissions:
  pull-requests: write
  issues: write

concurrency:
  group: schemabot-generate-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  schemabot-generate-diff:
    name: SchemaBot
    # TODO: See https://github.com/paradedb/paradedb/issues/3613
    runs-on: ubicloud-standard-8-ubuntu-2204
    defaults:
      run:
        shell: bash -eo pipefail {0}
    strategy:
      matrix:
        pg_version: [14] # pg_search's minimum supported Postgres version

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch the entire history
          token: ${{ secrets.PARADEDB_BOT_GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Extract pgrx Version
        id: pgrx
        working-directory: pg_search/
        run: |
          version=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache"
          shared-key: pg${{ matrix.pg_version }}-${{ hashFiles('**/Cargo.lock') }}
          cache-targets: true
          cache-all-crates: true

      - name: Install & Configure Supported PostgreSQL Version
        run: |
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update && sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
          echo "/usr/lib/postgresql/${{ matrix.pg_version }}/bin" >> $GITHUB_PATH

          # Start PostgreSQL for schema comparison
          sudo systemctl start postgresql
          sudo -u postgres psql -c "CREATE USER runner SUPERUSER;"
          sudo -u postgres psql -c "CREATE DATABASE old_schema;"
          sudo -u postgres psql -c "CREATE DATABASE new_schema;"

      - name: Install Stripe's pg-schema-diff
        run: |
          # Download and install Stripe's Go-based pg-schema-diff
          # Using specific version to ensure stability
          VERSION="v0.9.0"
          wget -q "https://github.com/stripe/pg-schema-diff/releases/download/${VERSION}/pg-schema-diff_linux_amd64.tar.gz"
          tar -xzf pg-schema-diff_linux_amd64.tar.gz
          sudo mv pg-schema-diff /usr/local/bin/
          sudo chmod +x /usr/local/bin/pg-schema-diff
          echo "Installed pg-schema-diff:"
          pg-schema-diff --version

      - name: Install cargo-pgrx
        run: |
          cargo install -j $(nproc) --locked cargo-pgrx --version ${{ steps.pgrx.outputs.version }} --debug
          cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"

          # Save the pgrx version for comparison later
          echo "FIRST_PGRX_VERSION=${PGRX_VERSION}" >> $GITHUB_ENV

      - name: Generate Schema from this git rev
        run: cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/this.sql

      - name: Switch to Base git rev and Generate Schema Again
        run: |
          # Switch to the base git rev
          git checkout .
          git checkout ${{ github.event.pull_request.base.ref }}

          # See if we need a different cargo-pgrx and install it if so
          THIS_PGRX_VERSION=$(cargo tree --depth 1 -i pgrx -p pg_search | head -n 1 | sed -E 's/.*v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ "${THIS_PGRX_VERSION}" != "${FIRST_PGRX_VERSION}" ]]; then
            # Install cargo-pgrx
            cargo install -j $(nproc) --locked cargo-pgrx --version ${THIS_PGRX_VERSION} --force --debug

            # Initialize it (again) -- probably unnecessary, but might as well in case ~/.pgrx/config.toml ever changes
            cargo pgrx init "--pg${{ matrix.pg_version }}=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config"
          fi

          # Generate schema
          cargo pgrx schema -p pg_search pg${{ matrix.pg_version }} > ~/old.sql

      - name: Load Schemas into PostgreSQL Databases
        run: |
          echo "Loading schemas into temporary PostgreSQL databases..."

          # Load old schema
          psql -U runner -d old_schema -f ~/old.sql
          echo "‚úÖ Loaded old schema ($(wc -l < ~/old.sql) lines)"

          # Load new schema
          psql -U runner -d new_schema -f ~/this.sql
          echo "‚úÖ Loaded new schema ($(wc -l < ~/this.sql) lines)"

      - name: Generate Schema Diffs with pg-schema-diff
        run: |
          echo "Comparing schemas using Stripe's pg-schema-diff..."
          echo "Note: This step will fail the entire job if pg-schema-diff encounters an error."
          echo

          # Run pg-schema-diff to generate migration plan
          # No error handling - let it fail the job if there are issues
          pg-schema-diff plan \
            --dsn "postgresql://runner@localhost/old_schema?sslmode=disable" \
            --new-dsn "postgresql://runner@localhost/new_schema?sslmode=disable" \
            > ~/diff.sql

          echo
          echo "‚úÖ pg-schema-diff completed successfully"

          # Also generate a traditional unified diff for reference
          diff -u ~/old.sql ~/this.sql > ~/diff.patch 2>&1 || true

          # Show the migration plan summary
          if [ -s ~/diff.sql ]; then
            DIFF_LINES=$(wc -l < ~/diff.sql)
            echo
            echo "Migration plan generated: $DIFF_LINES lines"
            echo
            echo "--- BEGIN MIGRATION PLAN (first 50 lines) ---"
            head -50 ~/diff.sql
            if [ "$DIFF_LINES" -gt 50 ]; then
              echo
              echo "... (see artifacts for full migration plan)"
            fi
            echo "--- END MIGRATION PLAN ---"
          else
            echo
            echo "‚úÖ No schema differences detected - databases are identical"
          fi

      - name: Check Schema Diff and Validate Migration
        id: check_schema_diff
        run: |
          if test -s ~/diff.sql; then
            echo "=========================================="
            echo "SCHEMA DIFFERENCE DETECTED"
            echo "=========================================="
            echo

            TOTAL_LINES=$(wc -l < ~/diff.sql)
            echo "Migration plan: $TOTAL_LINES SQL statements"
            echo
            echo "--- BEGIN MIGRATION PLAN (first 100 lines) ---"
            head -100 ~/diff.sql
            if [ "$TOTAL_LINES" -gt 100 ]; then
              echo
              echo "... ($TOTAL_LINES total lines, see artifacts for full plan)"
            fi
            echo "--- END MIGRATION PLAN ---"
            echo
            echo "See artifacts for complete migration plan and schema files."
            echo

            # Find the most recent migration file for pg_search
            MIGRATION_FILE=$(ls -t pg_search/sql/pg_search--*.sql 2>/dev/null | head -n 1)

            if [ -z "$MIGRATION_FILE" ]; then
              echo "‚ùå ERROR: Schema changed but no migration file found in pg_search/sql/"
              echo "Please create a migration file (e.g., pg_search--X.Y.Z--X.Y.Z+1.sql) with the schema changes."
              exit 1
            fi

            echo "Found migration file: $MIGRATION_FILE"
            echo
            echo "Checking if migration file contains the necessary schema changes..."

            # Extract functions from pg-schema-diff migration plan
            # pg-schema-diff outputs actual SQL statements (no diff markers)
            DIFF_FUNCTIONS=$(grep -E "^\s*(CREATE OR REPLACE|DROP)\s+FUNCTION" ~/diff.sql 2>/dev/null | \
              grep -oP '(?<=FUNCTION\s)[".\w]+(?=\()' | \
              sed 's/"//g' | \
              sort -u || true)

            # Count SQL statements in migration plan
            MEANINGFUL_CHANGES=$(grep -E "^\s*(CREATE|ALTER|DROP)" ~/diff.sql 2>/dev/null | wc -l || echo "0")

            echo
            echo "=========================================="
            echo "MIGRATION ANALYSIS"
            echo "=========================================="
            echo "SQL statements in migration plan: $MEANINGFUL_CHANGES"
            echo

            if [ "$MEANINGFUL_CHANGES" -eq 0 ]; then
              echo "‚úÖ No schema changes detected"
              echo "   pg-schema-diff found no differences between the databases"
              echo "   Migration file update not required."
              echo
              exit 0
            fi

            echo "üìù Migration required - please review the generated migration plan"
            echo

            if [ -n "$DIFF_FUNCTIONS" ]; then
              echo
              echo "Functions affected by schema change:"
              echo "$DIFF_FUNCTIONS"
              echo

              MIGRATION_MISSING=""
              FUNCTIONS_CHECKED=0
              # Check if each function appears in the migration file
              while IFS= read -r func; do
                [ -z "$func" ] && continue
                FUNCTIONS_CHECKED=$((FUNCTIONS_CHECKED + 1))
                # Remove quotes and extract just the function name
                func_clean=$(echo "$func" | sed 's/"//g')
                func_name=$(echo "$func_clean" | awk -F. '{print $NF}')

                # Check if function name appears in migration file (case insensitive)
                if ! grep -qi "$func_name" "$MIGRATION_FILE"; then
                  MIGRATION_MISSING="${MIGRATION_MISSING}  - $func_clean\n"
                fi
              done <<< "$DIFF_FUNCTIONS"

              echo "Checked $FUNCTIONS_CHECKED function(s) against migration file"

              if [ -n "$MIGRATION_MISSING" ]; then
                echo
                echo "‚ùå ERROR: Migration file is missing changes for the following functions:"
                echo -e "$MIGRATION_MISSING"
                echo
                echo "The migration file at $MIGRATION_FILE needs to be updated."
                echo "Please add the suggested upgrade script shown above to your migration file."
                exit 1
              fi
            fi

            echo "‚úÖ Migration file appears to contain references to the affected functions"
            echo
            echo "‚ö†Ô∏è  Please manually verify that the migration file:"
            echo "   $MIGRATION_FILE"
            echo "   correctly implements all changes shown in the migration plan."
            echo
            echo "üí° Review the migration plan in diff.sql artifact for exact SQL statements."
            echo
            echo "=========================================="
            echo "REFERENCE FILES"
            echo "=========================================="
            echo
            echo "üì¶ The following files are available as GitHub Actions artifacts:"
            echo "  ‚Ä¢ old_schema.sql - Base branch schema (as generated by pgrx)"
            echo "  ‚Ä¢ new_schema.sql - Current branch schema (as generated by pgrx)"
            echo "  ‚Ä¢ migration_plan.sql - SQL migration generated by pg-schema-diff"
            echo "  ‚Ä¢ unified_diff.patch - Traditional text diff (for reference)"
            echo
            echo "üí° TIP: migration_plan.sql contains ready-to-use SQL for the migration"
            echo "Download artifacts from the GitHub Actions run summary page."
          else
            echo "‚úÖ No schema difference detected"
            echo "schema_diff_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy Schema Files to Workspace for Artifacts
        if: always()
        run: |
          mkdir -p schema-artifacts
          cp ~/old.sql schema-artifacts/old_schema.sql || true
          cp ~/this.sql schema-artifacts/new_schema.sql || true
          cp ~/diff.sql schema-artifacts/migration_plan.sql || true
          cp ~/diff.patch schema-artifacts/unified_diff.patch || true
          ls -lh schema-artifacts/

      - name: Upload Schema Files as Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-files-pg${{ matrix.pg_version }}
          path: schema-artifacts/
          retention-days: 30
          if-no-files-found: warn
