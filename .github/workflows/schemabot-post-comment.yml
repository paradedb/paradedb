# workflows/schemabot-post-comment.yml
#
# SchemaBot Comment
# Post a comment to a PR if SchemaBot detected a schema difference. We split the SchemaBot
# CI workflow in two since external contributors cannot post PR comments from a workflow
# run triggered by their PR due to GitHub Actions permission restrictions.
#
# !! IMPORTANT !!
# Since this workflow runs can run on workflow_run triggers from external contributors' PRs,
# it MUST NOT run `actions/checkout` or otherwise have access to our codebase.

name: SchemaBot Post Comment

on:
  workflow_run:
    workflows: ["SchemaBot Generate Diff"]
    types: [completed]

permissions:
  actions: read
  contents: read
  pull-requests: write

concurrency:
  group: schemabot-post-comment-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  maybe-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    # Only when CI succeeded and the run came from a PR
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        (github.event.workflow_run.event == 'pull_request')
      }}

    steps:
      - name: Find Associated PR Number
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const prs = context.payload?.workflow_run?.pull_requests || [];
            if (!prs.length) core.setFailed('No associated PR found for this run.');
            core.setOutput('number', String(prs[0].number));
            core.info(`Found PR #${prs[0].number}`);

      - name: Locate SchemaBot Comment Artifact
        id: artifact
        uses: actions/github-script@v8
        with:
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const runId = context.payload.workflow_run.id;
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            const artifact = data.artifacts.find(a =>
              a.name === `schemabot-comment-${sha}` && !a.expired
            );
            core.setOutput('found', artifact ? 'true' : 'false');
            core.setOutput('artifact_id', artifact?.id ?? '');
            core.setOutput('run_id', runId);
            core.info(artifact
              ? `Found artifact ID ${artifact.id} for run ID ${runId} and SHA ${sha}`
              : `No artifact found for SHA ${sha}`
            );

      # Useful for debugging
      - name: List Available Artifacts
        uses: actions/github-script@v8
        with:
          script: |
            const runId = ${{ steps.artifact.outputs.run_id }};
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            core.info(`Artifacts on run ${runId}: ${data.artifacts.length}`);
            for (const a of data.artifacts) {
              core.info(`- ${a.name} (id=${a.id}, expired=${a.expired})`);
            }

      - name: Download Artifact by Name
        if: steps.artifact.outputs.found == 'true'
        uses: actions/download-artifact@v6
        with:
          name: schemabot-comment-${{ github.event.workflow_run.head_sha }}
          run-id: ${{ steps.artifact.outputs.run_id }}
          path: ./artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upsert PR Comment on Original PR
        if: steps.artifact.outputs.found == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const number = Number("${{ steps.pr.outputs.number }}");
            const body = fs.readFileSync('./artifact/commit-message.md', 'utf8'); // untrusted, but not interpolated
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: number
            });
            const marker = 'A schema difference was detected.';
            const existing = comments.find(c => c.user.type === 'Bot' && c.body?.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: number, body });
            }
