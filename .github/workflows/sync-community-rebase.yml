name: Community Rebase

on:
  schedule:
    - cron: "0 14-23 * * 1-5" # Mon-Fri, 2pm-11pm UTC (9am-6pm EST)
    - cron: "0 0-2 * * 2-6" # Tue-Sat, 12am-2am UTC (7pm-9pm EST)
  workflow_dispatch: # Allow manual triggering

# Prevent concurrent rebase operations
concurrency:
  group: community-rebase
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  community-rebase:
    name: Rebase Enterprise on Community
    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ secrets.PARADEDB_BOT_ENTERPRISE_SYNC_GITHUB_TOKEN }}

    permissions:
      contents: write
      issues: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PARADEDB_BOT_ENTERPRISE_SYNC_GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "paradedb-bot"
          git config --global user.email "developers@paradedb.com"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build enterprise-sync binary
        run: |
          echo "Building enterprise-sync tool..."
          cargo build --package enterprise-sync --release
          echo "âœ… Built enterprise-sync at: $(pwd)/target/release/enterprise-sync"

          # Verify the binary works
          ./target/release/enterprise-sync --help || echo "Binary built but help failed"

      - name: Install GitHub CLI
        run: |
          # GitHub CLI is pre-installed on ubuntu-latest, but ensure it's configured
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.PARADEDB_BOT_ENTERPRISE_SYNC_GITHUB_TOKEN }}

      - name: Run community rebase
        id: rebase
        env:
          GH_TOKEN: ${{ secrets.PARADEDB_BOT_ENTERPRISE_SYNC_GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.PARADEDB_BOT_ENTERPRISE_SYNC_GITHUB_TOKEN }}
          USERNAME_MAPPING_GITHUB_TO_SLACK: ${{ vars.USERNAME_MAPPING_GITHUB_TO_SLACK }}
        run: |
          set -euo pipefail
          echo "Starting community rebase process..."

          # Run the batch rebase script with debug mode - all output will appear in logs
          ./scripts/rebase-community-batch.sh --debug

          echo "âœ… Community rebase completed successfully"
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Notify Slack on failure and tag @ankit
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_GITHUB_CHANNEL_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            # Check if this is a conflict situation or actual failure
            if [ -f "/tmp/rebase-conflict-slack-payload.json" ]; then
              # Rust program generated the complete Slack payload
              JSON_DATA=$(cat /tmp/rebase-conflict-slack-payload.json)
            else
              # Actual failure - show original failure message
              JSON_DATA="{
                \"text\": \"ðŸš¨ Community Rebase Failed - <@ankit>\",
                \"attachments\": [
                  {
                    \"color\": \"danger\",
                    \"fields\": [
                      {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                      {\"title\": \"Workflow\", \"value\": \"${{ github.workflow }}\", \"short\": true},
                      {\"title\": \"View Logs\", \"value\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here>\", \"short\": true}
                    ]
                  }
                ]
              }"
            fi

            curl -X POST -H 'Content-type: application/json' \
              --data "$JSON_DATA" \
              "$SLACK_WEBHOOK_URL"
          else
            echo "Slack webhook not configured, skipping notification"
          fi
