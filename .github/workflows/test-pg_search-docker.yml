# workflows/test-pg_search-docker.yml
#
# Test pg_search (Docker)
# Test building and running the ParadeDB Docker Image using Docker Compose.

name: Test pg_search (Docker)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - 0.*.x # Release branches
    paths:
      - ".github/workflows/test-pg_search-docker.yml"
      - "docker/**"
      - "!docker/Dockerfile.stressgres"
      - "pg_search/**"
      - "tokenizers/**"
  workflow_dispatch:

concurrency:
  group: test-pg_search-docker-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  test-paradedb:
    name: Test ParadeDB Docker Image
    runs-on: ubicloud-standard-8-ubuntu-2404

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v6

      # To avoid spamming PRs with the Docker Scout comparison, we only run
      # it if the PR modifies the Dockerfile or its related scripts
      - name: Detect Dockerfile Changes
        id: dockerfilter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docker:
              - 'docker/**'

      # We only login when this is a trusted context where secrets are available:
      # - workflow_dispatch on this repository
      # - pull_request from a branch in this repository (not a fork)
      - name: Login to DHI Registry
        if: github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository
        uses: docker/login-action@v3
        with:
          registry: dhi.io
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Build the ParadeDB Docker Image via Docker Compose
        working-directory: docker/
        run: docker compose -f docker-compose.dev.yml build

      # Start the ParadeDB Docker image using `docker run` to test the standalone Docker image.
      # We add a --tmpfs mount as a test of compatibility with the upstream `postgres` image.
      # The `docker run` command will use the local ParadeDB image that we just built since we
      # tagged it with `latest` in docker-compose.dev.yml.
      - name: Start the ParadeDB Docker Image via Docker Run
        working-directory: docker/
        run: |
          docker run -d \
            --name paradedb \
            -e POSTGRES_USER=myuser \
            -e POSTGRES_PASSWORD=mypassword \
            -e POSTGRES_DB=mydatabase \
            -p 5432:5432 \
            --tmpfs /var/lib/postgresql:size=1G \
            paradedb/paradedb:latest

      # We run the container in detached mode, and grep for the word ERROR to see if it failed to start correctly
      - name: Check for Errors in the ParadeDB Docker Image
        working-directory: docker/
        run: |
          CONTAINER_ID=$(docker ps -aq --filter "name=paradedb")
          CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' $CONTAINER_ID)
          echo "paradedb container ID: $CONTAINER_ID"
          echo "Container status: $CONTAINER_STATUS"

          echo ""
          echo "Sleeping 30 seconds to give Postgres the time to fully initialize and run initdb..."
          sleep 30

          echo ""
          echo "Printing logs for the ParadeDB Docker container..."
          docker logs $CONTAINER_ID

          # Fail the run if the container failed to start
          if [ "$CONTAINER_STATUS" = "exited" ]; then
            echo "Error: Container failed to start properly"
            exit 1
          fi

          # Fail the run if there are any Postgres ERRORs in the logs
          if docker logs $CONTAINER_ID | grep -q ERROR; then
            echo "Error: ParadeDB Docker container logs contain an error"
            exit 1
          fi

      # Useful for debugging discrepancies between local and remote ParadeDB Docker images
      - name: Print the ParadeDB Docker Image History
        run: docker history paradedb/paradedb:latest

      - name: Print the ParadeDB Docker Image Permissions
        run: |
          docker run --name temp-inspect-paradedb --entrypoint /bin/bash paradedb/paradedb:latest -c "ls -la /var/lib/postgresql"
          docker rm temp-inspect-paradedb

      - name: Compare the ParadeDB Docker Image to the ParadeDB Docker Image in Docker Hub via Docker Scout
        if: (github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository) && steps.dockerfilter.outputs.docker == 'true'
        uses: docker/scout-action@v1
        with:
          command: compare
          image: paradedb/paradedb:latest # Local ParadeDB Docker Image
          to-env: production # Docker Hub ParadeDB Docker Image
          organization: paradedb
          ignore-unchanged: true
          only-severities: critical,high
          github-token: ${{ secrets.GITHUB_TOKEN }}
