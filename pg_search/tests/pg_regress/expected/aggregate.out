-- =====================================================================
-- Aggregate Custom Scan (Non-GROUP BY) Functionality
-- =====================================================================
-- This file tests aggregate functions (COUNT, SUM, AVG, MIN, MAX)
-- without GROUP BY clauses for the aggregate custom scan feature.
CREATE EXTENSION IF NOT EXISTS pg_search;
SET paradedb.enable_aggregate_custom_scan TO on;
-- =====================================================================
-- SECTION 1: Basic Aggregate Function Tests
-- =====================================================================
DROP TABLE IF EXISTS products CASCADE;
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    description TEXT,
    rating INTEGER,
    category TEXT,
    price NUMERIC,
    in_stock BOOLEAN
);
INSERT INTO products (description, rating, category, price, in_stock) VALUES
    ('Laptop with fast processor', 5, 'Electronics', 999.99, true),
    ('Gaming laptop with RGB', 5, 'Electronics', 1299.99, true),
    ('Toy laptop for kids', 3, 'Toys', 499.99, false),
    ('Wireless keyboard and mouse', 4, 'Electronics', 79.99, true),
    ('Mechanical keyboard RGB', 5, 'Electronics', 149.99, true),
    ('Running shoes for athletes', 5, 'Sports', 89.99, true),
    ('Winter jacket warm', 4, 'Clothing', 129.99, true),
    ('Summer jacket light', 3, 'Clothing', 59.99, true);
CREATE INDEX products_idx ON products
USING bm25 (id, description, rating, category, price)
WITH (
    key_field='id',
    text_fields='{"description": {}, "category": {"fast": true}}',
    numeric_fields='{"rating": {"fast": true}, "price": {"fast": true}}'
);
-- Test 1.1: COUNT(*) aggregate (already supported)
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*) FROM products WHERE description @@@ 'laptop';
                                                                      QUERY PLAN                                                                       
-------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.products
   Output: pdb.agg_fn('COUNT(*)'::text)
   Index: products_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: COUNT(*)
     Aggregate Definition: {"0":{"value_count":{"field":"ctid","missing":null}}}
(6 rows)

SELECT COUNT(*) FROM products WHERE description @@@ 'laptop';
 count 
-------
     3
(1 row)

-- Test 1.2: SUM aggregate
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT SUM(price) FROM products WHERE description @@@ 'laptop';
                                                                         QUERY PLAN                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: sum(price)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(9 rows)

SELECT SUM(price) FROM products WHERE description @@@ 'laptop';
   sum   
---------
 2799.97
(1 row)

-- Test 1.3: AVG aggregate
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT AVG(price) FROM products WHERE description @@@ 'laptop';
                                                                         QUERY PLAN                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: avg(price)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(9 rows)

SELECT AVG(price) FROM products WHERE description @@@ 'laptop';
         avg          
----------------------
 933.3233333333333333
(1 row)

-- Test 1.4: MIN aggregate
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT MIN(price) FROM products WHERE description @@@ 'laptop';
                                                                                                       QUERY PLAN                                                                                                        
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Result
   Output: (InitPlan 1).col1
   InitPlan 1
     ->  Limit
           Output: products.price
           ->  Custom Scan (ParadeDB Scan) on public.products
                 Output: products.price
                 Table: products
                 Index: products_idx
                 Exec Method: TopNScanExecState
                 Scores: false
                    TopN Order By: price asc
                    TopN Limit: 1
                 Tantivy Query: {"boolean":{"must":[{"exists":{"field":"price"}},{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}]}}
(14 rows)

SELECT MIN(price) FROM products WHERE description @@@ 'laptop';
  min   
--------
 499.99
(1 row)

-- Test 1.5: MAX aggregate
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT MAX(price) FROM products WHERE description @@@ 'laptop';
                                                                                                       QUERY PLAN                                                                                                        
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Result
   Output: (InitPlan 1).col1
   InitPlan 1
     ->  Limit
           Output: products.price
           ->  Custom Scan (ParadeDB Scan) on public.products
                 Output: products.price
                 Table: products
                 Index: products_idx
                 Exec Method: TopNScanExecState
                 Scores: false
                    TopN Order By: price desc
                    TopN Limit: 1
                 Tantivy Query: {"boolean":{"must":[{"exists":{"field":"price"}},{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}]}}
(14 rows)

SELECT MAX(price) FROM products WHERE description @@@ 'laptop';
   max   
---------
 1299.99
(1 row)

-- Test 1.6: Multiple aggregates in single query
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*), SUM(price), AVG(price), MIN(price), MAX(price)
FROM products WHERE description @@@ 'laptop';
                                                                         QUERY PLAN                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: count(*), sum(price), avg(price), min(price), max(price)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(9 rows)

SELECT COUNT(*), SUM(price), AVG(price), MIN(price), MAX(price)
FROM products WHERE description @@@ 'laptop';
 count |   sum   |         avg          |  min   |   max   
-------+---------+----------------------+--------+---------
     3 | 2799.97 | 933.3233333333333333 | 499.99 | 1299.99
(1 row)

-- =====================================================================
-- SECTION 2: Edge Cases and Error Conditions
-- =====================================================================
-- Test 2.1: Empty result set behavior
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*) FROM products WHERE description @@@ 'nonexistent';
                                                                         QUERY PLAN                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.products
   Output: pdb.agg_fn('COUNT(*)'::text)
   Index: products_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"nonexistent","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: COUNT(*)
     Aggregate Definition: {"0":{"value_count":{"field":"ctid","missing":null}}}
(6 rows)

SELECT COUNT(*) FROM products WHERE description @@@ 'nonexistent';
 count 
-------
     0
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT SUM(price) FROM products WHERE description @@@ 'nonexistent';
                                                                            QUERY PLAN                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: sum(price)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"nonexistent","lenient":null,"conjunction_mode":null}}}}
(9 rows)

SELECT SUM(price) FROM products WHERE description @@@ 'nonexistent';
 sum 
-----
    
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT AVG(price) FROM products WHERE description @@@ 'nonexistent';
                                                                            QUERY PLAN                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: avg(price)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"nonexistent","lenient":null,"conjunction_mode":null}}}}
(9 rows)

SELECT AVG(price) FROM products WHERE description @@@ 'nonexistent';
 avg 
-----
    
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT MIN(price) FROM products WHERE description @@@ 'nonexistent';
                                                                                                          QUERY PLAN                                                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Result
   Output: (InitPlan 1).col1
   InitPlan 1
     ->  Limit
           Output: products.price
           ->  Custom Scan (ParadeDB Scan) on public.products
                 Output: products.price
                 Table: products
                 Index: products_idx
                 Exec Method: TopNScanExecState
                 Scores: false
                    TopN Order By: price asc
                    TopN Limit: 1
                 Tantivy Query: {"boolean":{"must":[{"exists":{"field":"price"}},{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"nonexistent","lenient":null,"conjunction_mode":null}}}}]}}
(14 rows)

SELECT MIN(price) FROM products WHERE description @@@ 'nonexistent';
 min 
-----
    
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT MAX(price) FROM products WHERE description @@@ 'nonexistent';
                                                                                                          QUERY PLAN                                                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Result
   Output: (InitPlan 1).col1
   InitPlan 1
     ->  Limit
           Output: products.price
           ->  Custom Scan (ParadeDB Scan) on public.products
                 Output: products.price
                 Table: products
                 Index: products_idx
                 Exec Method: TopNScanExecState
                 Scores: false
                    TopN Order By: price desc
                    TopN Limit: 1
                 Tantivy Query: {"boolean":{"must":[{"exists":{"field":"price"}},{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"nonexistent","lenient":null,"conjunction_mode":null}}}}]}}
(14 rows)

SELECT MAX(price) FROM products WHERE description @@@ 'nonexistent';
 max 
-----
    
(1 row)

-- Test 2.2: Contradictory WHERE clauses (impossible conditions)
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
                                                                                                                                                                           QUERY PLAN                                                                                                                                                                            
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.products
   Output: pdb.agg_fn('COUNT(*)'::text)
   Index: products_idx
   Tantivy Query: {"boolean":{"must":[{"boolean":{"must":["all"],"must_not":[{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}},{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}}
     Applies to Aggregates: COUNT(*)
     Aggregate Definition: {"0":{"value_count":{"field":"ctid","missing":null}}}
(6 rows)

SELECT COUNT(*) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
 count 
-------
     0
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT SUM(price) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
                                                                                                                                                                              QUERY PLAN                                                                                                                                                                               
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: sum(price)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"boolean":{"must":[{"boolean":{"must":["all"],"must_not":[{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}},{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}}
(9 rows)

SELECT SUM(price) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
 sum 
-----
    
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT AVG(rating) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
                                                                                                                                                                           QUERY PLAN                                                                                                                                                                            
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.products
   Output: pdb.agg_fn('AVG'::text)
   Index: products_idx
   Tantivy Query: {"boolean":{"must":[{"boolean":{"must":["all"],"must_not":[{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}},{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}}
     Applies to Aggregates: AVG(rating)
     Aggregate Definition: {"0":{"avg":{"field":"rating","missing":null}}}
(6 rows)

SELECT AVG(rating) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
 avg 
-----
    
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT MIN(price) FROM products WHERE ((NOT (description @@@ 'laptop')) AND (description @@@ 'laptop'));
                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                               
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Result
   Output: (InitPlan 1).col1
   InitPlan 1
     ->  Limit
           Output: products.price
           ->  Custom Scan (ParadeDB Scan) on public.products
                 Output: products.price
                 Table: products
                 Index: products_idx
                 Exec Method: TopNScanExecState
                 Scores: false
                    TopN Order By: price asc
                    TopN Limit: 1
                 Tantivy Query: {"boolean":{"must":[{"exists":{"field":"price"}},{"boolean":{"must":["all"],"must_not":[{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}]}},{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}]}}
(14 rows)

SELECT MIN(price) FROM products WHERE ((NOT (description @@@ 'laptop')) AND (description @@@ 'laptop'));
 min 
-----
    
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT MAX(rating) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
                                                                                                                                                                           QUERY PLAN                                                                                                                                                                            
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.products
   Output: pdb.agg_fn('MAX'::text)
   Index: products_idx
   Tantivy Query: {"boolean":{"must":[{"boolean":{"must":["all"],"must_not":[{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}},{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}}
     Applies to Aggregates: MAX(rating)
     Aggregate Definition: {"0":{"max":{"field":"rating","missing":null}}}
(6 rows)

SELECT MAX(rating) FROM products WHERE ((NOT (category @@@ 'Electronics')) AND (category @@@ 'Electronics'));
 max 
-----
    
(1 row)

-- Test 2.3: Complex contradictory conditions
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*), SUM(price)
FROM products
WHERE (description @@@ 'laptop') AND ((NOT (rating < 4)) AND (rating < 4));
                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: count(*), sum(price)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}},{"range":{"field":"rating","lower_bound":{"included":4},"upper_bound":null,"is_datetime":false}},{"range":{"field":"rating","lower_bound":null,"upper_bound":{"excluded":4},"is_datetime":false}}]}}
(9 rows)

SELECT COUNT(*), SUM(price)
FROM products
WHERE (description @@@ 'laptop') AND ((NOT (rating < 4)) AND (rating < 4));
 count | sum 
-------+-----
     0 |    
(1 row)

-- =====================================================================
-- SECTION 3: Data Type Compatibility Tests
-- =====================================================================
DROP TABLE IF EXISTS type_test CASCADE;
CREATE TABLE type_test (
    id SERIAL PRIMARY KEY,
    int_val INTEGER,
    bigint_val BIGINT,
    smallint_val SMALLINT,
    numeric_val NUMERIC(10,2),
    float_val FLOAT,
    double_val DOUBLE PRECISION,
    text_val TEXT
);
INSERT INTO type_test (int_val, bigint_val, smallint_val, numeric_val, float_val, double_val, text_val) VALUES
    (100, 1000000, 10, 99.99, 1.5, 3.14159, 'test1'),
    (200, 2000000, 20, 199.99, 2.5, 6.28318, 'test2'),
    (300, 3000000, 30, 299.99, 3.5, 9.42477, 'test3');
CREATE INDEX type_test_idx ON type_test
USING bm25 (id, text_val, int_val, bigint_val, smallint_val, numeric_val, float_val, double_val)
WITH (
    key_field='id',
    text_fields='{"text_val": {"fast": true}}',
    numeric_fields='{
        "int_val": {"fast": true},
        "bigint_val": {"fast": true},
        "smallint_val": {"fast": true},
        "numeric_val": {"fast": true},
        "float_val": {"fast": true},
        "double_val": {"fast": true}
    }'
);
-- Test 3.1: Aggregates on different numeric types
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT
    SUM(int_val), AVG(int_val), MIN(int_val), MAX(int_val),
    SUM(bigint_val), AVG(bigint_val), MIN(bigint_val), MAX(bigint_val),
    SUM(smallint_val), AVG(smallint_val), MIN(smallint_val), MAX(smallint_val),
    SUM(numeric_val), AVG(numeric_val), MIN(numeric_val), MAX(numeric_val),
    SUM(float_val), AVG(float_val), MIN(float_val), MAX(float_val),
    SUM(double_val), AVG(double_val), MIN(double_val), MAX(double_val)
FROM type_test
WHERE text_val @@@ 'test1 OR test2';
                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: sum(int_val), avg(int_val), min(int_val), max(int_val), sum(bigint_val), avg(bigint_val), min(bigint_val), max(bigint_val), sum(smallint_val), avg(smallint_val), min(smallint_val), max(smallint_val), sum(numeric_val), avg(numeric_val), min(numeric_val), max(numeric_val), sum(float_val), avg(float_val), min(float_val), max(float_val), sum(double_val), avg(double_val), min(double_val), max(double_val)
   ->  Custom Scan (ParadeDB Scan) on public.type_test
         Output: int_val, bigint_val, smallint_val, numeric_val, float_val, double_val
         Table: type_test
         Index: type_test_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"text_val","query_string":"test1 OR test2","lenient":null,"conjunction_mode":null}}}}
(9 rows)

SELECT
    SUM(int_val), AVG(int_val), MIN(int_val), MAX(int_val),
    SUM(bigint_val), AVG(bigint_val), MIN(bigint_val), MAX(bigint_val),
    SUM(smallint_val), AVG(smallint_val), MIN(smallint_val), MAX(smallint_val),
    SUM(numeric_val), AVG(numeric_val), MIN(numeric_val), MAX(numeric_val),
    SUM(float_val), AVG(float_val), MIN(float_val), MAX(float_val),
    SUM(double_val), AVG(double_val), MIN(double_val), MAX(double_val)
FROM type_test
WHERE text_val @@@ 'test1 OR test2';
 sum |         avg          | min | max |   sum   |         avg          |   min   |   max   | sum |         avg         | min | max |  sum   |         avg          |  min  |  max   | sum | avg | min | max |        sum        |        avg        |   min   |   max   
-----+----------------------+-----+-----+---------+----------------------+---------+---------+-----+---------------------+-----+-----+--------+----------------------+-------+--------+-----+-----+-----+-----+-------------------+-------------------+---------+---------
 300 | 150.0000000000000000 | 100 | 200 | 3000000 | 1500000.000000000000 | 1000000 | 2000000 |  30 | 15.0000000000000000 |  10 |  20 | 299.98 | 149.9900000000000000 | 99.99 | 199.99 |   4 |   2 | 1.5 | 2.5 | 9.424769999999999 | 4.712384999999999 | 3.14159 | 6.28318
(1 row)

-- =====================================================================
-- SECTION 4: Validation and Fallback Tests
-- =====================================================================
-- Test 4.1: DISTINCT aggregates (should fall back to PostgreSQL)
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(DISTINCT category), SUM(price)
FROM products
WHERE description @@@ 'laptop';
                                                                            QUERY PLAN                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: count(DISTINCT category), sum(price)
   ->  Sort
         Output: category, price
         Sort Key: products.category
         ->  Custom Scan (ParadeDB Scan) on public.products
               Output: category, price
               Table: products
               Index: products_idx
               Exec Method: NormalScanExecState
               Scores: false
               Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(12 rows)

SELECT COUNT(DISTINCT category), SUM(price)
FROM products
WHERE description @@@ 'laptop';
 count |   sum   
-------+---------
     2 | 2799.97
(1 row)

-- Test 4.2: Aggregate on non-fast field (should fall back)
-- Note: description field is not marked as "fast" in the index
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT AVG(LENGTH(description))
FROM products
WHERE category @@@ 'Electronics';
                                                                          QUERY PLAN                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: avg(length(description))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: description
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}
(9 rows)

SELECT AVG(LENGTH(description))
FROM products
WHERE category @@@ 'Electronics';
         avg         
---------------------
 24.5000000000000000
(1 row)

-- =====================================================================
-- SECTION 6: Complex Query Patterns
-- =====================================================================
-- Test 6.1: Complex boolean WHERE clauses with aggregates
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*), SUM(price), AVG(rating)
FROM products
WHERE ((description @@@ 'laptop') OR (description @@@ 'keyboard'))
  AND (rating >= 4 OR category @@@ 'Electronics');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: count(*), sum(price), avg(rating)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price, rating
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"boolean":{"must":[{"boolean":{"should":[{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}},{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"keyboard","lenient":null,"conjunction_mode":null}}}}]}},{"boolean":{"should":[{"range":{"field":"rating","lower_bound":{"included":4},"upper_bound":null,"is_datetime":false}},{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}}]}}]}}
(9 rows)

SELECT COUNT(*), SUM(price), AVG(rating)
FROM products
WHERE ((description @@@ 'laptop') OR (description @@@ 'keyboard'))
  AND (rating >= 4 OR category @@@ 'Electronics');
 count |   sum   |        avg         
-------+---------+--------------------
     4 | 2529.96 | 4.7500000000000000
(1 row)

-- Test 6.2: Nested boolean expressions
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*), AVG(price), MIN(rating), MAX(rating)
FROM products
WHERE (NOT (NOT (category @@@ 'Electronics'))) AND (description @@@ 'laptop OR keyboard');
                                                                                                                                                              QUERY PLAN                                                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   Output: count(*), avg(price), min(rating), max(rating)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: price, rating
         Table: products
         Index: products_idx
         Exec Method: NormalScanExecState
         Scores: false
         Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"Electronics","lenient":null,"conjunction_mode":null}}}},{"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop OR keyboard","lenient":null,"conjunction_mode":null}}}}]}}
(9 rows)

SELECT COUNT(*), AVG(price), MIN(rating), MAX(rating)
FROM products
WHERE (NOT (NOT (category @@@ 'Electronics'))) AND (description @@@ 'laptop OR keyboard');
 count |         avg          | min | max 
-------+----------------------+-----+-----
     4 | 632.4900000000000000 |   4 |   5
(1 row)

-- =====================================================================
-- SECTION 7: COALESCE Null Values
-- =====================================================================
INSERT INTO products (description, rating, category, price, in_stock) VALUES
    (NULL, NULL, NULL, NULL, NULL);
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*), AVG(price), MIN(rating), MAX(rating)
FROM products
WHERE id @@@ paradedb.all();
                                               QUERY PLAN                                               
--------------------------------------------------------------------------------------------------------
 Finalize Aggregate
   Output: count(*), avg(price), min(rating), max(rating)
   ->  Gather
         Output: (PARTIAL count(*)), (PARTIAL avg(price)), (PARTIAL min(rating)), (PARTIAL max(rating))
         Workers Planned: 1
         ->  Partial Aggregate
               Output: PARTIAL count(*), PARTIAL avg(price), PARTIAL min(rating), PARTIAL max(rating)
               ->  Parallel Custom Scan (ParadeDB Scan) on public.products
                     Output: price, rating
                     Table: products
                     Index: products_idx
                     Exec Method: NormalScanExecState
                     Scores: false
                     Full Index Scan: true
                     Tantivy Query: {"with_index":{"query":"all"}}
(15 rows)

SELECT COUNT(*), AVG(price), MIN(rating), MAX(rating)
FROM products
WHERE id @@@ paradedb.all();
 count |         avg          | min | max 
-------+----------------------+-----+-----
     9 | 413.7400000000000000 |   3 |   5
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*), AVG(COALESCE(price, 0)), MIN(COALESCE(rating, 0)), MAX(COALESCE(rating, 0))
FROM products
WHERE id @@@ paradedb.all();
                                                                        QUERY PLAN                                                                        
----------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize Aggregate
   Output: count(*), avg(COALESCE(price, '0'::numeric)), min(COALESCE(rating, 0)), max(COALESCE(rating, 0))
   ->  Gather
         Output: (PARTIAL count(*)), (PARTIAL avg(COALESCE(price, '0'::numeric))), (PARTIAL min(COALESCE(rating, 0))), (PARTIAL max(COALESCE(rating, 0)))
         Workers Planned: 1
         ->  Partial Aggregate
               Output: PARTIAL count(*), PARTIAL avg(COALESCE(price, '0'::numeric)), PARTIAL min(COALESCE(rating, 0)), PARTIAL max(COALESCE(rating, 0))
               ->  Parallel Custom Scan (ParadeDB Scan) on public.products
                     Output: price, rating
                     Table: products
                     Index: products_idx
                     Exec Method: NormalScanExecState
                     Scores: false
                     Full Index Scan: true
                     Tantivy Query: {"with_index":{"query":"all"}}
(15 rows)

SELECT COUNT(*), AVG(COALESCE(price, 0)), MIN(COALESCE(rating, 0)), MAX(COALESCE(rating, 0))
FROM products
WHERE id @@@ paradedb.all();
 count |         avg          | min | max 
-------+----------------------+-----+-----
     9 | 367.7688888888888889 |   0 |   5
(1 row)

SELECT COUNT(*), AVG(COALESCE(price, 0)), MIN(COALESCE(rating, 0)), MAX(COALESCE(rating, 0))
FROM products;
 count |         avg          | min | max 
-------+----------------------+-----+-----
     9 | 367.7688888888888889 |   0 |   5
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT COUNT(*), AVG(COALESCE(price, 1)), MIN(COALESCE(rating, 1)), MAX(COALESCE(rating, 1))
FROM products
WHERE id @@@ paradedb.all();
                                                                        QUERY PLAN                                                                        
----------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize Aggregate
   Output: count(*), avg(COALESCE(price, '1'::numeric)), min(COALESCE(rating, 1)), max(COALESCE(rating, 1))
   ->  Gather
         Output: (PARTIAL count(*)), (PARTIAL avg(COALESCE(price, '1'::numeric))), (PARTIAL min(COALESCE(rating, 1))), (PARTIAL max(COALESCE(rating, 1)))
         Workers Planned: 1
         ->  Partial Aggregate
               Output: PARTIAL count(*), PARTIAL avg(COALESCE(price, '1'::numeric)), PARTIAL min(COALESCE(rating, 1)), PARTIAL max(COALESCE(rating, 1))
               ->  Parallel Custom Scan (ParadeDB Scan) on public.products
                     Output: price, rating
                     Table: products
                     Index: products_idx
                     Exec Method: NormalScanExecState
                     Scores: false
                     Full Index Scan: true
                     Tantivy Query: {"with_index":{"query":"all"}}
(15 rows)

SELECT COUNT(*), AVG(COALESCE(price, 1)), MIN(COALESCE(rating, 1)), MAX(COALESCE(rating, 1))
FROM products
WHERE id @@@ paradedb.all();
 count |         avg          | min | max 
-------+----------------------+-----+-----
     9 | 367.8800000000000000 |   1 |   5
(1 row)

SELECT COUNT(*), AVG(COALESCE(price, 1)), MIN(COALESCE(rating, 1)), MAX(COALESCE(rating, 1))
FROM products;
 count |         avg          | min | max 
-------+----------------------+-----+-----
     9 | 367.8800000000000000 |   1 |   5
(1 row)

-- =====================================================================
-- Cleanup
-- =====================================================================
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS type_test CASCADE;
RESET paradedb.enable_aggregate_custom_scan;
