-- Test cases demonstrating OR decomposition for cross-table search queries
-- These tests specifically target the pattern: a.col1 @@@ 'test1' OR b.col2 @@@ 'test2'
-- where PostgreSQL puts the condition in joininfo but we can safely decompose it
-- Load the pg_search extension
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Setup test tables for cross-table OR conditions
DROP TABLE IF EXISTS table_a;
DROP TABLE IF EXISTS table_b;
DROP TABLE IF EXISTS table_c;
CREATE TABLE table_a (
    id SERIAL PRIMARY KEY,
    content TEXT,
    category TEXT,
    value INTEGER
);
CREATE TABLE table_b (
    id SERIAL PRIMARY KEY,
    content TEXT,
    description TEXT,
    priority INTEGER
);
CREATE TABLE table_c (
    id SERIAL PRIMARY KEY,
    content TEXT,
    notes TEXT,
    score INTEGER
);
-- Insert test data
INSERT INTO table_a (content, category, value) VALUES
('smartphone technology advanced', 'electronics', 100),
('laptop computer powerful', 'electronics', 200),
('book fiction story', 'literature', 50),
('game console modern', 'electronics', 150);
INSERT INTO table_b (content, description, priority) VALUES
('advanced features smartphone', 'mobile capabilities', 1),
('high performance specs', 'laptop specifications', 2),
('storytelling narrative', 'book content description', 3),
('gaming experience immersive', 'console entertainment', 1);
INSERT INTO table_c (content, notes, score) VALUES
('technology innovation', 'cutting edge tech notes', 95),
('performance benchmarks', 'speed test results', 88),
('narrative structure', 'story analysis notes', 77),
('entertainment value', 'fun factor assessment', 92);
-- Create BM25 indexes
CREATE INDEX table_a_bm25_idx ON table_a USING bm25 (id, content, category) WITH (key_field = 'id');
CREATE INDEX table_b_bm25_idx ON table_b USING bm25 (id, content, description) WITH (key_field = 'id');
CREATE INDEX table_c_bm25_idx ON table_c USING bm25 (id, content, notes) WITH (key_field = 'id');
-- =============================================================================
-- CORE TEST: Basic cross-table OR decomposition
-- =============================================================================
SELECT 'Core Test: Basic cross-table OR - a.content @@@ X OR b.content @@@ Y' as test_name;
                              test_name                               
----------------------------------------------------------------------
 Core Test: Basic cross-table OR - a.content @@@ X OR b.content @@@ Y
(1 row)

-- This is the fundamental pattern we want to support:
-- PostgreSQL cannot push this to baserestrictinfo due to cross-table nature
-- But we can decompose it: extract a.content @@@ 'smartphone' for table_a, 
-- b.content @@@ 'performance' for table_b
SELECT 
    a.content as a_content,
    b.content as b_content,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score
FROM table_a a
CROSS JOIN table_b b
WHERE (a.content @@@ 'smartphone' OR b.content @@@ 'performance')
ORDER BY a_score DESC, b_score DESC;
           a_content            |          b_content           |  a_score  |  b_score  
--------------------------------+------------------------------+-----------+-----------
 smartphone technology advanced | high performance specs       | 1.2039728 | 1.1608026
 smartphone technology advanced | storytelling narrative       | 1.2039728 |         0
 smartphone technology advanced | advanced features smartphone | 1.2039728 |         0
 smartphone technology advanced | gaming experience immersive  | 1.2039728 |         0
 laptop computer powerful       | high performance specs       |         0 | 1.1608026
 book fiction story             | high performance specs       |         0 | 1.1608026
 game console modern            | high performance specs       |         0 | 1.1608026
(7 rows)

-- =============================================================================
-- MULTI-RELATION TEST: Three-table OR decomposition
-- =============================================================================
SELECT 'Multi-Relation Test: Three-table OR - a @@@ X OR b @@@ Y OR c @@@ Z' as test_name;
                              test_name                              
---------------------------------------------------------------------
 Multi-Relation Test: Three-table OR - a @@@ X OR b @@@ Y OR c @@@ Z
(1 row)

-- Test OR decomposition across three relations
-- Should extract: a.content @@@ 'laptop' for table_a, 
-- b.content @@@ 'gaming' for table_b, c.content @@@ 'innovation' for table_c
SELECT 
    a.content as a_content,
    b.content as b_content,
    c.content as c_content,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score,
    paradedb.score(c.id) as c_score
FROM table_a a
CROSS JOIN table_b b
CROSS JOIN table_c c
WHERE (a.content @@@ 'laptop' OR b.content @@@ 'gaming' OR c.content @@@ 'innovation')
ORDER BY a_score DESC, b_score DESC, c_score DESC;
           a_content            |          b_content           |       c_content        |  a_score  |  b_score  |  c_score  
--------------------------------+------------------------------+------------------------+-----------+-----------+-----------
 laptop computer powerful       | gaming experience immersive  | technology innovation  | 1.2039728 | 1.1608026 | 1.2039728
 laptop computer powerful       | gaming experience immersive  | performance benchmarks | 1.2039728 | 1.1608026 |         0
 laptop computer powerful       | gaming experience immersive  | narrative structure    | 1.2039728 | 1.1608026 |         0
 laptop computer powerful       | gaming experience immersive  | entertainment value    | 1.2039728 | 1.1608026 |         0
 laptop computer powerful       | advanced features smartphone | technology innovation  | 1.2039728 |         0 | 1.2039728
 laptop computer powerful       | storytelling narrative       | technology innovation  | 1.2039728 |         0 | 1.2039728
 laptop computer powerful       | high performance specs       | technology innovation  | 1.2039728 |         0 | 1.2039728
 laptop computer powerful       | storytelling narrative       | entertainment value    | 1.2039728 |         0 |         0
 laptop computer powerful       | advanced features smartphone | performance benchmarks | 1.2039728 |         0 |         0
 laptop computer powerful       | advanced features smartphone | narrative structure    | 1.2039728 |         0 |         0
 laptop computer powerful       | advanced features smartphone | entertainment value    | 1.2039728 |         0 |         0
 laptop computer powerful       | high performance specs       | entertainment value    | 1.2039728 |         0 |         0
 laptop computer powerful       | storytelling narrative       | performance benchmarks | 1.2039728 |         0 |         0
 laptop computer powerful       | storytelling narrative       | narrative structure    | 1.2039728 |         0 |         0
 laptop computer powerful       | high performance specs       | performance benchmarks | 1.2039728 |         0 |         0
 laptop computer powerful       | high performance specs       | narrative structure    | 1.2039728 |         0 |         0
 smartphone technology advanced | gaming experience immersive  | technology innovation  |         0 | 1.1608026 | 1.2039728
 game console modern            | gaming experience immersive  | technology innovation  |         0 | 1.1608026 | 1.2039728
 book fiction story             | gaming experience immersive  | technology innovation  |         0 | 1.1608026 | 1.2039728
 game console modern            | gaming experience immersive  | entertainment value    |         0 | 1.1608026 |         0
 smartphone technology advanced | gaming experience immersive  | performance benchmarks |         0 | 1.1608026 |         0
 smartphone technology advanced | gaming experience immersive  | narrative structure    |         0 | 1.1608026 |         0
 smartphone technology advanced | gaming experience immersive  | entertainment value    |         0 | 1.1608026 |         0
 book fiction story             | gaming experience immersive  | performance benchmarks |         0 | 1.1608026 |         0
 book fiction story             | gaming experience immersive  | narrative structure    |         0 | 1.1608026 |         0
 book fiction story             | gaming experience immersive  | entertainment value    |         0 | 1.1608026 |         0
 game console modern            | gaming experience immersive  | performance benchmarks |         0 | 1.1608026 |         0
 game console modern            | gaming experience immersive  | narrative structure    |         0 | 1.1608026 |         0
 smartphone technology advanced | high performance specs       | technology innovation  |         0 |         0 | 1.2039728
 smartphone technology advanced | advanced features smartphone | technology innovation  |         0 |         0 | 1.2039728
 game console modern            | advanced features smartphone | technology innovation  |         0 |         0 | 1.2039728
 game console modern            | high performance specs       | technology innovation  |         0 |         0 | 1.2039728
 book fiction story             | advanced features smartphone | technology innovation  |         0 |         0 | 1.2039728
 book fiction story             | high performance specs       | technology innovation  |         0 |         0 | 1.2039728
 book fiction story             | storytelling narrative       | technology innovation  |         0 |         0 | 1.2039728
 smartphone technology advanced | storytelling narrative       | technology innovation  |         0 |         0 | 1.2039728
 game console modern            | storytelling narrative       | technology innovation  |         0 |         0 | 1.2039728
(37 rows)

-- =============================================================================
-- MULTIPLE CONDITIONS PER RELATION TEST
-- =============================================================================
SELECT 'Multiple Conditions Test: Multiple search terms per relation in OR' as test_name;
                             test_name                              
--------------------------------------------------------------------
 Multiple Conditions Test: Multiple search terms per relation in OR
(1 row)

-- Test multiple search conditions for the same relation within OR
-- Should extract: (a.content @@@ 'smartphone' OR a.category @@@ 'electronics') for table_a,
-- b.content @@@ 'performance' for table_b
SELECT 
    a.content as a_content,
    a.category as a_category,
    b.content as b_content,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score
FROM table_a a
CROSS JOIN table_b b
WHERE (a.content @@@ 'smartphone' OR a.category @@@ 'electronics' OR b.content @@@ 'performance')
ORDER BY a_score DESC, b_score DESC;
           a_content            | a_category  |          b_content           |  a_score   |  b_score  
--------------------------------+-------------+------------------------------+------------+-----------
 smartphone technology advanced | electronics | high performance specs       |  1.5606477 | 1.1608026
 smartphone technology advanced | electronics | storytelling narrative       |  1.5606477 |         0
 smartphone technology advanced | electronics | gaming experience immersive  |  1.5606477 |         0
 smartphone technology advanced | electronics | advanced features smartphone |  1.5606477 |         0
 game console modern            | electronics | high performance specs       | 0.35667497 | 1.1608026
 laptop computer powerful       | electronics | high performance specs       | 0.35667497 | 1.1608026
 game console modern            | electronics | gaming experience immersive  | 0.35667497 |         0
 laptop computer powerful       | electronics | advanced features smartphone | 0.35667497 |         0
 laptop computer powerful       | electronics | storytelling narrative       | 0.35667497 |         0
 laptop computer powerful       | electronics | gaming experience immersive  | 0.35667497 |         0
 game console modern            | electronics | advanced features smartphone | 0.35667497 |         0
 game console modern            | electronics | storytelling narrative       | 0.35667497 |         0
 book fiction story             | literature  | high performance specs       |          0 | 1.1608026
(13 rows)

-- =============================================================================
-- MIXED SEARCH AND NON-SEARCH TEST
-- =============================================================================
SELECT 'Mixed Conditions Test: Search and non-search predicates in OR' as test_name;
                           test_name                           
---------------------------------------------------------------
 Mixed Conditions Test: Search and non-search predicates in OR
(1 row)

-- Test OR with both search and non-search conditions
-- Should extract: a.content @@@ 'laptop' for table_a (search),
-- and handle a.value > 150 and b.priority = 1 appropriately
SELECT 
    a.content as a_content,
    a.value as a_value,
    b.content as b_content,
    b.priority as b_priority,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score
FROM table_a a
CROSS JOIN table_b b
WHERE (a.content @@@ 'laptop' OR a.value > 150 OR b.priority = 1)
ORDER BY a_score DESC, b_score DESC;
WARNING:  OR decomposition (partial): OR condition: extracted 2 predicates (1 search, 1 non-search), 0 cross-table clauses remain
WARNING:  quals: Some(Or([OpExpr { lhs: 0x7ff54600c6a8, opno: 62172, val: 0x7ff546014ed8 }, HeapExpr { expr_node: 0x7ff546017c68, expr_desc: "OpExpr with operator OID 521", search_query_input: All }]))
WARNING:  OR decomposition (partial): OR condition: extracted 1 predicates (0 search, 1 non-search), 0 cross-table clauses remain
WARNING:  quals: Some(HeapExpr { expr_node: 0x7ff546017d58, expr_desc: "OpExpr with operator OID 96", search_query_input: All })
        a_content         | a_value |          b_content           | b_priority |  a_score  | b_score 
--------------------------+---------+------------------------------+------------+-----------+---------
 laptop computer powerful |     200 | advanced features smartphone |          1 | 1.2039728 |       0
 laptop computer powerful |     200 | gaming experience immersive  |          1 | 1.2039728 |       0
(2 rows)

-- =============================================================================
-- NESTED AND/OR TEST
-- =============================================================================
SELECT 'Nested Logic Test: Complex AND/OR combinations' as test_name;
                   test_name                    
------------------------------------------------
 Nested Logic Test: Complex AND/OR combinations
(1 row)

-- Test complex nested boolean logic
-- Should handle: (a.content @@@ 'smartphone' AND a.value > 50) OR (b.content @@@ 'gaming' AND b.priority = 1)
SELECT 
    a.content as a_content,
    a.value as a_value,
    b.content as b_content,
    b.priority as b_priority,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score
FROM table_a a
CROSS JOIN table_b b
WHERE (a.content @@@ 'smartphone' AND a.value > 50) 
   OR (b.content @@@ 'gaming' AND b.priority = 1)
ORDER BY a_score DESC, b_score DESC;
WARNING:  OR decomposition (rejected): OR condition: no extractable predicates for target relation (checked 2 clauses)
WARNING:  OR decomposition (rejected): OR condition: no extractable predicates for target relation (checked 2 clauses)
           a_content            | a_value |          b_content           | b_priority | a_score | b_score 
--------------------------------+---------+------------------------------+------------+---------+---------
 smartphone technology advanced |     100 | advanced features smartphone |          1 |         |        
 smartphone technology advanced |     100 | high performance specs       |          2 |         |        
 smartphone technology advanced |     100 | storytelling narrative       |          3 |         |        
 smartphone technology advanced |     100 | gaming experience immersive  |          1 |         |        
 laptop computer powerful       |     200 | gaming experience immersive  |          1 |         |        
 book fiction story             |      50 | gaming experience immersive  |          1 |         |        
 game console modern            |     150 | gaming experience immersive  |          1 |         |        
(7 rows)

-- =============================================================================
-- UNSAFE CONDITIONS TEST (should be rejected)
-- =============================================================================
SELECT 'Unsafe Conditions Test: Conditions that should be rejected' as test_name;
                         test_name                          
------------------------------------------------------------
 Unsafe Conditions Test: Conditions that should be rejected
(1 row)

-- Test conditions that cannot be safely decomposed
-- This should be rejected because the comparison spans tables
SELECT 
    a.content as a_content,
    b.content as b_content,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score
FROM table_a a
CROSS JOIN table_b b
WHERE (a.content @@@ 'smartphone' OR a.value = b.priority)  -- Mixed safe and unsafe
ORDER BY a_score DESC, b_score DESC;
WARNING:  OR decomposition (full): OR condition: extracted all 1 search predicates for target relation
WARNING:  quals: Some(OpExpr { lhs: 0x7ff5460093f8, opno: 62172, val: 0x7ff54600b430 })
WARNING:  OR decomposition (rejected): OR condition: no extractable predicates for target relation (checked 2 clauses)
           a_content            |          b_content           |  a_score  | b_score 
--------------------------------+------------------------------+-----------+---------
 smartphone technology advanced | advanced features smartphone | 1.2039728 |        
 smartphone technology advanced | high performance specs       | 1.2039728 |        
 smartphone technology advanced | storytelling narrative       | 1.2039728 |        
 smartphone technology advanced | gaming experience immersive  | 1.2039728 |        
(4 rows)

-- =============================================================================
-- JOIN-BASED TESTS (more realistic scenarios)
-- =============================================================================
SELECT 'Join-Based Test: OR decomposition with actual joins' as test_name;
                      test_name                      
-----------------------------------------------------
 Join-Based Test: OR decomposition with actual joins
(1 row)

-- Test OR decomposition in more realistic join scenarios
-- This is more likely to trigger joininfo conditions
SELECT 
    a.content as a_content,
    b.content as b_content,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score
FROM table_a a
JOIN table_b b ON a.value = b.priority * 100  -- Join condition
WHERE (a.content @@@ 'electronics' OR b.description @@@ 'capabilities')
ORDER BY a_score DESC, b_score DESC;
           a_content            |          b_content           | a_score | b_score  
--------------------------------+------------------------------+---------+----------
 smartphone technology advanced | advanced features smartphone |       0 | 1.261305
(1 row)

-- =============================================================================
-- COMPLEX REAL-WORLD SCENARIO
-- =============================================================================
SELECT 'Real-World Test: Complex multi-table search with various conditions' as test_name;
                              test_name                              
---------------------------------------------------------------------
 Real-World Test: Complex multi-table search with various conditions
(1 row)

-- Complex scenario combining multiple search patterns
SELECT 
    a.content as a_content,
    b.content as b_content,
    c.content as c_content,
    paradedb.score(a.id) as a_score,
    paradedb.score(b.id) as b_score,
    paradedb.score(c.id) as c_score
FROM table_a a
LEFT JOIN table_b b ON a.value > b.priority * 50
LEFT JOIN table_c c ON b.priority = c.score / 30
WHERE (a.content @@@ 'technology' OR a.category @@@ 'electronics')
   OR (b.content @@@ 'performance' OR b.description @@@ 'specifications')
   OR (c.content @@@ 'innovation' OR c.notes @@@ 'cutting')
ORDER BY a_score DESC, b_score DESC, c_score DESC;
WARNING:  OR decomposition (rejected): Single predicate contains unsafe references
WARNING:  OR decomposition (rejected): Single predicate contains unsafe references
WARNING:  OR decomposition (rejected): Single predicate contains unsafe references
           a_content            |          b_content           |       c_content        | a_score | b_score | c_score 
--------------------------------+------------------------------+------------------------+---------+---------+---------
 smartphone technology advanced | advanced features smartphone |                        |         |         |        
 smartphone technology advanced | gaming experience immersive  |                        |         |         |        
 laptop computer powerful       | advanced features smartphone |                        |         |         |        
 laptop computer powerful       | high performance specs       | narrative structure    |         |         |        
 laptop computer powerful       | high performance specs       | performance benchmarks |         |         |        
 laptop computer powerful       | storytelling narrative       | entertainment value    |         |         |        
 laptop computer powerful       | storytelling narrative       | technology innovation  |         |         |        
 laptop computer powerful       | gaming experience immersive  |                        |         |         |        
 game console modern            | advanced features smartphone |                        |         |         |        
 game console modern            | high performance specs       | narrative structure    |         |         |        
 game console modern            | high performance specs       | performance benchmarks |         |         |        
 game console modern            | gaming experience immersive  |                        |         |         |        
(12 rows)

-- =============================================================================
-- VERIFICATION TESTS: Compare with single-table queries
-- =============================================================================
SELECT 'Verification: Single-table queries for comparison' as test_name;
                     test_name                     
---------------------------------------------------
 Verification: Single-table queries for comparison
(1 row)

-- Verify that our decomposition produces equivalent scoring to direct queries
SELECT 'Single table A - smartphone' as query_type, 
       a.content, paradedb.score(a.id) as score
FROM table_a a 
WHERE a.content @@@ 'smartphone'
UNION ALL
SELECT 'Single table B - performance' as query_type,
       b.content, paradedb.score(b.id) as score  
FROM table_b b
WHERE b.content @@@ 'performance'
ORDER BY score DESC;
          query_type          |            content             |   score   
------------------------------+--------------------------------+-----------
 Single table A - smartphone  | smartphone technology advanced | 1.2039728
 Single table B - performance | high performance specs         | 1.1608026
(2 rows)

-- =============================================================================
-- SUMMARY
-- =============================================================================
SELECT 'Summary: OR decomposition tests completed' as summary;
                  summary                  
-------------------------------------------
 Summary: OR decomposition tests completed
(1 row)

-- Expected behavior:
-- 1. Basic cross-table OR should extract search predicates for each relation
-- 2. Multi-relation OR should handle 3+ tables correctly  
-- 3. Multiple conditions per relation should be combined appropriately
-- 4. Mixed search/non-search should extract what's safe
-- 5. Nested logic should be handled intelligently
-- 6. Unsafe conditions should be properly rejected
-- 7. Real join scenarios should work with proper decomposition
-- 8. Results should be semantically equivalent to single-table queries
-- Cleanup
DROP TABLE IF EXISTS table_c;
DROP TABLE IF EXISTS table_b;
DROP TABLE IF EXISTS table_a; 
