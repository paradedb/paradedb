-- Test basic join hook functionality
-- This test verifies that our custom join hook is being called
-- Create the extension first
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Enable the custom join feature
SET paradedb.enable_custom_join = true;
-- Create test tables with BM25 indexes
CREATE TABLE documents_join_test (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT
);
CREATE TABLE files_join_test (
    id SERIAL PRIMARY KEY,
    document_id INTEGER,
    filename TEXT,
    content TEXT
);
-- Insert test data
INSERT INTO documents_join_test (title, content) VALUES 
    ('Document 1', 'This is the first document about technology'),
    ('Document 2', 'This is the second document about science'),
    ('Document 3', 'This is the third document about research');
INSERT INTO files_join_test (document_id, filename, content) VALUES 
    (1, 'file1.txt', 'Technology file content'),
    (2, 'file2.txt', 'Science file content'),
    (3, 'file3.txt', 'Research file content');
-- Create BM25 indexes
CREATE INDEX documents_join_test_idx ON documents_join_test USING bm25 (
    id,
    title,
    content
) WITH (
    key_field = 'id',
    text_fields = '{"title": {"tokenizer": {"type": "default"}}, "content": {"tokenizer": {"type": "default"}}}'
);
CREATE INDEX files_join_test_idx ON files_join_test USING bm25 (
    id,
    document_id,
    filename,
    content
) WITH (
    key_field = 'id',
    numeric_fields = '{"document_id": {"fast": true}}',
    text_fields = '{"filename": {"tokenizer": {"type": "default"}}, "content": {"tokenizer": {"type": "default"}}}'
);
-- Test 1: Simple INNER JOIN with search predicates
-- This should trigger our join hook and show debug output
SELECT d.id, d.title, f.filename
FROM documents_join_test d
JOIN files_join_test f ON d.id = f.document_id
WHERE d.content @@@ 'technology' AND f.content @@@ 'file';
WARNING:  ParadeDB: Join pathlist callback called - jointype: 0, outer relids: ["documents_join_test"], inner relids: ["files_join_test"]
WARNING:  ParadeDB: Checking relation documents_join_test (rti 1) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation documents_join_test
WARNING:  ParadeDB: Checking relation files_join_test (rti 2) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation files_join_test
WARNING:  ParadeDB: Join is feasible - would create custom join path here
WARNING:  ParadeDB: Analyzing join search predicates
WARNING:  ParadeDB: Found 1 join restriction clauses
WARNING:  ParadeDB: Analyzing join clause of type T_OpExpr
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation documents_join_test (rti 1)
WARNING:  ParadeDB: Extracted search query for documents_join_test: uses_search_operator=true
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation files_join_test (rti 2)
WARNING:  ParadeDB: Extracted search query for files_join_test: uses_search_operator=true
WARNING:  ParadeDB: Extracted 1 outer predicates, 1 inner predicates, 0 join conditions
WARNING:  ParadeDB: Found search predicates - outer: 1, inner: 1, bilateral: true
WARNING:  ParadeDB: Outer predicate for documents_join_test - uses_search: true
WARNING:  ParadeDB: Inner predicate for files_join_test - uses_search: true
WARNING:  ParadeDB: Join path estimates - rows: 1, startup_cost: 100.00, total_cost: 100.01
WARNING:  ParadeDB: Created custom join path, adding to joinrel
WARNING:  ParadeDB: Join pathlist callback called - jointype: 0, outer relids: ["files_join_test"], inner relids: ["documents_join_test"]
WARNING:  ParadeDB: Checking relation files_join_test (rti 2) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation files_join_test
WARNING:  ParadeDB: Checking relation documents_join_test (rti 1) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation documents_join_test
WARNING:  ParadeDB: Join is feasible - would create custom join path here
WARNING:  ParadeDB: Analyzing join search predicates
WARNING:  ParadeDB: Found 1 join restriction clauses
WARNING:  ParadeDB: Analyzing join clause of type T_OpExpr
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation files_join_test (rti 2)
WARNING:  ParadeDB: Extracted search query for files_join_test: uses_search_operator=true
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation documents_join_test (rti 1)
WARNING:  ParadeDB: Extracted search query for documents_join_test: uses_search_operator=true
WARNING:  ParadeDB: Extracted 1 outer predicates, 1 inner predicates, 0 join conditions
WARNING:  ParadeDB: Found search predicates - outer: 1, inner: 1, bilateral: true
WARNING:  ParadeDB: Outer predicate for files_join_test - uses_search: true
WARNING:  ParadeDB: Inner predicate for documents_join_test - uses_search: true
WARNING:  ParadeDB: Join path estimates - rows: 1, startup_cost: 100.00, total_cost: 100.01
WARNING:  ParadeDB: Created custom join path, adding to joinrel
WARNING:  ParadeDB: Planning custom join path with scanrelid = 0
WARNING:  ParadeDB: Join target list has 3 entries
ERROR:  variable not found in subplan target list
-- Test 2: JOIN without search predicates (should not trigger custom join)
SELECT d.id, d.title, f.filename  
FROM documents_join_test d
JOIN files_join_test f ON d.id = f.document_id
WHERE d.id = 1;
WARNING:  ParadeDB: Join pathlist callback called - jointype: 0, outer relids: ["documents_join_test"], inner relids: ["files_join_test"]
WARNING:  ParadeDB: Checking relation documents_join_test (rti 1) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation documents_join_test
WARNING:  ParadeDB: Checking relation files_join_test (rti 2) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation files_join_test
WARNING:  ParadeDB: Join is feasible - would create custom join path here
WARNING:  ParadeDB: Analyzing join search predicates
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation documents_join_test (rti 1)
WARNING:  ParadeDB: Extracted search query for documents_join_test: uses_search_operator=false
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation files_join_test (rti 2)
WARNING:  ParadeDB: Extracted search query for files_join_test: uses_search_operator=false
WARNING:  ParadeDB: Extracted 1 outer predicates, 1 inner predicates, 0 join conditions
WARNING:  ParadeDB: Found search predicates - outer: 1, inner: 1, bilateral: true
WARNING:  ParadeDB: Outer predicate for documents_join_test - uses_search: false
WARNING:  ParadeDB: Inner predicate for files_join_test - uses_search: false
WARNING:  ParadeDB: Join path estimates - rows: 1, startup_cost: 100.00, total_cost: 100.01
WARNING:  ParadeDB: Created custom join path, adding to joinrel
WARNING:  ParadeDB: Join pathlist callback called - jointype: 0, outer relids: ["files_join_test"], inner relids: ["documents_join_test"]
WARNING:  ParadeDB: Checking relation files_join_test (rti 2) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation files_join_test
WARNING:  ParadeDB: Checking relation documents_join_test (rti 1) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation documents_join_test
WARNING:  ParadeDB: Join is feasible - would create custom join path here
WARNING:  ParadeDB: Analyzing join search predicates
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation files_join_test (rti 2)
WARNING:  ParadeDB: Extracted search query for files_join_test: uses_search_operator=false
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation documents_join_test (rti 1)
WARNING:  ParadeDB: Extracted search query for documents_join_test: uses_search_operator=false
WARNING:  ParadeDB: Extracted 1 outer predicates, 1 inner predicates, 0 join conditions
WARNING:  ParadeDB: Found search predicates - outer: 1, inner: 1, bilateral: true
WARNING:  ParadeDB: Outer predicate for files_join_test - uses_search: false
WARNING:  ParadeDB: Inner predicate for documents_join_test - uses_search: false
WARNING:  ParadeDB: Join path estimates - rows: 1, startup_cost: 100.00, total_cost: 100.01
WARNING:  ParadeDB: Created custom join path, adding to joinrel
 id |   title    | filename  
----+------------+-----------
  1 | Document 1 | file1.txt
(1 row)

-- Test 3: Search on only one side (should not trigger custom join)
SELECT d.id, d.title, f.filename
FROM documents_join_test d  
JOIN files_join_test f ON d.id = f.document_id
WHERE d.content @@@ 'science';
WARNING:  ParadeDB: Join pathlist callback called - jointype: 0, outer relids: ["documents_join_test"], inner relids: ["files_join_test"]
WARNING:  ParadeDB: Checking relation documents_join_test (rti 1) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation documents_join_test
WARNING:  ParadeDB: Checking relation files_join_test (rti 2) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation files_join_test
WARNING:  ParadeDB: Join is feasible - would create custom join path here
WARNING:  ParadeDB: Analyzing join search predicates
WARNING:  ParadeDB: Found 1 join restriction clauses
WARNING:  ParadeDB: Analyzing join clause of type T_OpExpr
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation documents_join_test (rti 1)
WARNING:  ParadeDB: Extracted search query for documents_join_test: uses_search_operator=true
WARNING:  ParadeDB: Extracted 1 outer predicates, 0 inner predicates, 0 join conditions
WARNING:  ParadeDB: Found search predicates - outer: 1, inner: 0, bilateral: false
WARNING:  ParadeDB: Outer predicate for documents_join_test - uses_search: true
WARNING:  ParadeDB: Join path estimates - rows: 1, startup_cost: 100.00, total_cost: 100.01
WARNING:  ParadeDB: Created custom join path, adding to joinrel
WARNING:  ParadeDB: Join pathlist callback called - jointype: 0, outer relids: ["files_join_test"], inner relids: ["documents_join_test"]
WARNING:  ParadeDB: Checking relation files_join_test (rti 2) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation files_join_test
WARNING:  ParadeDB: Checking relation documents_join_test (rti 1) for BM25 index
WARNING:  ParadeDB: Found BM25 index for relation documents_join_test
WARNING:  ParadeDB: Join is feasible - would create custom join path here
WARNING:  ParadeDB: Analyzing join search predicates
WARNING:  ParadeDB: Found 1 join restriction clauses
WARNING:  ParadeDB: Analyzing join clause of type T_OpExpr
WARNING:  ParadeDB: Analyzing 1 base restriction clauses for relation
WARNING:  ParadeDB: Extracting predicates for relation documents_join_test (rti 1)
WARNING:  ParadeDB: Extracted search query for documents_join_test: uses_search_operator=true
WARNING:  ParadeDB: Extracted 0 outer predicates, 1 inner predicates, 0 join conditions
WARNING:  ParadeDB: Found search predicates - outer: 0, inner: 1, bilateral: false
WARNING:  ParadeDB: Inner predicate for documents_join_test - uses_search: true
WARNING:  ParadeDB: Join path estimates - rows: 1, startup_cost: 100.00, total_cost: 100.01
WARNING:  ParadeDB: Created custom join path, adding to joinrel
WARNING:  ParadeDB: Planning custom join path with scanrelid = 0
WARNING:  ParadeDB: Join target list has 3 entries
ERROR:  variable not found in subplan target list
-- Cleanup
DROP TABLE documents_join_test CASCADE;
DROP TABLE files_join_test CASCADE; 
RESET paradedb.enable_custom_join;
