-- Test performance and edge cases for custom join execution
-- This test validates various scenarios and edge cases
-- Create the extension first
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Enable the custom join feature
SET paradedb.enable_custom_join = true;
-- Create test tables for performance testing
CREATE TABLE documents_perf (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    author TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE TABLE tags_perf (
    id SERIAL PRIMARY KEY,
    document_id INTEGER,
    tag_name TEXT,
    tag_value TEXT
);
-- Insert larger dataset for performance testing
INSERT INTO documents_perf (title, content, author) 
SELECT 
    'Document ' || i,
    'This is document number ' || i || ' with content about ' || 
    CASE (i % 5) 
        WHEN 0 THEN 'technology and innovation'
        WHEN 1 THEN 'science and research'
        WHEN 2 THEN 'business and finance'
        WHEN 3 THEN 'health and medicine'
        ELSE 'education and learning'
    END,
    'Author ' || ((i % 10) + 1)
FROM generate_series(1, 50) i;
INSERT INTO tags_perf (document_id, tag_name, tag_value)
SELECT 
    (i % 50) + 1,
    CASE (i % 4)
        WHEN 0 THEN 'category'
        WHEN 1 THEN 'priority'
        WHEN 2 THEN 'status'
        ELSE 'type'
    END,
    CASE (i % 3)
        WHEN 0 THEN 'high'
        WHEN 1 THEN 'medium'
        ELSE 'low'
    END
FROM generate_series(1, 100) i;
-- Create BM25 indexes
CREATE INDEX documents_perf_idx ON documents_perf USING bm25 (
    id,
    title,
    content,
    author
) WITH (
    key_field = 'id',
    text_fields = '{"title": {"tokenizer": {"type": "default"}}, "content": {"tokenizer": {"type": "default"}}, "author": {"tokenizer": {"type": "default"}}}'
);
CREATE INDEX tags_perf_idx ON tags_perf USING bm25 (
    id,
    document_id,
    tag_name,
    tag_value
) WITH (
    key_field = 'id',
    numeric_fields = '{"document_id": {"fast": true}}',
    text_fields = '{"tag_name": {"tokenizer": {"type": "default"}}, "tag_value": {"tokenizer": {"type": "default"}}}'
);
-- Test 1: Large result set join
SELECT COUNT(*) as total_matches
FROM documents_perf d
JOIN tags_perf t ON d.id = t.document_id
WHERE d.content @@@ 'technology OR science' AND t.tag_value @@@ 'high OR medium';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 total_matches 
---------------
            27
(1 row)

-- Test 2: Selective search (should return fewer results)
SELECT d.title, t.tag_name, t.tag_value
FROM documents_perf d
JOIN tags_perf t ON d.id = t.document_id
WHERE d.content @@@ 'innovation' AND t.tag_value @@@ 'high'
LIMIT 5;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 5
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 1 maps to table OID documents_perf
WARNING:      Found table OID documents_perf for RTI 1
WARNING:    Extracted outer table OID: documents_perf (RTI: 1)
WARNING:      RTI 2 maps to table OID tags_perf
WARNING:      Found table OID tags_perf for RTI 2
WARNING:    Extracted inner table OID: tags_perf (RTI: 2)
WARNING:    JOIN private data: 2 tables, limit: Some(5)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=3.3000000000000003
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 5
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 2 maps to table OID tags_perf
WARNING:      Found table OID tags_perf for RTI 2
WARNING:    Extracted outer table OID: tags_perf (RTI: 2)
WARNING:      RTI 1 maps to table OID documents_perf
WARNING:      Found table OID documents_perf for RTI 1
WARNING:    Extracted inner table OID: documents_perf (RTI: 1)
WARNING:    JOIN private data: 2 tables, limit: Some(5)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=3.3000000000000003
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === PLANNING JOIN COORDINATION CUSTOM PATH ===
WARNING:    rel relids: ["documents_perf", "tags_perf"]
WARNING:    tlist length: 3
WARNING:    Using original target list for JOIN coordination plan
WARNING:    Created CustomScan plan for JOIN coordination
WARNING:    startup_cost: 1, total_cost: 10, rows: 3.3000000000000003
ERROR:  variable not found in subplan target list
-- Test 3: Cross-product scenario (many-to-many)
SELECT COUNT(*) as cross_product_count
FROM documents_perf d
JOIN tags_perf t ON d.id = t.document_id
WHERE d.author @@@ 'Author' AND t.tag_name @@@ 'category OR priority';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 cross_product_count 
---------------------
                  50
(1 row)

-- Test 4: Empty result set
SELECT d.title, t.tag_value
FROM documents_perf d
JOIN tags_perf t ON d.id = t.document_id
WHERE d.content @@@ 'nonexistent_term' AND t.tag_value @@@ 'impossible_value';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 title | tag_value 
-------+-----------
(0 rows)

-- Test 5: Single result
SELECT d.title, d.author, t.tag_name
FROM documents_perf d
JOIN tags_perf t ON d.id = t.document_id
WHERE d.title @@@ 'Document 1' AND t.tag_value @@@ 'high'
LIMIT 1;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 1 maps to table OID documents_perf
WARNING:      Found table OID documents_perf for RTI 1
WARNING:    Extracted outer table OID: documents_perf (RTI: 1)
WARNING:      RTI 2 maps to table OID tags_perf
WARNING:      Found table OID tags_perf for RTI 2
WARNING:    Extracted inner table OID: tags_perf (RTI: 2)
WARNING:    JOIN private data: 2 tables, limit: Some(1)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=16.5
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 2 maps to table OID tags_perf
WARNING:      Found table OID tags_perf for RTI 2
WARNING:    Extracted outer table OID: tags_perf (RTI: 2)
WARNING:      RTI 1 maps to table OID documents_perf
WARNING:      Found table OID documents_perf for RTI 1
WARNING:    Extracted inner table OID: documents_perf (RTI: 1)
WARNING:    JOIN private data: 2 tables, limit: Some(1)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=16.5
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === PLANNING JOIN COORDINATION CUSTOM PATH ===
WARNING:    rel relids: ["documents_perf", "tags_perf"]
WARNING:    tlist length: 3
WARNING:    Using original target list for JOIN coordination plan
WARNING:    Created CustomScan plan for JOIN coordination
WARNING:    startup_cost: 1, total_cost: 10, rows: 16.5
ERROR:  variable not found in subplan target list
-- Test 6: EXPLAIN to see execution plan
EXPLAIN (COSTS OFF, BUFFERS OFF) 
SELECT d.title, t.tag_value
FROM documents_perf d
JOIN tags_perf t ON d.id = t.document_id
WHERE d.content @@@ 'technology' AND t.tag_value @@@ 'high';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=documents_perf, index_oid=documents_perf_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=tags_perf, index_oid=tags_perf_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Gather
   Workers Planned: 1
   ->  Parallel Hash Join
         Hash Cond: (t.document_id = d.id)
         ->  Parallel Custom Scan (ParadeDB Scan) on tags_perf t
               Table: tags_perf
               Index: tags_perf_idx
               Exec Method: NumericFastFieldExecState
               Fast Fields: document_id
               Scores: false
               Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"tag_value","query_string":"high","lenient":null,"conjunction_mode":null}}}}
         ->  Parallel Hash
               ->  Parallel Custom Scan (ParadeDB Scan) on documents_perf d
                     Table: documents_perf
                     Index: documents_perf_idx
                     Exec Method: NumericFastFieldExecState
                     Fast Fields: id
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"technology","lenient":null,"conjunction_mode":null}}}}
(19 rows)

-- Cleanup
DROP TABLE documents_perf CASCADE;
DROP TABLE tags_perf CASCADE;
RESET paradedb.enable_custom_join; 
