-- Test semi-join optimization strategies and effectiveness
-- This test validates the semi-join optimizer's strategy selection and performance
-- Create the extension first
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Enable the custom join feature
SET paradedb.enable_join_coordination = true;
-- Test 1: Small dataset - should use SearchFilter strategy
CREATE TABLE small_products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    description TEXT,
    category TEXT
);
CREATE TABLE small_reviews (
    id SERIAL PRIMARY KEY,
    product_id INTEGER,
    review_text TEXT,
    rating INTEGER
);
-- Insert small dataset (should trigger SearchFilter strategy)
INSERT INTO small_products (name, description, category) VALUES 
    ('Laptop Pro', 'High-performance laptop for professionals', 'electronics'),
    ('Wireless Mouse', 'Ergonomic wireless mouse with precision tracking', 'electronics'),
    ('Coffee Maker', 'Automatic drip coffee maker with timer', 'appliances');
INSERT INTO small_reviews (product_id, review_text, rating) VALUES 
    (1, 'Excellent laptop with great performance', 5),
    (1, 'Good build quality but expensive', 4),
    (2, 'Perfect mouse for daily use', 5),
    (3, 'Makes great coffee every morning', 4);
-- Create BM25 indexes
CREATE INDEX small_products_idx ON small_products USING bm25 (
    id, name, description, category
) WITH (
    key_field = 'id',
    text_fields = '{"name": {"tokenizer": {"type": "default"}}, "description": {"tokenizer": {"type": "default"}}, "category": {"tokenizer": {"type": "default"}}}'
);
CREATE INDEX small_reviews_idx ON small_reviews USING bm25 (
    id, product_id, review_text, rating
) WITH (
    key_field = 'id',
    numeric_fields = '{"product_id": {"fast": true}, "rating": {"fast": true}}',
    text_fields = '{"review_text": {"tokenizer": {"type": "default"}}}'
);
-- Test SearchFilter strategy (small result set)
SELECT p.name, r.review_text, r.rating
FROM small_products p
JOIN small_reviews r ON p.id = r.product_id
WHERE p.description @@@ 'laptop' AND r.review_text @@@ 'performance';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
    name    |               review_text               | rating 
------------+-----------------------------------------+--------
 Laptop Pro | Excellent laptop with great performance |      5
(1 row)

-- Test 2: Medium dataset - should use SortedArray strategy
CREATE TABLE medium_docs (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    author TEXT
);
CREATE TABLE medium_comments (
    id SERIAL PRIMARY KEY,
    doc_id INTEGER,
    comment_text TEXT,
    commenter TEXT
);
-- Insert medium dataset (1000-10000 range to trigger SortedArray)
INSERT INTO medium_docs (title, content, author)
SELECT 
    'Document ' || i,
    'Content about ' || 
    CASE (i % 10)
        WHEN 0 THEN 'technology and innovation'
        WHEN 1 THEN 'science and research'
        WHEN 2 THEN 'business and finance'
        WHEN 3 THEN 'health and medicine'
        WHEN 4 THEN 'education and learning'
        WHEN 5 THEN 'sports and fitness'
        WHEN 6 THEN 'travel and adventure'
        WHEN 7 THEN 'food and cooking'
        WHEN 8 THEN 'art and culture'
        ELSE 'music and entertainment'
    END || ' with detailed analysis and insights',
    'Author ' || ((i % 50) + 1)
FROM generate_series(1, 2000) i;
INSERT INTO medium_comments (doc_id, comment_text, commenter)
SELECT 
    (i % 2000) + 1,
    'Comment about ' ||
    CASE (i % 5)
        WHEN 0 THEN 'excellent analysis'
        WHEN 1 THEN 'interesting perspective'
        WHEN 2 THEN 'well researched'
        WHEN 3 THEN 'thought provoking'
        ELSE 'comprehensive coverage'
    END,
    'User' || ((i % 100) + 1)
FROM generate_series(1, 5000) i;
-- Create BM25 indexes
CREATE INDEX medium_docs_idx ON medium_docs USING bm25 (
    id, title, content, author
) WITH (
    key_field = 'id',
    text_fields = '{"title": {"tokenizer": {"type": "default"}}, "content": {"tokenizer": {"type": "default"}}, "author": {"tokenizer": {"type": "default"}}}'
);
CREATE INDEX medium_comments_idx ON medium_comments USING bm25 (
    id, doc_id, comment_text, commenter
) WITH (
    key_field = 'id',
    numeric_fields = '{"doc_id": {"fast": true}}',
    text_fields = '{"comment_text": {"tokenizer": {"type": "default"}}, "commenter": {"tokenizer": {"type": "default"}}}'
);
-- Test SortedArray strategy (medium result set)
SELECT COUNT(*) as total_matches
FROM medium_docs d
JOIN medium_comments c ON d.id = c.doc_id
WHERE d.content @@@ 'technology' AND c.comment_text @@@ 'excellent';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 total_matches 
---------------
             0
(1 row)

-- Test 3: Large dataset - should use BloomFilter strategy
CREATE TABLE large_articles (
    id SERIAL PRIMARY KEY,
    headline TEXT,
    body TEXT,
    category TEXT
);
CREATE TABLE large_tags (
    id SERIAL PRIMARY KEY,
    article_id INTEGER,
    tag_name TEXT,
    tag_category TEXT
);
-- Insert large dataset (>10000 to trigger BloomFilter)
INSERT INTO large_articles (headline, body, category)
SELECT 
    'Article ' || i || ': ' ||
    CASE (i % 20)
        WHEN 0 THEN 'Breaking News in Technology'
        WHEN 1 THEN 'Scientific Discovery Announced'
        WHEN 2 THEN 'Business Market Analysis'
        WHEN 3 THEN 'Health Research Findings'
        WHEN 4 THEN 'Educational Policy Changes'
        WHEN 5 THEN 'Sports Championship Results'
        WHEN 6 THEN 'Travel Destination Guide'
        WHEN 7 THEN 'Culinary Innovation Report'
        WHEN 8 THEN 'Art Exhibition Review'
        WHEN 9 THEN 'Music Festival Coverage'
        WHEN 10 THEN 'Environmental Impact Study'
        WHEN 11 THEN 'Political Development Update'
        WHEN 12 THEN 'Economic Forecast Analysis'
        WHEN 13 THEN 'Social Media Trends'
        WHEN 14 THEN 'Automotive Industry News'
        WHEN 15 THEN 'Real Estate Market Report'
        WHEN 16 THEN 'Fashion Week Highlights'
        WHEN 17 THEN 'Gaming Industry Updates'
        WHEN 18 THEN 'Cryptocurrency Analysis'
        ELSE 'General Interest Story'
    END,
    'Detailed article content about ' || 
    CASE (i % 15)
        WHEN 0 THEN 'artificial intelligence and machine learning applications'
        WHEN 1 THEN 'climate change and environmental sustainability'
        WHEN 2 THEN 'global economic trends and market dynamics'
        WHEN 3 THEN 'medical breakthroughs and healthcare innovations'
        WHEN 4 THEN 'educational technology and online learning'
        WHEN 5 THEN 'renewable energy and green technology'
        WHEN 6 THEN 'space exploration and astronomical discoveries'
        WHEN 7 THEN 'biotechnology and genetic research'
        WHEN 8 THEN 'cybersecurity and data protection'
        WHEN 9 THEN 'urban planning and smart cities'
        WHEN 10 THEN 'social justice and human rights'
        WHEN 11 THEN 'digital transformation and automation'
        WHEN 12 THEN 'sustainable agriculture and food security'
        WHEN 13 THEN 'mental health and wellness'
        ELSE 'innovation and technological advancement'
    END || ' with comprehensive analysis and expert opinions',
    CASE (i % 8)
        WHEN 0 THEN 'technology'
        WHEN 1 THEN 'science'
        WHEN 2 THEN 'business'
        WHEN 3 THEN 'health'
        WHEN 4 THEN 'education'
        WHEN 5 THEN 'environment'
        WHEN 6 THEN 'politics'
        ELSE 'general'
    END
FROM generate_series(1, 15000) i;
INSERT INTO large_tags (article_id, tag_name, tag_category)
SELECT 
    (i % 15000) + 1,
    CASE (i % 30)
        WHEN 0 THEN 'artificial-intelligence'
        WHEN 1 THEN 'machine-learning'
        WHEN 2 THEN 'climate-change'
        WHEN 3 THEN 'sustainability'
        WHEN 4 THEN 'economics'
        WHEN 5 THEN 'finance'
        WHEN 6 THEN 'healthcare'
        WHEN 7 THEN 'medicine'
        WHEN 8 THEN 'education'
        WHEN 9 THEN 'technology'
        WHEN 10 THEN 'renewable-energy'
        WHEN 11 THEN 'green-tech'
        WHEN 12 THEN 'space'
        WHEN 13 THEN 'astronomy'
        WHEN 14 THEN 'biotechnology'
        WHEN 15 THEN 'genetics'
        WHEN 16 THEN 'cybersecurity'
        WHEN 17 THEN 'data-protection'
        WHEN 18 THEN 'urban-planning'
        WHEN 19 THEN 'smart-cities'
        WHEN 20 THEN 'social-justice'
        WHEN 21 THEN 'human-rights'
        WHEN 22 THEN 'digital-transformation'
        WHEN 23 THEN 'automation'
        WHEN 24 THEN 'agriculture'
        WHEN 25 THEN 'food-security'
        WHEN 26 THEN 'mental-health'
        WHEN 27 THEN 'wellness'
        WHEN 28 THEN 'innovation'
        ELSE 'research'
    END,
    CASE (i % 5)
        WHEN 0 THEN 'primary'
        WHEN 1 THEN 'secondary'
        WHEN 2 THEN 'trending'
        WHEN 3 THEN 'featured'
        ELSE 'general'
    END
FROM generate_series(1, 45000) i;
-- Create BM25 indexes
CREATE INDEX large_articles_idx ON large_articles USING bm25 (
    id, headline, body, category
) WITH (
    key_field = 'id',
    text_fields = '{"headline": {"tokenizer": {"type": "default"}}, "body": {"tokenizer": {"type": "default"}}, "category": {"tokenizer": {"type": "default"}}}'
);
CREATE INDEX large_tags_idx ON large_tags USING bm25 (
    id, article_id, tag_name, tag_category
) WITH (
    key_field = 'id',
    numeric_fields = '{"article_id": {"fast": true}}',
    text_fields = '{"tag_name": {"tokenizer": {"type": "default"}}, "tag_category": {"tokenizer": {"type": "default"}}}'
);
-- Test BloomFilter strategy (large result set)
SELECT COUNT(*) as bloom_filter_matches
FROM large_articles a
JOIN large_tags t ON a.id = t.article_id
WHERE a.body @@@ 'artificial intelligence' AND t.tag_name @@@ 'machine-learning';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 bloom_filter_matches 
----------------------
                    0
(1 row)

-- Test 4: Semi-join effectiveness validation
-- Test filter pushdown effectiveness by comparing with and without optimization
-- Disable semi-join temporarily to compare
SET paradedb.enable_semi_join_optimization = false;
-- Run same query without semi-join optimization
SELECT COUNT(*) as without_semi_join
FROM small_products p
JOIN small_reviews r ON p.id = r.product_id
WHERE p.description @@@ 'laptop' AND r.review_text @@@ 'performance';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 without_semi_join 
-------------------
                 1
(1 row)

-- Re-enable semi-join optimization
SET paradedb.enable_semi_join_optimization = true;
-- Run same query with semi-join optimization
SELECT COUNT(*) as with_semi_join
FROM small_products p
JOIN small_reviews r ON p.id = r.product_id
WHERE p.description @@@ 'laptop' AND r.review_text @@@ 'performance';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 with_semi_join 
----------------
              1
(1 row)

-- Test 5: Edge cases for semi-join optimization
-- Test with no matching join keys (should handle gracefully)
SELECT COUNT(*) as no_join_matches
FROM small_products p
JOIN small_reviews r ON p.id = r.product_id
WHERE p.description @@@ 'nonexistent' AND r.review_text @@@ 'impossible';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 no_join_matches 
-----------------
               0
(1 row)

-- Test with very selective search (single result)
SELECT p.name, r.review_text
FROM small_products p
JOIN small_reviews r ON p.id = r.product_id
WHERE p.name @@@ 'Laptop Pro' AND r.review_text @@@ 'Excellent'
LIMIT 1;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 1 maps to table OID small_products
WARNING:      Found table OID small_products for RTI 1
WARNING:    Extracted outer table OID: small_products (RTI: 1)
WARNING:      RTI 2 maps to table OID small_reviews
WARNING:      Found table OID small_reviews for RTI 2
WARNING:    Extracted inner table OID: small_reviews (RTI: 2)
WARNING:    JOIN private data: 2 tables, limit: Some(1)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 2 maps to table OID small_reviews
WARNING:      Found table OID small_reviews for RTI 2
WARNING:    Extracted outer table OID: small_reviews (RTI: 2)
WARNING:      RTI 1 maps to table OID small_products
WARNING:      Found table OID small_products for RTI 1
WARNING:    Extracted inner table OID: small_products (RTI: 1)
WARNING:    JOIN private data: 2 tables, limit: Some(1)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === PLANNING JOIN COORDINATION CUSTOM PATH ===
WARNING:    rel relids: ["small_products", "small_reviews"]
WARNING:    tlist length: 2
WARNING:    Using original target list for JOIN coordination plan
WARNING:    Created CustomScan plan for JOIN coordination
WARNING:    startup_cost: 1, total_cost: 10, rows: 1
ERROR:  variable not found in subplan target list
-- Test with broad search (many results)
SELECT COUNT(*) as broad_search_count
FROM medium_docs d
JOIN medium_comments c ON d.id = c.doc_id
WHERE d.content @@@ 'and' AND c.comment_text @@@ 'about';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 broad_search_count 
--------------------
               5000
(1 row)

-- Test 6: Strategy selection validation
-- These queries should trigger different strategies based on estimated result sizes
-- Small selective query (SearchFilter)
EXPLAIN (COSTS OFF, BUFFERS OFF)
SELECT p.name, r.rating
FROM small_products p
JOIN small_reviews r ON p.id = r.product_id
WHERE p.description @@@ 'wireless precision' AND r.review_text @@@ 'perfect daily';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
                                                                                     QUERY PLAN                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Gather
   Workers Planned: 1
   ->  Parallel Hash Join
         Hash Cond: (r.product_id = p.id)
         ->  Parallel Custom Scan (ParadeDB Scan) on small_reviews r
               Table: small_reviews
               Index: small_reviews_idx
               Exec Method: NumericFastFieldExecState
               Fast Fields: product_id, rating
               Scores: false
               Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"review_text","query_string":"perfect daily","lenient":null,"conjunction_mode":null}}}}
         ->  Parallel Hash
               ->  Parallel Custom Scan (ParadeDB Scan) on small_products p
                     Table: small_products
                     Index: small_products_idx
                     Exec Method: NumericFastFieldExecState
                     Fast Fields: id
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"wireless precision","lenient":null,"conjunction_mode":null}}}}
(19 rows)

-- Medium selective query (SortedArray)
EXPLAIN (COSTS OFF, BUFFERS OFF)
SELECT COUNT(*)
FROM medium_docs d
JOIN medium_comments c ON d.id = c.doc_id
WHERE d.content @@@ 'technology innovation' AND c.comment_text @@@ 'excellent analysis';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
                                                                                           QUERY PLAN                                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize Aggregate
   ->  Gather
         Workers Planned: 2
         ->  Partial Aggregate
               ->  Parallel Hash Join
                     Hash Cond: (c.doc_id = d.id)
                     ->  Parallel Custom Scan (ParadeDB Scan) on medium_comments c
                           Table: medium_comments
                           Index: medium_comments_idx
                           Exec Method: NumericFastFieldExecState
                           Fast Fields: doc_id, junk(count)
                           Scores: false
                           Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"comment_text","query_string":"excellent analysis","lenient":null,"conjunction_mode":null}}}}
                     ->  Parallel Hash
                           ->  Parallel Custom Scan (ParadeDB Scan) on medium_docs d
                                 Table: medium_docs
                                 Index: medium_docs_idx
                                 Exec Method: NumericFastFieldExecState
                                 Fast Fields: id, junk(count)
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"technology innovation","lenient":null,"conjunction_mode":null}}}}
(21 rows)

-- Large selective query (BloomFilter)
EXPLAIN (COSTS OFF, BUFFERS OFF)
SELECT COUNT(*)
FROM large_articles a
JOIN large_tags t ON a.id = t.article_id
WHERE a.body @@@ 'machine learning applications' AND t.tag_name @@@ 'artificial-intelligence';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize Aggregate
   ->  Gather
         Workers Planned: 2
         ->  Partial Aggregate
               ->  Parallel Hash Join
                     Hash Cond: (t.article_id = a.id)
                     ->  Parallel Custom Scan (ParadeDB Scan) on large_tags t
                           Table: large_tags
                           Index: large_tags_idx
                           Exec Method: NumericFastFieldExecState
                           Fast Fields: article_id, junk(count)
                           Scores: false
                           Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"tag_name","query_string":"artificial-intelligence","lenient":null,"conjunction_mode":null}}}}
                     ->  Parallel Hash
                           ->  Parallel Custom Scan (ParadeDB Scan) on large_articles a
                                 Table: large_articles
                                 Index: large_articles_idx
                                 Exec Method: NumericFastFieldExecState
                                 Fast Fields: id, junk(count)
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"body","query_string":"machine learning applications","lenient":null,"conjunction_mode":null}}}}
(21 rows)

-- Test 7: Performance comparison
-- Measure execution time differences between strategies
-- Time small dataset join (SearchFilter)
SELECT COUNT(*) FROM small_products p JOIN small_reviews r ON p.id = r.product_id 
WHERE p.description @@@ 'laptop' AND r.review_text @@@ 'performance';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=small_products, index_oid=small_products_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=small_reviews, index_oid=small_reviews_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 count 
-------
     1
(1 row)

-- Time medium dataset join (SortedArray)
SELECT COUNT(*) FROM medium_docs d JOIN medium_comments c ON d.id = c.doc_id 
WHERE d.content @@@ 'technology' AND c.comment_text @@@ 'excellent';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 count 
-------
     0
(1 row)

-- Time large dataset join (BloomFilter)
SELECT COUNT(*) FROM large_articles a JOIN large_tags t ON a.id = t.article_id 
WHERE a.body @@@ 'artificial intelligence' AND t.tag_name @@@ 'machine-learning';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
 count 
-------
     0
(1 row)

-- Test 8: Filter pushdown validation
-- Verify that filters are actually being pushed down to Tantivy
-- Test with multiple filter keys
SELECT a.headline, t.tag_name
FROM large_articles a
JOIN large_tags t ON a.id = t.article_id
WHERE a.body @@@ 'technology innovation' AND t.tag_name @@@ 'artificial-intelligence OR machine-learning'
LIMIT 10;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=large_articles, index_oid=large_articles_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=large_tags, index_oid=large_tags_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 1 maps to table OID large_articles
WARNING:      Found table OID large_articles for RTI 1
WARNING:    Extracted outer table OID: large_articles (RTI: 1)
WARNING:      RTI 2 maps to table OID large_tags
WARNING:      Found table OID large_tags for RTI 2
WARNING:    Extracted inner table OID: large_tags (RTI: 2)
WARNING:    JOIN private data: 2 tables, limit: Some(10)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=89550
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 2 maps to table OID large_tags
WARNING:      Found table OID large_tags for RTI 2
WARNING:    Extracted outer table OID: large_tags (RTI: 2)
WARNING:      RTI 1 maps to table OID large_articles
WARNING:      Found table OID large_articles for RTI 1
WARNING:    Extracted inner table OID: large_articles (RTI: 1)
WARNING:    JOIN private data: 2 tables, limit: Some(10)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=89550
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === PLANNING JOIN COORDINATION CUSTOM PATH ===
WARNING:    rel relids: ["large_articles", "large_tags"]
WARNING:    tlist length: 2
WARNING:    Using original target list for JOIN coordination plan
WARNING:    Created CustomScan plan for JOIN coordination
WARNING:    startup_cost: 1, total_cost: 10, rows: 89550
ERROR:  variable not found in subplan target list
-- Test with complex search predicates
SELECT d.title, c.comment_text
FROM medium_docs d
JOIN medium_comments c ON d.id = c.doc_id
WHERE d.content @@@ 'technology AND innovation' AND c.comment_text @@@ 'excellent OR interesting'
LIMIT 5;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=medium_docs, index_oid=medium_docs_idx
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=medium_comments, index_oid=medium_comments_idx
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 5
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 1 maps to table OID medium_docs
WARNING:      Found table OID medium_docs for RTI 1
WARNING:    Extracted outer table OID: medium_docs (RTI: 1)
WARNING:      RTI 2 maps to table OID medium_comments
WARNING:      Found table OID medium_comments for RTI 2
WARNING:    Extracted inner table OID: medium_comments (RTI: 2)
WARNING:    JOIN private data: 2 tables, limit: Some(5)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=4000
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 5
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:      RTI 2 maps to table OID medium_comments
WARNING:      Found table OID medium_comments for RTI 2
WARNING:    Extracted outer table OID: medium_comments (RTI: 2)
WARNING:      RTI 1 maps to table OID medium_docs
WARNING:      Found table OID medium_docs for RTI 1
WARNING:    Extracted inner table OID: medium_docs (RTI: 1)
WARNING:    JOIN private data: 2 tables, limit: Some(5)
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=4000
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === PLANNING JOIN COORDINATION CUSTOM PATH ===
WARNING:    rel relids: ["medium_docs", "medium_comments"]
WARNING:    tlist length: 2
WARNING:    Using original target list for JOIN coordination plan
WARNING:    Created CustomScan plan for JOIN coordination
WARNING:    startup_cost: 1, total_cost: 10, rows: 4000
ERROR:  variable not found in subplan target list
-- Cleanup
DROP TABLE small_products CASCADE;
DROP TABLE small_reviews CASCADE;
DROP TABLE medium_docs CASCADE;
DROP TABLE medium_comments CASCADE;
DROP TABLE large_articles CASCADE;
DROP TABLE large_tags CASCADE;
RESET paradedb.enable_join_coordination;
RESET paradedb.enable_semi_join_optimization; 
