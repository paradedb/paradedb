-- Test pdb.agg() wrapped in functions and CTEs
-- This test verifies that pdb.agg() works correctly when:
-- 1. Wrapped in another function call (like jsonb_pretty)
-- 2. Used in a CTE
-- Cleanup if exists
DROP TABLE IF EXISTS fn_wrapped_agg_logs CASCADE;
-- First, create the test table
CREATE TABLE fn_wrapped_agg_logs (
    log_id SERIAL PRIMARY KEY,
    description TEXT,
    category TEXT,
    timestamp TIMESTAMP DEFAULT NOW()
);
-- Create a BM25 index with fast fields for aggregation
CREATE INDEX fn_wrapped_agg_logs_idx ON fn_wrapped_agg_logs
USING bm25 (log_id, description, category)
WITH (
    key_field = 'log_id',
    text_fields = '{
        "description": {},
        "category": {"fast": true}
    }'
);
-- Insert test data
INSERT INTO fn_wrapped_agg_logs (description, category) VALUES
    ('error in application', 'app'),
    ('error in database', 'db'),
    ('warning message', 'app'),
    ('error in network', 'network'),
    ('info message', 'app');
-- Test 1: Basic pdb.agg() with window function (should work)
-- Use paradedb.all() to force custom scan
-- Only select indexed fields (log_id is the key_field)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT log_id, description, category, pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER () 
FROM fn_wrapped_agg_logs
WHERE description @@@ paradedb.all()
ORDER BY log_id DESC LIMIT 3;
                                                                                                                                   QUERY PLAN                                                                                                                                   
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: log_id, description, category, (pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.fn_wrapped_agg_logs
         Output: log_id, description, category, pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text)
         Table: fn_wrapped_agg_logs
         Index: fn_wrapped_agg_logs_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: log_id desc
            TopN Limit: 3
         Full Index Scan: true
         Tantivy Query: {"with_index":{"query":"all"}}
(12 rows)

SELECT log_id, description, category, pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER () 
FROM fn_wrapped_agg_logs
WHERE description @@@ paradedb.all()
ORDER BY log_id DESC LIMIT 3;
 log_id |   description    | category |                                                                                     agg                                                                                      
--------+------------------+----------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      5 | info message     | app      | {"buckets": [{"key": "app", "doc_count": 3}, {"key": "db", "doc_count": 1}, {"key": "network", "doc_count": 1}], "sum_other_doc_count": 0, "doc_count_error_upper_bound": 0}
      4 | error in network | network  | {"buckets": [{"key": "app", "doc_count": 3}, {"key": "db", "doc_count": 1}, {"key": "network", "doc_count": 1}], "sum_other_doc_count": 0, "doc_count_error_upper_bound": 0}
      3 | warning message  | app      | {"buckets": [{"key": "app", "doc_count": 3}, {"key": "db", "doc_count": 1}, {"key": "network", "doc_count": 1}], "sum_other_doc_count": 0, "doc_count_error_upper_bound": 0}
(3 rows)

-- Test 2: pdb.agg() wrapped in jsonb_pretty
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT log_id, description, category, jsonb_pretty(pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER ()) 
FROM fn_wrapped_agg_logs
WHERE description @@@ paradedb.all()
ORDER BY log_id DESC LIMIT 3;
                                                                                                                                          QUERY PLAN                                                                                                                                          
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: log_id, description, category, (jsonb_pretty(pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text)))
   ->  Custom Scan (ParadeDB Scan) on public.fn_wrapped_agg_logs
         Output: log_id, description, category, jsonb_pretty(pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text))
         Table: fn_wrapped_agg_logs
         Index: fn_wrapped_agg_logs_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: log_id desc
            TopN Limit: 3
         Full Index Scan: true
         Tantivy Query: {"with_index":{"query":"all"}}
(12 rows)

SELECT log_id, description, category, jsonb_pretty(pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER ()) 
FROM fn_wrapped_agg_logs
WHERE description @@@ paradedb.all()
ORDER BY log_id DESC LIMIT 3;
 log_id |   description    | category |             jsonb_pretty             
--------+------------------+----------+--------------------------------------
      5 | info message     | app      | {                                   +
        |                  |          |     "buckets": [                    +
        |                  |          |         {                           +
        |                  |          |             "key": "app",           +
        |                  |          |             "doc_count": 3          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "db",            +
        |                  |          |             "doc_count": 1          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "network",       +
        |                  |          |             "doc_count": 1          +
        |                  |          |         }                           +
        |                  |          |     ],                              +
        |                  |          |     "sum_other_doc_count": 0,       +
        |                  |          |     "doc_count_error_upper_bound": 0+
        |                  |          | }
      4 | error in network | network  | {                                   +
        |                  |          |     "buckets": [                    +
        |                  |          |         {                           +
        |                  |          |             "key": "app",           +
        |                  |          |             "doc_count": 3          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "db",            +
        |                  |          |             "doc_count": 1          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "network",       +
        |                  |          |             "doc_count": 1          +
        |                  |          |         }                           +
        |                  |          |     ],                              +
        |                  |          |     "sum_other_doc_count": 0,       +
        |                  |          |     "doc_count_error_upper_bound": 0+
        |                  |          | }
      3 | warning message  | app      | {                                   +
        |                  |          |     "buckets": [                    +
        |                  |          |         {                           +
        |                  |          |             "key": "app",           +
        |                  |          |             "doc_count": 3          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "db",            +
        |                  |          |             "doc_count": 1          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "network",       +
        |                  |          |             "doc_count": 1          +
        |                  |          |         }                           +
        |                  |          |     ],                              +
        |                  |          |     "sum_other_doc_count": 0,       +
        |                  |          |     "doc_count_error_upper_bound": 0+
        |                  |          | }
(3 rows)

-- Test 3: pdb.agg() in CTE
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
WITH agg AS (
    SELECT log_id, description, category, pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER () as agg_result
    FROM fn_wrapped_agg_logs
    WHERE description @@@ paradedb.all()
    ORDER BY log_id DESC LIMIT 3
)
SELECT * FROM agg;
                                                                                                                                                                     QUERY PLAN                                                                                                                                                                     
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CTE Scan on agg
   Output: agg.log_id, agg.description, agg.category, agg.agg_result
   CTE agg
     ->  Limit
           Output: fn_wrapped_agg_logs.log_id, fn_wrapped_agg_logs.description, fn_wrapped_agg_logs.category, (pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text))
           ->  Custom Scan (ParadeDB Scan) on public.fn_wrapped_agg_logs
                 Output: fn_wrapped_agg_logs.log_id, fn_wrapped_agg_logs.description, fn_wrapped_agg_logs.category, pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text)
                 Table: fn_wrapped_agg_logs
                 Index: fn_wrapped_agg_logs_idx
                 Exec Method: TopNScanExecState
                 Scores: false
                    TopN Order By: log_id desc
                    TopN Limit: 3
                 Full Index Scan: true
                 Tantivy Query: {"with_index":{"query":"all"}}
(15 rows)

WITH agg AS (
    SELECT log_id, description, category, pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER () as agg_result
    FROM fn_wrapped_agg_logs
    WHERE description @@@ paradedb.all()
    ORDER BY log_id DESC LIMIT 3
)
SELECT * FROM agg;
 log_id |   description    | category |                                                                                  agg_result                                                                                  
--------+------------------+----------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      5 | info message     | app      | {"buckets": [{"key": "app", "doc_count": 3}, {"key": "db", "doc_count": 1}, {"key": "network", "doc_count": 1}], "sum_other_doc_count": 0, "doc_count_error_upper_bound": 0}
      4 | error in network | network  | {"buckets": [{"key": "app", "doc_count": 3}, {"key": "db", "doc_count": 1}, {"key": "network", "doc_count": 1}], "sum_other_doc_count": 0, "doc_count_error_upper_bound": 0}
      3 | warning message  | app      | {"buckets": [{"key": "app", "doc_count": 3}, {"key": "db", "doc_count": 1}, {"key": "network", "doc_count": 1}], "sum_other_doc_count": 0, "doc_count_error_upper_bound": 0}
(3 rows)

-- Test 4: pdb.agg() wrapped in CTE and then wrapped in function
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
WITH agg AS (
    SELECT log_id, description, category, pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER () as agg_result
    FROM fn_wrapped_agg_logs
    WHERE description @@@ paradedb.all()
    ORDER BY log_id DESC LIMIT 3
)
SELECT log_id, description, category, jsonb_pretty(agg_result) FROM agg;
                                                                                                                                                                     QUERY PLAN                                                                                                                                                                     
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CTE Scan on agg
   Output: agg.log_id, agg.description, agg.category, jsonb_pretty(agg.agg_result)
   CTE agg
     ->  Limit
           Output: fn_wrapped_agg_logs.log_id, fn_wrapped_agg_logs.description, fn_wrapped_agg_logs.category, (pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text))
           ->  Custom Scan (ParadeDB Scan) on public.fn_wrapped_agg_logs
                 Output: fn_wrapped_agg_logs.log_id, fn_wrapped_agg_logs.description, fn_wrapped_agg_logs.category, pdb.window_agg('{"entries":[{"Aggregate":{"Custom":{"agg_json":{"terms":{"field":"category"}},"filter":null,"indexrelid":0,"mvcc_visibility":"Enabled"}}}],"groupby":{"grouping_columns":[]},"uses_our_operator":false}'::text)
                 Table: fn_wrapped_agg_logs
                 Index: fn_wrapped_agg_logs_idx
                 Exec Method: TopNScanExecState
                 Scores: false
                    TopN Order By: log_id desc
                    TopN Limit: 3
                 Full Index Scan: true
                 Tantivy Query: {"with_index":{"query":"all"}}
(15 rows)

WITH agg AS (
    SELECT log_id, description, category, pdb.agg('{"terms": {"field": "category"}}'::jsonb) OVER () as agg_result
    FROM fn_wrapped_agg_logs
    WHERE description @@@ paradedb.all()
    ORDER BY log_id DESC LIMIT 3
)
SELECT log_id, description, category, jsonb_pretty(agg_result) FROM agg;
 log_id |   description    | category |             jsonb_pretty             
--------+------------------+----------+--------------------------------------
      5 | info message     | app      | {                                   +
        |                  |          |     "buckets": [                    +
        |                  |          |         {                           +
        |                  |          |             "key": "app",           +
        |                  |          |             "doc_count": 3          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "db",            +
        |                  |          |             "doc_count": 1          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "network",       +
        |                  |          |             "doc_count": 1          +
        |                  |          |         }                           +
        |                  |          |     ],                              +
        |                  |          |     "sum_other_doc_count": 0,       +
        |                  |          |     "doc_count_error_upper_bound": 0+
        |                  |          | }
      4 | error in network | network  | {                                   +
        |                  |          |     "buckets": [                    +
        |                  |          |         {                           +
        |                  |          |             "key": "app",           +
        |                  |          |             "doc_count": 3          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "db",            +
        |                  |          |             "doc_count": 1          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "network",       +
        |                  |          |             "doc_count": 1          +
        |                  |          |         }                           +
        |                  |          |     ],                              +
        |                  |          |     "sum_other_doc_count": 0,       +
        |                  |          |     "doc_count_error_upper_bound": 0+
        |                  |          | }
      3 | warning message  | app      | {                                   +
        |                  |          |     "buckets": [                    +
        |                  |          |         {                           +
        |                  |          |             "key": "app",           +
        |                  |          |             "doc_count": 3          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "db",            +
        |                  |          |             "doc_count": 1          +
        |                  |          |         },                          +
        |                  |          |         {                           +
        |                  |          |             "key": "network",       +
        |                  |          |             "doc_count": 1          +
        |                  |          |         }                           +
        |                  |          |     ],                              +
        |                  |          |     "sum_other_doc_count": 0,       +
        |                  |          |     "doc_count_error_upper_bound": 0+
        |                  |          | }
(3 rows)

-- =====================================================================
-- Non-Window Aggregates Wrapped in Functions (Issue #3757)
-- =====================================================================
SET paradedb.enable_aggregate_custom_scan TO on;
-- Add a numeric column for aggregate tests
ALTER TABLE fn_wrapped_agg_logs ADD COLUMN score INTEGER DEFAULT 50;
UPDATE fn_wrapped_agg_logs SET score = log_id * 10;
-- Recreate index with score column using v2 API
DROP INDEX fn_wrapped_agg_logs_idx;
CREATE INDEX fn_wrapped_agg_logs_idx ON fn_wrapped_agg_logs
USING bm25 (log_id, description, (category::pdb.literal), score)
WITH (key_field = 'log_id');
-- Test 5: pdb.agg() wrapped in jsonb_pretty (non-window)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT jsonb_pretty(pdb.agg('{"value_count": {"field": "score"}}'))
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
                                                                      QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.fn_wrapped_agg_logs
   Output: jsonb_pretty(pdb.agg_fn('pdb.agg'::text))
   Index: fn_wrapped_agg_logs_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"error","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: CUSTOM_AGG({"value_count":{"field":"score"}})
     Aggregate Definition: {"0":{"value_count":{"field":"score","missing":null}}}
(6 rows)

SELECT jsonb_pretty(pdb.agg('{"value_count": {"field": "score"}}'))
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
 jsonb_pretty 
--------------
 3
(1 row)

-- Test 6: pdb.agg() with -> operator (non-window)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT (pdb.agg('{"stats": {"field": "score"}}'))->'avg' as avg_score
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
                                                                      QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.fn_wrapped_agg_logs
   Output: (pdb.agg_fn('pdb.agg'::text) -> 'avg'::text)
   Index: fn_wrapped_agg_logs_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"error","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: CUSTOM_AGG({"stats":{"field":"score"}})
     Aggregate Definition: {"0":{"stats":{"field":"score","missing":null}}}
(6 rows)

SELECT (pdb.agg('{"stats": {"field": "score"}}'))->'avg' as avg_score
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
                                   avg_score                                    
--------------------------------------------------------------------------------
 {"avg": 23.333333333333332, "max": 40.0, "min": 10.0, "sum": 70.0, "count": 3}
(1 row)

-- Test 7: pdb.agg() wrapped in COALESCE (non-window)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT COALESCE(pdb.agg('{"value_count": {"field": "score"}}'), '{}')
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
                                                                      QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.fn_wrapped_agg_logs
   Output: COALESCE(pdb.agg_fn('pdb.agg'::text), '{}'::jsonb)
   Index: fn_wrapped_agg_logs_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"error","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: CUSTOM_AGG({"value_count":{"field":"score"}})
     Aggregate Definition: {"0":{"value_count":{"field":"score","missing":null}}}
(6 rows)

SELECT COALESCE(pdb.agg('{"value_count": {"field": "score"}}'), '{}')
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
    coalesce    
----------------
 {"value": 3.0}
(1 row)

-- Test 8: Nested wrappers - jsonb_pretty(COALESCE(pdb.agg(...)))
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT jsonb_pretty(COALESCE(pdb.agg('{"value_count": {"field": "score"}}'), '{}'))
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
                                                                      QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.fn_wrapped_agg_logs
   Output: jsonb_pretty(COALESCE(pdb.agg_fn('pdb.agg'::text), '{}'::jsonb))
   Index: fn_wrapped_agg_logs_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"error","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: CUSTOM_AGG({"value_count":{"field":"score"}})
     Aggregate Definition: {"0":{"value_count":{"field":"score","missing":null}}}
(6 rows)

SELECT jsonb_pretty(COALESCE(pdb.agg('{"value_count": {"field": "score"}}'), '{}'))
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
 jsonb_pretty 
--------------
 3
(1 row)

-- Test 9: Standard COUNT(*) wrapped in COALESCE (non-window)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT COALESCE(COUNT(*), 0)
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
                                                                      QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.fn_wrapped_agg_logs
   Output: COALESCE(pdb.agg_fn('COUNT(*)'::text), '0'::bigint)
   Index: fn_wrapped_agg_logs_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"error","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: COUNT(*)
     Aggregate Definition: {"0":{"value_count":{"field":"ctid","missing":null}}}
(6 rows)

SELECT COALESCE(COUNT(*), 0)
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
 coalesce 
----------
        3
(1 row)

-- Test 10: Standard SUM wrapped in COALESCE (non-window)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT COALESCE(SUM(score), 0)
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
                                                                      QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.fn_wrapped_agg_logs
   Output: COALESCE(pdb.agg_fn('SUM'::text), '0'::bigint)
   Index: fn_wrapped_agg_logs_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"error","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: SUM(score)
     Aggregate Definition: {"0":{"sum":{"field":"score","missing":null}}}
(6 rows)

SELECT COALESCE(SUM(score), 0)
FROM fn_wrapped_agg_logs
WHERE description @@@ 'error';
 coalesce 
----------
       70
(1 row)

RESET paradedb.enable_aggregate_custom_scan;
-- Cleanup
DROP TABLE fn_wrapped_agg_logs CASCADE;
