\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
CALL paradedb.create_bm25_test_table(
  schema_name => 'public',
  table_name => 'mock_items'
);
CREATE INDEX on mock_items USING bm25 (id, description, rating) WITH (key_field='id');
SELECT description, paradedb.score(id) * 2 AS score FROM mock_items WHERE description @@@ 'shoes' ORDER BY score DESC LIMIT 3;
     description     |       score       
---------------------+-------------------
 Generic shoes       | 5.754520416259766
 Sleek running shoes | 4.969813346862793
 White jogging shoes | 4.969813346862793
(3 rows)

SELECT description, rating, paradedb.score(id) * rating AS score FROM mock_items WHERE description @@@ 'shoes' OR rating > 2 ORDER BY score DESC, rating LIMIT 3;
     description     | rating |       score        
---------------------+--------+--------------------
 Sleek running shoes |      5 | 17.424533367156982
 Generic shoes       |      4 | 15.509040832519531
 White jogging shoes |      3 |  10.45472002029419
(3 rows)

SELECT description, rating, paradedb.score(id) AS score, paradedb.score(id) * rating AS score_times_rating FROM mock_items WHERE description @@@ 'shoes' OR rating > 2 ORDER BY score_times_rating DESC LIMIT 3;
     description     | rating |   score   | score_times_rating 
---------------------+--------+-----------+--------------------
 Sleek running shoes |      5 | 3.4849067 | 17.424533367156982
 Generic shoes       |      4 | 3.8772602 | 15.509040832519531
 White jogging shoes |      3 | 3.4849067 |  10.45472002029419
(3 rows)

SELECT description, rating, paradedb.score(id) AS score, paradedb.score(id) * rating AS score_times_rating FROM mock_items WHERE description @@@ 'shoes' OR rating > 2 ORDER BY score DESC LIMIT 3;
     description     | rating |   score   | score_times_rating 
---------------------+--------+-----------+--------------------
 Generic shoes       |      4 | 3.8772602 | 15.509040832519531
 Sleek running shoes |      5 | 3.4849067 | 17.424533367156982
 White jogging shoes |      3 | 3.4849067 |  10.45472002029419
(3 rows)

-- this should use TopNExecState
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT id, paradedb.score(id) AS score FROM mock_items WHERE description @@@ 'shoes' ORDER BY score DESC LIMIT 3;
                                                                         QUERY PLAN                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: mock_items_id_description_rating_idx
         Exec Method: TopNScanExecState
         Scores: true
            Sort Field: paradedb.score()
            Sort Direction: desc
            Top N Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"shoes","lenient":null,"conjunction_mode":null}}}}
(10 rows)

-- this should use NumericFastFieldExecState
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT id, paradedb.score(id) * 2 AS score FROM mock_items WHERE description @@@ 'shoes' ORDER BY score DESC LIMIT 3;
                                                                            QUERY PLAN                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Sort
         Sort Key: ((paradedb.score(id) * '2'::double precision)) DESC
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: mock_items_id_description_rating_idx
               Exec Method: NumericFastFieldExecState
               Fast Fields: id, paradedb.score()
               Scores: true
                  Top N Limit: 3
               Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"shoes","lenient":null,"conjunction_mode":null}}}}
(11 rows)

DROP TABLE mock_items;
