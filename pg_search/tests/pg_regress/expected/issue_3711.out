CREATE EXTENSION IF NOT EXISTS pg_search;
DROP TABLE IF EXISTS ints;
CREATE TABLE ints (id SERIAL PRIMARY KEY, i integer, j integer);
INSERT INTO ints (i, j) VALUES (1, 2), (2, 3), (3, 4);
CREATE INDEX idx_ints ON ints USING bm25 (id, ((i * 2)::pdb.alias('another_name'))) with (key_field = 'id');
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT * FROM ints WHERE (i * 2) = 2 AND id @@@ pdb.all();
                                                                       QUERY PLAN                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on ints
   Table: ints
   Index: idx_ints
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"all":{"field":"id"}}}},{"term":{"field":"another_name","value":2,"is_datetime":false}}]}}
(6 rows)

SELECT * FROM ints WHERE (i * 2) = 2 AND id @@@ pdb.all();
 id | i | j 
----+---+---
  1 | 1 | 2
(1 row)

DROP INDEX idx_ints;
CREATE OR REPLACE FUNCTION add_two_numbers(a integer, b integer)
RETURNS integer
LANGUAGE sql
IMMUTABLE
RETURNS NULL ON NULL INPUT
AS $$
    SELECT a + b;
$$;
CREATE INDEX idx_ints ON ints USING bm25 (id, (add_two_numbers(i, j)::pdb.alias('another_name'))) with (key_field = 'id');
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT * FROM ints WHERE add_two_numbers(i, j) = 5 AND id @@@ pdb.all();
                                                                       QUERY PLAN                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on ints
   Table: ints
   Index: idx_ints
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"all":{"field":"id"}}}},{"term":{"field":"another_name","value":5,"is_datetime":false}}]}}
(6 rows)

SELECT * FROM ints WHERE add_two_numbers(i, j) = 5 AND id @@@ pdb.all();
 id | i | j 
----+---+---
  2 | 2 | 3
(1 row)

DROP INDEX idx_ints;
DROP FUNCTION add_two_numbers;
DROP TABLE ints;
