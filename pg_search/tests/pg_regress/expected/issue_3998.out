\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
CREATE TABLE fieldnorms_test (
    id INT,
    content pdb.simple('fieldnorms=false')
);
INSERT INTO fieldnorms_test VALUES
(1, 'this is a test'::pdb.simple),
(2, ('this is a test ' || repeat('word ', 500))::pdb.simple);
CREATE INDEX fieldnorms_test_idx
ON fieldnorms_test
USING bm25(content)
WITH (key_field = 'id');
SELECT
    id,
    paradedb.score(id)
FROM fieldnorms_test
WHERE content @@@ 'test'
ORDER BY id;
 id |   score    
----+------------
  1 | 0.30770555
  2 | 0.30770555
(2 rows)

WITH scores AS (
    SELECT paradedb.score(id) as s
    FROM fieldnorms_test
    WHERE content @@@ 'test'
)
SELECT (MAX(s) - MIN(s)) < 0.00001 as scores_are_identical FROM scores;
 scores_are_identical 
----------------------
 t
(1 row)

DROP TABLE fieldnorms_test;
