-- Test use of the pg_ivm extension.
-- Setup
\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
CREATE EXTENSION IF NOT EXISTS pg_ivm;
DROP TABLE IF EXISTS test CASCADE;
CREATE TABLE test (
    id int,
    content TEXT
);
DROP TABLE IF EXISTS test_view CASCADE;
SELECT pgivm.create_immv('test_view', 'SELECT test.*, test.id + 1 as derived FROM test;');
 create_immv 
-------------
           0
(1 row)

CREATE INDEX test_search_idx ON test_view
USING bm25 (id, content)
WITH (key_field='id');
-- Validate that DML works with/without the custom scan.
SET paradedb.enable_custom_scan = false;
INSERT INTO test VALUES (1, 'pineapple sauce');
UPDATE test SET id = id;
SET paradedb.enable_custom_scan = true;
INSERT INTO test VALUES (2, 'mango sauce');
UPDATE test SET id = id;
-- Confirm that the indexed view is queryable.
SELECT * from test;
 id |     content     
----+-----------------
  1 | pineapple sauce
  2 | mango sauce
(2 rows)

SELECT * FROM test_view WHERE test_view.content @@@ 'pineapple';
 id |     content     | derived 
----+-----------------+---------
  1 | pineapple sauce |       2
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT * FROM test_view WHERE test_view.content @@@ 'pineapple';
                                                                      QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on test_view
   Table: test_view
   Index: test_search_idx
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"pineapple","lenient":null,"conjunction_mode":null}}}}
(6 rows)

DROP TABLE IF EXISTS test_view CASCADE;
DROP TABLE IF EXISTS test CASCADE;
\i common/common_cleanup.sql 
-- Reset parallel workers setting to default
RESET max_parallel_workers_per_gather;
RESET enable_indexscan;
RESET paradedb.enable_mixed_fast_field_exec;
SELECT 'Common tests cleanup complete' AS status; 
            status             
-------------------------------
 Common tests cleanup complete
(1 row)

