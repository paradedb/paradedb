-- Test cases demonstrating join support with @@@ operator and OR conditions
-- This test showcases what we can support and what we cannot with cross-table OR decomposition
-- Load the pg_search extension
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Setup test tables for join scenarios
DROP TABLE IF EXISTS authors;
DROP TABLE IF EXISTS books;
DROP TABLE IF EXISTS publishers;
CREATE TABLE authors (
    id SERIAL PRIMARY KEY,
    name TEXT,
    bio TEXT,
    birth_year INTEGER
);
CREATE TABLE books (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    author_id INTEGER REFERENCES authors(id),
    publication_year INTEGER,
    price DECIMAL(10,2)
);
CREATE TABLE publishers (
    id SERIAL PRIMARY KEY,
    name TEXT,
    description TEXT,
    founded_year INTEGER
);
-- Insert test data
INSERT INTO authors (name, bio, birth_year) VALUES
('John Smith', 'Famous science fiction author', 1960),
('Jane Doe', 'Mystery and thriller writer', 1970),
('Bob Johnson', 'Non-fiction technology author', 1965),
('Alice Brown', 'Romance novelist', 1975);
INSERT INTO books (title, content, author_id, publication_year, price) VALUES
('Future Technologies', 'artificial intelligence machine learning robots', 1, 2020, 29.99),
('The Mystery House', 'detective mystery crime investigation', 2, 2018, 19.99),
('Programming Guide', 'software development coding algorithms', 3, 2019, 39.99),
('Love in Paris', 'romance love story relationships', 4, 2021, 24.99),
('Space Adventure', 'science fiction space exploration aliens', 1, 2022, 34.99);
INSERT INTO publishers (name, description, founded_year) VALUES
('TechBooks Publishing', 'technology and science publications', 1990),
('Mystery House Press', 'crime and mystery novels', 1985),
('Romance World', 'romantic fiction publisher', 2000),
('Academic Press', 'educational and technical books', 1975);
-- Create BM25 indexes
CREATE INDEX authors_bm25_idx ON authors USING bm25 (id, name, bio) WITH (key_field = 'id');
CREATE INDEX books_bm25_idx ON books USING bm25 (id, title, content) WITH (key_field = 'id');
CREATE INDEX publishers_bm25_idx ON publishers USING bm25 (id, name, description) WITH (key_field = 'id');
-- =============================================================================
-- SUPPORTED CASES: Equi-joins with various join types
-- =============================================================================
SELECT '=== SUPPORTED CASES: Equi-joins with cross-table OR decomposition ===';
                               ?column?                                
-----------------------------------------------------------------------
 === SUPPORTED CASES: Equi-joins with cross-table OR decomposition ===
(1 row)

-- Test 1: INNER JOIN with equi-join condition
SELECT 'Test 1: INNER JOIN with equi-join condition';
                  ?column?                   
---------------------------------------------
 Test 1: INNER JOIN with equi-join condition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON a.id = b.author_id
WHERE (a.bio @@@ 'science' OR b.content @@@ 'technology')
ORDER BY author_score DESC, book_score DESC;
 author_name |     book_title      | author_score | book_score 
-------------+---------------------+--------------+------------
 John Smith  | Future Technologies |    1.1374958 |          0
 John Smith  | Space Adventure     |    1.1374958 |          0
(2 rows)

-- Test 2: LEFT JOIN with equi-join condition
SELECT 'Test 2: LEFT JOIN with equi-join condition';
                  ?column?                  
--------------------------------------------
 Test 2: LEFT JOIN with equi-join condition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
LEFT JOIN books b ON a.id = b.author_id
WHERE (a.bio @@@ 'mystery' OR b.content @@@ 'romance')
ORDER BY author_score DESC, book_score DESC;
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type LeftOuter and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 2
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type LeftOuter and condition type Complex - cannot decompose safely: 1 clauses for relation 2, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
 author_name |    book_title     | author_score | book_score 
-------------+-------------------+--------------+------------
 Jane Doe    | The Mystery House |              |           
 Alice Brown | Love in Paris     |              |           
(2 rows)

-- Test 3: RIGHT JOIN with equi-join condition
SELECT 'Test 3: RIGHT JOIN with equi-join condition';
                  ?column?                   
---------------------------------------------
 Test 3: RIGHT JOIN with equi-join condition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
RIGHT JOIN books b ON a.id = b.author_id
WHERE (a.bio @@@ 'fiction' OR b.content @@@ 'algorithms')
ORDER BY author_score DESC, book_score DESC;
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type LeftOuter and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 2
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type LeftOuter and condition type Complex - cannot decompose safely: 1 clauses for relation 2, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
 author_name |     book_title      | author_score | book_score 
-------------+---------------------+--------------+------------
 John Smith  | Future Technologies |              |           
 Bob Johnson | Programming Guide   |              |           
 John Smith  | Space Adventure     |              |           
(3 rows)

-- Test 4: Three-table equi-join (simulated with CROSS JOIN for simplicity)
SELECT 'Test 4: Three-table cross-table OR decomposition';
                     ?column?                     
--------------------------------------------------
 Test 4: Three-table cross-table OR decomposition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    p.name as publisher_name,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score,
    paradedb.score(p.id) as publisher_score
FROM authors a
INNER JOIN books b ON a.id = b.author_id
CROSS JOIN publishers p
WHERE (a.bio @@@ 'author' OR b.content @@@ 'science' OR p.description @@@ 'technology')
ORDER BY author_score DESC, book_score DESC, publisher_score DESC;
 author_name |     book_title      |    publisher_name    | author_score | book_score | publisher_score 
-------------+---------------------+----------------------+--------------+------------+-----------------
 John Smith  | Space Adventure     | TechBooks Publishing |    0.6548752 |   1.313046 |        1.172009
 John Smith  | Space Adventure     | Academic Press       |    0.6548752 |   1.313046 |               0
 John Smith  | Space Adventure     | Romance World        |    0.6548752 |   1.313046 |               0
 John Smith  | Space Adventure     | Mystery House Press  |    0.6548752 |   1.313046 |               0
 John Smith  | Future Technologies | TechBooks Publishing |    0.6548752 |          0 |        1.172009
 Bob Johnson | Programming Guide   | TechBooks Publishing |    0.6548752 |          0 |        1.172009
 Bob Johnson | Programming Guide   | Mystery House Press  |    0.6548752 |          0 |               0
 Bob Johnson | Programming Guide   | Romance World        |    0.6548752 |          0 |               0
 Bob Johnson | Programming Guide   | Academic Press       |    0.6548752 |          0 |               0
 John Smith  | Future Technologies | Romance World        |    0.6548752 |          0 |               0
 John Smith  | Future Technologies | Mystery House Press  |    0.6548752 |          0 |               0
 John Smith  | Future Technologies | Academic Press       |    0.6548752 |          0 |               0
 Alice Brown | Love in Paris       | TechBooks Publishing |            0 |          0 |        1.172009
 Jane Doe    | The Mystery House   | TechBooks Publishing |            0 |          0 |        1.172009
(14 rows)

-- Test 5: Multiple equi-join conditions (AND combined)
SELECT 'Test 5: Multiple equi-join conditions with AND';
                    ?column?                    
------------------------------------------------
 Test 5: Multiple equi-join conditions with AND
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON a.id = b.author_id AND a.birth_year < 2000
WHERE (a.bio @@@ 'writer' OR b.content @@@ 'mystery')
ORDER BY author_score DESC, book_score DESC;
 author_name |    book_title     | author_score | book_score 
-------------+-------------------+--------------+------------
 Jane Doe    | The Mystery House |              |  1.4398423
(1 row)

-- =============================================================================
-- UNSUPPORTED CASES: Non-equi joins and problematic conditions
-- =============================================================================
SELECT '=== UNSUPPORTED CASES: Non-equi joins and problematic conditions ===';
                               ?column?                               
----------------------------------------------------------------------
 === UNSUPPORTED CASES: Non-equi joins and problematic conditions ===
(1 row)

-- Test 6: CROSS JOIN (no join condition) - should be rejected
SELECT 'Test 6: CROSS JOIN with no join condition';
                 ?column?                  
-------------------------------------------
 Test 6: CROSS JOIN with no join condition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
CROSS JOIN books b
WHERE (a.bio @@@ 'author' OR b.content @@@ 'mystery')
ORDER BY author_score DESC, book_score DESC;
 author_name |     book_title      | author_score | book_score 
-------------+---------------------+--------------+------------
 Bob Johnson | The Mystery House   |    0.6548752 |  1.4398423
 John Smith  | The Mystery House   |    0.6548752 |  1.4398423
 John Smith  | Love in Paris       |    0.6548752 |          0
 John Smith  | Space Adventure     |    0.6548752 |          0
 Bob Johnson | Future Technologies |    0.6548752 |          0
 John Smith  | Future Technologies |    0.6548752 |          0
 John Smith  | Programming Guide   |    0.6548752 |          0
 Bob Johnson | Love in Paris       |    0.6548752 |          0
 Bob Johnson | Space Adventure     |    0.6548752 |          0
 Bob Johnson | Programming Guide   |    0.6548752 |          0
 Jane Doe    | The Mystery House   |            0 |  1.4398423
 Alice Brown | The Mystery House   |            0 |  1.4398423
(12 rows)

-- Test 7: INNER JOIN with non-equi condition (<, >, etc.)
SELECT 'Test 7: INNER JOIN with non-equi condition';
                  ?column?                  
--------------------------------------------
 Test 7: INNER JOIN with non-equi condition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON a.birth_year < b.publication_year
WHERE (a.bio @@@ 'fiction' OR b.content @@@ 'love')
ORDER BY author_score DESC, book_score DESC;
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 97, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 2
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 97, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 2, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
 author_name |     book_title      | author_score | book_score 
-------------+---------------------+--------------+------------
 John Smith  | Future Technologies |              |           
 John Smith  | The Mystery House   |              |           
 John Smith  | Programming Guide   |              |           
 John Smith  | Love in Paris       |              |           
 John Smith  | Space Adventure     |              |           
 Jane Doe    | Love in Paris       |              |           
 Bob Johnson | Future Technologies |              |           
 Bob Johnson | The Mystery House   |              |           
 Bob Johnson | Programming Guide   |              |           
 Bob Johnson | Love in Paris       |              |           
 Bob Johnson | Space Adventure     |              |           
 Alice Brown | Love in Paris       |              |           
(12 rows)

-- Test 8: INNER JOIN with complex non-equi condition
SELECT 'Test 8: INNER JOIN with complex non-equi condition';
                      ?column?                      
----------------------------------------------------
 Test 8: INNER JOIN with complex non-equi condition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON a.birth_year + 50 > b.publication_year
WHERE (a.bio @@@ 'writer' OR b.content @@@ 'programming')
ORDER BY author_score DESC, book_score DESC;
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 521, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 2
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 521, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 2, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
 author_name |    book_title     | author_score | book_score 
-------------+-------------------+--------------+------------
 Jane Doe    | The Mystery House |              |           
 Jane Doe    | Programming Guide |              |           
(2 rows)

-- Test 9: INNER JOIN with mixed equi and non-equi conditions
SELECT 'Test 9: INNER JOIN with mixed equi and non-equi conditions';
                          ?column?                          
------------------------------------------------------------
 Test 9: INNER JOIN with mixed equi and non-equi conditions
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON a.id = b.author_id AND a.birth_year < b.publication_year
WHERE (a.bio @@@ 'novelist' OR b.content @@@ 'adventure')
ORDER BY author_score DESC, book_score DESC;
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 97, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 2
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 97, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 2, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
 author_name |  book_title   | author_score | book_score 
-------------+---------------+--------------+------------
 Alice Brown | Love in Paris |              |           
(1 row)

-- Test 10: INNER JOIN with BETWEEN condition (range, non-equi)
SELECT 'Test 10: INNER JOIN with BETWEEN condition';
                  ?column?                  
--------------------------------------------
 Test 10: INNER JOIN with BETWEEN condition
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON b.price BETWEEN 20.00 AND 30.00 AND a.id = b.author_id
WHERE (a.bio @@@ 'author' OR b.content @@@ 'romance')
ORDER BY author_score DESC, book_score DESC;
 author_name |     book_title      | author_score | book_score 
-------------+---------------------+--------------+------------
 John Smith  | Future Technologies |    0.6548752 |           
 Alice Brown | Love in Paris       |            0 |           
(2 rows)

-- =============================================================================
-- EDGE CASES: Complex scenarios
-- =============================================================================
SELECT '=== EDGE CASES: Complex scenarios ===';
               ?column?                
---------------------------------------
 === EDGE CASES: Complex scenarios ===
(1 row)

-- Test 11: Self-join with equi-join condition
SELECT 'Test 11: Self-join with equi-join condition';
                  ?column?                   
---------------------------------------------
 Test 11: Self-join with equi-join condition
(1 row)

SELECT 
    a1.name as author1_name,
    a2.name as author2_name,
    paradedb.score(a1.id) as author1_score,
    paradedb.score(a2.id) as author2_score
FROM authors a1
INNER JOIN authors a2 ON a1.birth_year = a2.birth_year AND a1.id != a2.id
WHERE (a1.bio @@@ 'fiction' OR a2.bio @@@ 'mystery')
ORDER BY author1_score DESC, author2_score DESC;
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 518, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
WARNING:  analyze_join_condition_type: found 2 join conditions for target_rti 2
WARNING:  analyze_single_join_condition: clause type = T_OpExpr
WARNING:  analyze_single_join_condition: processing OpExpr
WARNING:  Analyzing OpExpr: operator OID = 518, is_equality = false
WARNING:  OpExpr is non-equi
WARNING:  analyze_join_condition_type: analyzed join condition, type = NonEqui
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 2, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: cross-table dependency - condition rejected
 author1_name | author2_name | author1_score | author2_score 
--------------+--------------+---------------+---------------
(0 rows)

-- Test 12: Multiple OR conditions with mixed search and non-search predicates
SELECT 'Test 12: Mixed search and non-search predicates in OR';
                       ?column?                        
-------------------------------------------------------
 Test 12: Mixed search and non-search predicates in OR
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON a.id = b.author_id
WHERE (a.bio @@@ 'science' OR b.content @@@ 'mystery' OR b.price > 25.00)
ORDER BY author_score DESC, book_score DESC;
WARNING:  analyze_join_condition_type: found 1 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 2 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: non-equi join condition - condition rejected
WARNING:  Skipping advanced OR decomposition: non-equi join condition detected
 author_name |     book_title      | author_score | book_score 
-------------+---------------------+--------------+------------
 Jane Doe    | The Mystery House   |              |  1.4398423
 John Smith  | Future Technologies |              |          0
 Bob Johnson | Programming Guide   |              |          0
 John Smith  | Space Adventure     |              |          0
(4 rows)

-- Test 13: Nested OR with AND conditions
SELECT 'Test 13: Nested OR with AND conditions';
                ?column?                
----------------------------------------
 Test 13: Nested OR with AND conditions
(1 row)

SELECT 
    a.name as author_name,
    b.title as book_title,
    paradedb.score(a.id) as author_score,
    paradedb.score(b.id) as book_score
FROM authors a
INNER JOIN books b ON a.id = b.author_id
WHERE ((a.bio @@@ 'author' AND a.birth_year > 1965) OR (b.content @@@ 'technology' AND b.publication_year > 2019))
ORDER BY author_score DESC, book_score DESC;
WARNING:  analyze_join_condition_type: found 1 join conditions for target_rti 1
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 1, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: non-equi join condition - condition rejected
WARNING:  Skipping advanced OR decomposition: non-equi join condition detected
WARNING:  analyze_join_condition_type: found 1 join conditions for target_rti 2
WARNING:  analyze_single_join_condition: clause type = T_BoolExpr
WARNING:  analyze_single_join_condition: processing BoolExpr
WARNING:  analyze_boolexpr_join_condition: boolop = 1
WARNING:  analyze_boolexpr_join_condition: OR_EXPR, returning Complex
WARNING:  analyze_join_condition_type: analyzed join condition, type = Complex
WARNING:  analyze_join_condition_type: returning Complex
WARNING:  Cross-table OR with join type Inner and condition type Complex - cannot decompose safely: 1 clauses for relation 2, 1 external clauses
WARNING:  Cross-table OR decomposition rejected: join condition type Complex is not an equi-join (only equi-joins are safe)
WARNING:  Condition classified as UNSAFE: non-equi join condition - condition rejected
WARNING:  Skipping advanced OR decomposition: non-equi join condition detected
 author_name | book_title | author_score | book_score 
-------------+------------+--------------+------------
(0 rows)

-- Clean up
DROP TABLE IF EXISTS publishers;
DROP TABLE IF EXISTS books;
DROP TABLE IF EXISTS authors; 
