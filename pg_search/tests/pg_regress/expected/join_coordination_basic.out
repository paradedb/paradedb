-- Test JOIN coordination execution method
-- This test validates that the JOIN coordination execution method is selected
-- for multi-table queries with search predicates and LIMIT clauses
-- Create the extension first
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Create test tables with BM25 indexes
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT
);
CREATE TABLE files (
    id SERIAL PRIMARY KEY,
    document_id INTEGER REFERENCES documents(id),
    filename TEXT,
    title TEXT
);
CREATE TABLE pages (
    id SERIAL PRIMARY KEY,
    file_id INTEGER REFERENCES files(id),
    page_number INTEGER,
    content TEXT
);
-- Create BM25 indexes
CALL paradedb.create_bm25_test_table(
    table_name => 'documents',
    schema_name => 'public'
);
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: false
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: false
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  The table public.documents already exists, skipping.
CALL paradedb.create_bm25_test_table(
    table_name => 'files',
    schema_name => 'public'
);
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: false
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: false
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  The table public.files already exists, skipping.
CALL paradedb.create_bm25_test_table(
    table_name => 'pages',
    schema_name => 'public'
);
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: false
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: false
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  The table public.pages already exists, skipping.
-- Create the actual BM25 indexes
CREATE INDEX documents_search_idx ON documents USING bm25 (id, title, content) WITH (key_field='id');
CREATE INDEX files_search_idx ON files USING bm25 (id, document_id, filename, title) WITH (key_field='id');
CREATE INDEX pages_search_idx ON pages USING bm25 (id, file_id, page_number, content) WITH (key_field='id');
-- Insert test data
INSERT INTO documents (title, content) VALUES
    ('Document 1', 'This is the first document about technology'),
    ('Document 2', 'This is the second document about science'),
    ('Document 3', 'This is the third document about research');
INSERT INTO files (document_id, filename, title) VALUES
    (1, 'file1.pdf', 'Technology Report'),
    (1, 'file2.pdf', 'Tech Analysis'),
    (2, 'file3.pdf', 'Science Paper'),
    (3, 'file4.pdf', 'Research Notes');
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
INSERT INTO pages (file_id, page_number, content) VALUES
    (1, 1, 'Introduction to technology trends'),
    (1, 2, 'Advanced technology concepts'),
    (2, 1, 'Technology analysis methodology'),
    (3, 1, 'Scientific research methods'),
    (4, 1, 'Research findings and conclusions');
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 has NO search operators
WARNING:  RTI 1 has BM25 index but NO search predicates
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=0, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=0, beneficial=false
-- Test 1: Single table query (should NOT use JOIN coordination)
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT d.id, d.title
FROM documents d
WHERE d.content @@@ 'technology'
LIMIT 10;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 1 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=1, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=1, beneficial=false
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: Some(10)
WARNING:    sort_direction: Some(None)
WARNING:    CHOSEN: TopN (limit=10, sort_direction=None)
                                                                         QUERY PLAN                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=10.00..10.05 rows=10 width=36) (actual time=0.887..0.909 rows=1 loops=1)
   Output: id, title
   Buffers: shared hit=37
   ->  Custom Scan (ParadeDB Scan) on public.documents d  (cost=10.00..10.05 rows=10 width=36) (actual time=0.886..0.907 rows=1 loops=1)
         Output: id, title
         Table: documents
         Index: documents_search_idx
         Segment Count: 1
         Heap Fetches: 1
         Virtual Tuples: 0
         Invisible Tuples: 0
         Exec Method: TopNScanExecState
         Scores: false
            Top N Limit: 10
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"technology","lenient":null,"conjunction_mode":null}}}}
         Human Readable Query: content:(technology)
         Buffers: shared hit=37
 Planning:
   Buffers: shared hit=42
 Planning Time: 1.827 ms
 Execution Time: 1.082 ms
(21 rows)

-- Test 2: Multi-table query with search predicates and LIMIT (should use JOIN coordination)
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT d.id, f.id, p.id
FROM documents d
JOIN files f ON d.id = f.document_id
JOIN pages p ON f.id = p.file_id
WHERE d.content @@@ 'technology' 
  AND f.title @@@ 'report'
  AND p.content @@@ 'introduction'
LIMIT 10;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 5 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Examining RTI 4: rtekind = 0
WARNING:  RTI 4 has BM25 index: table_oid=147646, index_oid=147661
WARNING:    Checking search predicates for RTI 4
WARNING:    RTI 4 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 4 FOUND search operator in restrict info 0
WARNING:  RTI 4 HAS search predicates! Total count now: 3
WARNING:  Examining RTI 5: rtekind = 2
WARNING:  RTI 5 is not a relation, skipping
WARNING:  Found 3 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=3, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=3, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 3
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 5 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Examining RTI 4: rtekind = 0
WARNING:  RTI 4 has BM25 index: table_oid=147646, index_oid=147661
WARNING:    Checking search predicates for RTI 4
WARNING:    RTI 4 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 4 FOUND search operator in restrict info 0
WARNING:  RTI 4 HAS search predicates! Total count now: 3
WARNING:  Examining RTI 5: rtekind = 2
WARNING:  RTI 5 is not a relation, skipping
WARNING:  Found 3 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=3, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=3, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 3
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 4 ===
WARNING:  Range table has 5 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Examining RTI 4: rtekind = 0
WARNING:  RTI 4 has BM25 index: table_oid=147646, index_oid=147661
WARNING:    Checking search predicates for RTI 4
WARNING:    RTI 4 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 4 FOUND search operator in restrict info 0
WARNING:  RTI 4 HAS search predicates! Total count now: 3
WARNING:  Examining RTI 5: rtekind = 2
WARNING:  RTI 5 is not a relation, skipping
WARNING:  Found 3 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 4: is_multi_table=true, count=3, beneficial=true ===
WARNING:  Setting multi-table info for RTI 4: multi_table=true, count=3, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 3
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: false
WARNING:    inner_has_search: true
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: false
WARNING:    inner_has_search: true
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === PLANNING JOIN COORDINATION CUSTOM PATH ===
WARNING:    rel relids: 0x7fc1f6870900
WARNING:    tlist length: 2
WARNING:    Created CustomScan plan for JOIN coordination
WARNING:    startup_cost: 1, total_cost: 10, rows: 1
ERROR:  variable not found in subplan target list
-- Test 3: Multi-table query without LIMIT (should NOT use JOIN coordination)
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT d.id, f.id
FROM documents d
JOIN files f ON d.id = f.document_id
WHERE d.content @@@ 'technology' 
  AND f.title @@@ 'report';
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Found 2 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=2, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=2, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 2
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: -1
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: false
WARNING:    SKIPPING: No LIMIT clause
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1020.02..1020.13 rows=1 width=8) (actual time=1.497..17.715 rows=1 loops=1)
   Output: d.id, f.id
   Workers Planned: 1
   Workers Launched: 1
   Buffers: shared hit=136
   ->  Parallel Hash Join  (cost=20.02..20.03 rows=1 width=8) (actual time=0.619..0.633 rows=0 loops=2)
         Output: d.id, f.id
         Inner Unique: true
         Hash Cond: (f.document_id = d.id)
         Buffers: shared hit=110
         Worker 0:  actual time=0.550..0.554 rows=0 loops=1
           Buffers: shared hit=62
         ->  Parallel Custom Scan (ParadeDB Scan) on public.files f  (cost=10.00..10.01 rows=1 width=8) (actual time=0.294..0.301 rows=1 loops=1)
               Output: f.id, f.document_id
               Table: files
               Index: files_search_idx
               Segment Count: 1
               Heap Fetches: 1
               Virtual Tuples: 0
               Invisible Tuples: 0
               Exec Method: NumericFastFieldExecState
               Fast Fields: document_id, id
               Scores: false
               Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"title","query_string":"report","lenient":null,"conjunction_mode":null}}}}
               Human Readable Query: title:(report)
               Buffers: shared hit=24
         ->  Parallel Hash  (cost=10.01..10.01 rows=1 width=4) (actual time=0.190..0.191 rows=0 loops=2)
               Output: d.id
               Buckets: 1024  Batches: 1  Memory Usage: 40kB
               Buffers: shared hit=24
               Worker 0:  actual time=0.019..0.019 rows=0 loops=1
               ->  Parallel Custom Scan (ParadeDB Scan) on public.documents d  (cost=10.00..10.01 rows=1 width=4) (actual time=0.347..0.354 rows=1 loops=1)
                     Output: d.id
                     Table: documents
                     Index: documents_search_idx
                     Segment Count: 1
                     Heap Fetches: 1
                     Virtual Tuples: 0
                     Invisible Tuples: 0
                     Exec Method: NumericFastFieldExecState
                     Fast Fields: id
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"technology","lenient":null,"conjunction_mode":null}}}}
                     Human Readable Query: content:(technology)
                     Buffers: shared hit=24
 Planning:
   Buffers: shared hit=14
 Planning Time: 2.780 ms
 Execution Time: 18.349 ms
(49 rows)

-- Test 4: Multi-table query with only one search predicate (should NOT use JOIN coordination)
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT d.id, f.id
FROM documents d
JOIN files f ON d.id = f.document_id
WHERE d.content @@@ 'technology'
LIMIT 10;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 3 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 0 base restrict info entries
WARNING:    RTI 2 has NO search operators
WARNING:  RTI 2 has BM25 index but NO search predicates
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=false, count=1, beneficial=false ===
WARNING:  Setting multi-table info for RTI 1: multi_table=false, count=1, beneficial=false
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: false
WARNING:    multi_table_search_count: 1
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: false
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: false
WARNING:    inner_has_search: true
WARNING:    SKIPPING: Not both relations have search predicates
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=1010.00..1038.33 rows=1 width=8) (actual time=0.814..17.926 rows=2 loops=1)
   Output: d.id, f.id
   Buffers: shared hit=51
   ->  Nested Loop  (cost=1010.00..1038.33 rows=1 width=8) (actual time=0.814..17.924 rows=2 loops=1)
         Output: d.id, f.id
         Join Filter: (d.id = f.document_id)
         Rows Removed by Join Filter: 2
         Buffers: shared hit=51
         ->  Gather  (cost=1010.00..1010.11 rows=1 width=4) (actual time=0.804..17.911 rows=1 loops=1)
               Output: d.id
               Workers Planned: 1
               Workers Launched: 1
               Buffers: shared hit=50
               ->  Parallel Custom Scan (ParadeDB Scan) on public.documents d  (cost=10.00..10.01 rows=1 width=4) (actual time=0.591..0.597 rows=0 loops=2)
                     Output: d.id
                     Table: documents
                     Index: documents_search_idx
                     Segment Count: 1
                     Heap Fetches: 1
                     Virtual Tuples: 0
                     Invisible Tuples: 0
                     Exec Method: NumericFastFieldExecState
                     Fast Fields: id
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"technology","lenient":null,"conjunction_mode":null}}}}
                     Human Readable Query: content:(technology)
                     Buffers: shared hit=37
                     Worker 0:  actual time=0.799..0.801 rows=0 loops=1
                       Buffers: shared hit=13
         ->  Seq Scan on public.files f  (cost=0.00..18.10 rows=810 width=8) (actual time=0.008..0.009 rows=4 loops=1)
               Output: f.id, f.document_id, f.filename, f.title
               Buffers: shared hit=1
 Planning:
   Buffers: shared hit=7
 Planning Time: 1.695 ms
 Execution Time: 18.373 ms
(36 rows)

-- Test 5: Verify that results are correct
SELECT d.title, f.filename, p.content
FROM documents d
JOIN files f ON d.id = f.document_id
JOIN pages p ON f.id = p.file_id
WHERE d.content @@@ 'technology' 
  AND f.title @@@ 'report'
  AND p.content @@@ 'introduction'
LIMIT 10;
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 1 ===
WARNING:  Range table has 5 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Examining RTI 4: rtekind = 0
WARNING:  RTI 4 has BM25 index: table_oid=147646, index_oid=147661
WARNING:    Checking search predicates for RTI 4
WARNING:    RTI 4 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 4 FOUND search operator in restrict info 0
WARNING:  RTI 4 HAS search predicates! Total count now: 3
WARNING:  Examining RTI 5: rtekind = 2
WARNING:  RTI 5 is not a relation, skipping
WARNING:  Found 3 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 1: is_multi_table=true, count=3, beneficial=true ===
WARNING:  Setting multi-table info for RTI 1: multi_table=true, count=3, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 3
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 2 ===
WARNING:  Range table has 5 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Examining RTI 4: rtekind = 0
WARNING:  RTI 4 has BM25 index: table_oid=147646, index_oid=147661
WARNING:    Checking search predicates for RTI 4
WARNING:    RTI 4 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 4 FOUND search operator in restrict info 0
WARNING:  RTI 4 HAS search predicates! Total count now: 3
WARNING:  Examining RTI 5: rtekind = 2
WARNING:  RTI 5 is not a relation, skipping
WARNING:  Found 3 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 2: is_multi_table=true, count=3, beneficial=true ===
WARNING:  Setting multi-table info for RTI 2: multi_table=true, count=3, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 3
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN COORDINATION DEBUG: analyze_multi_table_search_scenario called for RTI 4 ===
WARNING:  Range table has 5 entries
WARNING:  Examining RTI 1: rtekind = 0
WARNING:  RTI 1 has BM25 index: table_oid=147623, index_oid=147659
WARNING:    Checking search predicates for RTI 1
WARNING:    RTI 1 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 1 FOUND search operator in restrict info 0
WARNING:  RTI 1 HAS search predicates! Total count now: 1
WARNING:  Examining RTI 2: rtekind = 0
WARNING:  RTI 2 has BM25 index: table_oid=147632, index_oid=147660
WARNING:    Checking search predicates for RTI 2
WARNING:    RTI 2 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 2 FOUND search operator in restrict info 0
WARNING:  RTI 2 HAS search predicates! Total count now: 2
WARNING:  Examining RTI 3: rtekind = 2
WARNING:  RTI 3 is not a relation, skipping
WARNING:  Examining RTI 4: rtekind = 0
WARNING:  RTI 4 has BM25 index: table_oid=147646, index_oid=147661
WARNING:    Checking search predicates for RTI 4
WARNING:    RTI 4 has 1 base restrict info entries
WARNING:      Checking restrict info 0
WARNING:    RTI 4 FOUND search operator in restrict info 0
WARNING:  RTI 4 HAS search predicates! Total count now: 3
WARNING:  Examining RTI 5: rtekind = 2
WARNING:  RTI 5 is not a relation, skipping
WARNING:  Found 3 tables with search predicates - marking as beneficial JOINs
WARNING:  === FINAL RESULT for RTI 4: is_multi_table=true, count=3, beneficial=true ===
WARNING:  Setting multi-table info for RTI 4: multi_table=true, count=3, beneficial=true
WARNING:  === CHOOSING EXECUTION METHOD ===
WARNING:    limit: None
WARNING:    sort_direction: None
WARNING:  === CHECKING JOIN COORDINATION ELIGIBILITY ===
WARNING:    is_multi_table_search: true
WARNING:    multi_table_search_count: 3
WARNING:    has_limit: false
WARNING:    limit_value: None
WARNING:    has_beneficial_joins: true
WARNING:    sort_direction: None
WARNING:    DISABLED: JOIN coordination now handled at JOIN planning level
WARNING:    CHOSEN: FastFieldNumeric
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: true
WARNING:    has_limit: true
WARNING:    CREATING JOIN COORDINATION PATH!
WARNING:    Creating custom path: startup_cost=1, total_cost=10, rows=1
WARNING:    CustomPath created successfully
WARNING:    SUCCESSFULLY CREATED JOIN COORDINATION PATH!
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: false
WARNING:    inner_has_search: true
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: false
WARNING:    inner_has_search: true
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === JOIN PATHLIST CALLBACK ===
WARNING:    jointype: 0
WARNING:    limit_tuples: 10
WARNING:    outer_has_search: true
WARNING:    inner_has_search: false
WARNING:    SKIPPING: Not both relations have search predicates
WARNING:  === PLANNING JOIN COORDINATION CUSTOM PATH ===
WARNING:    rel relids: 0x7fc1b827dad8
WARNING:    tlist length: 3
WARNING:    Created CustomScan plan for JOIN coordination
WARNING:    startup_cost: 1, total_cost: 10, rows: 1
ERROR:  variable not found in subplan target list
-- Cleanup
DROP TABLE pages;
DROP TABLE files;
DROP TABLE documents; 
