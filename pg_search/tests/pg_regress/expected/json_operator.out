\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
DROP TABLE IF EXISTS mock_items;
CALL paradedb.create_bm25_test_table(
  schema_name => 'public',
  table_name => 'mock_items'
);
INSERT INTO mock_items (description, metadata) VALUES
('Computer mouse', '{"price": 100, "color": "white", "in_stock": true}'),
('Keyboard', '{"price": 150, "color": "black", "in_stock": false}'),
('Monitor', '{"price": 200, "color": "white", "in_stock": true}'),
('Printer', '{"price": 120, "color": "black", "in_stock": false}'),
('Speaker', '{"price": 80, "color": "white", "in_stock": true}');
-- CASE 1: fast, default tokenizer
CREATE INDEX search_idx ON mock_items
USING bm25 (id, description, category, rating, in_stock, created_at, metadata, weight_range)
WITH (key_field='id', json_fields='{"metadata": {"fast": true}}');
-- basic FTS query
SELECT description, metadata->>'color' as color, metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white'
ORDER BY id LIMIT 5;
     description      | color | price 
----------------------+-------+-------
 White jogging shoes  | White | 
 Refreshing face wash | White | 
 Anti-aging serum     | White | 
 Computer mouse       | white | 100
 Monitor              | white | 200
(5 rows)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color' as color, metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white'
ORDER BY id LIMIT 5;
                                                                          QUERY PLAN                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"metadata.color","query_string":"white","lenient":null,"conjunction_mode":null}}}}
(9 rows)

-- should be pushed down
SELECT description, metadata->>'color' as color, metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND (metadata->>'price')::int > 100
ORDER BY id LIMIT 5;
 description | color | price 
-------------+-------+-------
 Monitor     | white | 200
(1 row)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color' as color, metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND (metadata->>'price')::int > 100
ORDER BY id LIMIT 5;
                                                                                                                                           QUERY PLAN                                                                                                                                            
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"parse_with_field":{"field":"metadata.color","query_string":"white","lenient":null,"conjunction_mode":null}}}},{"range":{"field":"metadata.price","lower_bound":{"excluded":100},"upper_bound":null,"is_datetime":false}}]}}
(9 rows)

-- should be pushed down
SELECT description, metadata->>'color', metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND metadata->>'price' IS NOT NULL
ORDER BY id LIMIT 5;
  description   | ?column? | price 
----------------+----------+-------
 Computer mouse | white    | 100
 Monitor        | white    | 200
 Speaker        | white    | 80
(3 rows)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color', metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND metadata->>'price' IS NOT NULL
ORDER BY id LIMIT 5;
                                                                                                         QUERY PLAN                                                                                                         
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"parse_with_field":{"field":"metadata.color","query_string":"white","lenient":null,"conjunction_mode":null}}}},{"exists":{"field":"metadata.price"}}]}}
(9 rows)

-- should be pushed down
SELECT description, metadata->>'color', metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND metadata->>'price' IS NULL
ORDER BY id LIMIT 5;
     description      | ?column? | price 
----------------------+----------+-------
 White jogging shoes  | White    | 
 Refreshing face wash | White    | 
 Anti-aging serum     | White    | 
(3 rows)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color', metadata->>'price' as price FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND metadata->>'price' IS NULL
ORDER BY id LIMIT 5;
                                                                                                                              QUERY PLAN                                                                                                                              
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"parse_with_field":{"field":"metadata.color","query_string":"white","lenient":null,"conjunction_mode":null}}}},{"boolean":{"must":["all"],"must_not":[{"exists":{"field":"metadata.price"}}]}}]}}
(9 rows)

-- should be pushed down
SELECT description, metadata->>'color', metadata->>'in_stock' as in_stock FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND (metadata->>'in_stock')::boolean IS TRUE
ORDER BY id LIMIT 5;
  description   | ?column? | in_stock 
----------------+----------+----------
 Computer mouse | white    | true
 Monitor        | white    | true
 Speaker        | white    | true
(3 rows)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color', metadata->>'in_stock' as in_stock FROM mock_items
WHERE metadata->>'color' @@@ 'white' AND (metadata->>'in_stock')::boolean IS TRUE
ORDER BY id LIMIT 5;
                                                                                                                          QUERY PLAN                                                                                                                          
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Tantivy Query: {"boolean":{"must":[{"with_index":{"query":{"parse_with_field":{"field":"metadata.color","query_string":"white","lenient":null,"conjunction_mode":null}}}},{"term":{"field":"metadata.in_stock","value":true,"is_datetime":false}}]}}
(9 rows)

-- without keyword, we can't push down to term set
SELECT description, metadata->>'color', metadata->>'in_stock' as in_stock FROM mock_items
WHERE metadata->>'color' IN ('white', 'black') AND id @@@ paradedb.all()
ORDER BY id LIMIT 5;
  description   | ?column? | in_stock 
----------------+----------+----------
 Computer mouse | white    | true
 Keyboard       | black    | false
 Monitor        | white    | true
 Printer        | black    | false
 Speaker        | white    | true
(5 rows)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color', metadata->>'in_stock' as in_stock FROM mock_items
WHERE metadata->>'color' IN ('white', 'black') AND id @@@ paradedb.all()
ORDER BY id LIMIT 5;
                                                                                                                QUERY PLAN                                                                                                                
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Full Index Scan: true
         Tantivy Query: {"boolean":{"must":[{"heap_filter":{"indexed_query":{"boolean":{"must":[{"with_index":{"query":"all"}}]}},"field_filters":[{"heap_filter":"((metadata ->> 'color'::text) = ANY ('{white,black}'::text[]))"}]}}]}}
(10 rows)

-- should be pushed down
SELECT description, metadata->>'color', metadata->>'price' as price FROM mock_items
WHERE (metadata->>'price')::int IN (80, 100, 120) AND id @@@ paradedb.all()
ORDER BY id LIMIT 5;
  description   | ?column? | price 
----------------+----------+-------
 Computer mouse | white    | 100
 Printer        | black    | 120
 Speaker        | white    | 80
(3 rows)

EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color', metadata->>'price' as price FROM mock_items
WHERE (metadata->>'price')::int IN (80, 100, 120) AND id @@@ paradedb.all()
ORDER BY id LIMIT 5;
                                                                                                                                      QUERY PLAN                                                                                                                                       
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Tantivy Query: {"boolean":{"must":[{"term_set":{"terms":[{"field":"metadata.price","value":80,"is_datetime":false},{"field":"metadata.price","value":100,"is_datetime":false},{"field":"metadata.price","value":120,"is_datetime":false}]}},{"with_index":{"query":"all"}}]}}
(9 rows)

-- CASE 2: fast, keyword tokenizer
ALTER INDEX search_idx SET (json_fields='{"metadata": {"fast": true, "tokenizer": {"type": "keyword"}}}');
REINDEX INDEX search_idx;
-- with keyword, should be pushed down
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT description, metadata->>'color', metadata->>'in_stock' as in_stock FROM mock_items
WHERE metadata->>'color' IN ('white', 'black') AND id @@@ paradedb.all()
ORDER BY id LIMIT 5;
                                                                                                             QUERY PLAN                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 5
         Tantivy Query: {"boolean":{"must":[{"term_set":{"terms":[{"field":"metadata.color","value":"white","is_datetime":false},{"field":"metadata.color","value":"black","is_datetime":false}]}},{"with_index":{"query":"all"}}]}}
(9 rows)

DROP TABLE mock_items;
