-- Test multiple stopwords languages per field
-- This tests the feature allowing multiple language stopwords filters
-- Test paradedb.tokenizer() with stopwords_languages parameter (array form)
SELECT * FROM paradedb.tokenize(
    paradedb.tokenizer('default', stopwords_languages => ARRAY['English', 'French']),
    'the quick fox and le renard et'
);
 token  | position 
--------+----------
 quick  |        1
 fox    |        2
 renard |        5
(3 rows)

-- Test paradedb.tokenizer() with single stopwords_language parameter (backwards compatible)
SELECT * FROM paradedb.tokenize(
    paradedb.tokenizer('default', stopwords_language => 'English'),
    'the quick fox and'
);
 token | position 
-------+----------
 quick |        1
 fox   |        2
(2 rows)

-- Clean up
DROP TABLE IF EXISTS test_multi_stopwords;
-- Create test table
CREATE TABLE test_multi_stopwords (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test data with English and French content
INSERT INTO test_multi_stopwords (content) VALUES
    ('the quick brown fox'),           -- "the" is English stopword
    ('le renard brun rapide'),          -- "le" is French stopword  
    ('and the lazy dog'),               -- "and", "the" are English stopwords
    ('et le chien paresseux'),          -- "et", "le" are French stopwords
    ('quick renard'),                   -- no stopwords
    ('fox chien'),                      -- no stopwords
    ('the quick fox le renard and et lazy paresseux');  -- Mixed English/French
-- Create index with multiple stopwords languages (English and French)
CREATE INDEX idx_multi_stopwords_bm25 ON test_multi_stopwords
    USING bm25 (id, content)
    WITH (
    key_field = 'id',
    text_fields ='{
        "content": {"tokenizer": {"type": "default", "stopwords_language": ["English", "French"]}}
    }'
);
-- Test 1: Search for English stopword "the" - should return 0 rows (filtered)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'the';
                                                                   QUERY PLAN                                                                   
------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_multi_stopwords
   Output: id, content
   Table: test_multi_stopwords
   Index: idx_multi_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"the","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'the';
 id | content 
----+---------
(0 rows)

-- Test 2: Search for French stopword "le" - should return 0 rows (filtered)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'le';
                                                                  QUERY PLAN                                                                   
-----------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_multi_stopwords
   Output: id, content
   Table: test_multi_stopwords
   Index: idx_multi_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"le","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'le';
 id | content 
----+---------
(0 rows)

-- Test 3: Search for non-stopword "quick" - should return rows
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'quick';
                                                                    QUERY PLAN                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_multi_stopwords
   Output: id, content
   Table: test_multi_stopwords
   Index: idx_multi_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"quick","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'quick';
 id |                    content                    
----+-----------------------------------------------
  1 | the quick brown fox
  5 | quick renard
  7 | the quick fox le renard and et lazy paresseux
(3 rows)

-- Test 4: Search for non-stopword "renard" - should return rows  
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'renard';
                                                                    QUERY PLAN                                                                     
---------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_multi_stopwords
   Output: id, content
   Table: test_multi_stopwords
   Index: idx_multi_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"renard","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'renard';
 id |                    content                    
----+-----------------------------------------------
  2 | le renard brun rapide
  5 | quick renard
  7 | the quick fox le renard and et lazy paresseux
(3 rows)

-- Test 5: Search for English stopword "and" - should return 0 rows (filtered)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'and';
                                                                   QUERY PLAN                                                                   
------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_multi_stopwords
   Output: id, content
   Table: test_multi_stopwords
   Index: idx_multi_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"and","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'and';
 id | content 
----+---------
(0 rows)

-- Test 6: Search for French stopword "et" - should return 0 rows (filtered)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'et';
                                                                  QUERY PLAN                                                                   
-----------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_multi_stopwords
   Output: id, content
   Table: test_multi_stopwords
   Index: idx_multi_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"et","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_multi_stopwords WHERE content @@@ 'et';
 id | content 
----+---------
(0 rows)

-- Clean up
DROP TABLE test_multi_stopwords;
-- Test single language still works (backwards compatibility)
DROP TABLE IF EXISTS test_single_stopwords;
CREATE TABLE test_single_stopwords (
    id SERIAL PRIMARY KEY,
    content TEXT
);
INSERT INTO test_single_stopwords (content) VALUES
    ('the quick brown fox and the lazy dog');
-- Single language as string (backwards compatible)
CREATE INDEX idx_single_stopwords_bm25 ON test_single_stopwords
    USING bm25 (id, content)
    WITH (
    key_field = 'id',
    text_fields ='{
        "content": {"tokenizer": {"type": "default", "stopwords_language": "English"}}
    }'
);
-- Test: Search for "the" (English stopword) - should return 0 rows
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_single_stopwords WHERE content @@@ 'the';
                                                                   QUERY PLAN                                                                   
------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_single_stopwords
   Output: id, content
   Table: test_single_stopwords
   Index: idx_single_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"the","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_single_stopwords WHERE content @@@ 'the';
 id | content 
----+---------
(0 rows)

-- Test: Search for "quick" (not a stopword) - should return 1 row
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT id, content FROM test_single_stopwords WHERE content @@@ 'quick';
                                                                    QUERY PLAN                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.test_single_stopwords
   Output: id, content
   Table: test_single_stopwords
   Index: idx_single_stopwords_bm25
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"content","query_string":"quick","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT id, content FROM test_single_stopwords WHERE content @@@ 'quick';
 id |               content                
----+--------------------------------------
  1 | the quick brown fox and the lazy dog
(1 row)

-- Clean up
DROP TABLE test_single_stopwords;
