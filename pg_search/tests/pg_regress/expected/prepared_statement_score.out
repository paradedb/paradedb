\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
CALL paradedb.create_bm25_test_table(
  schema_name => 'public',
  table_name => 'mock_items'
);
-- Test prepared statements with pdb.score() function
-- This test verifies that scores work correctly in both custom and generic plans
-- Create the BM25 index
CREATE INDEX search_idx ON mock_items
USING bm25 (id, description)
WITH (key_field='id');
-- Test 1: Basic prepared statement with score and parameter
PREPARE search_desc(text, int) AS
SELECT
  id,
  description,
  paradedb.score(id) AS score
FROM mock_items
WHERE description @@@ $1        
AND $2 = 0
ORDER BY score DESC
LIMIT 5;
-- Show plan for first execution (custom plan)
EXPLAIN (COSTS OFF)
EXECUTE search_desc('keyboard', 0);
                                                                          QUERY PLAN                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: true
            TopN Order By: pdb.score() desc
            TopN Limit: 5
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"keyboard","lenient":null,"conjunction_mode":null}}}}
(9 rows)

-- Execute with custom plan (first 5 times by default)
EXECUTE search_desc('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

EXECUTE search_desc('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

EXECUTE search_desc('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

EXECUTE search_desc('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

EXECUTE search_desc('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

-- Show plan for 6th execution (should be generic plan by default, but still use Custom Scan)
EXPLAIN (COSTS OFF)
EXECUTE search_desc('keyboard', 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($2 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 5
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

-- 6th execution should use generic plan (by default)
-- This should still return scores, not NULL
EXECUTE search_desc('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

DEALLOCATE search_desc;
-- Test 2: Force generic plan to ensure it works
SET plan_cache_mode = force_generic_plan;
PREPARE search_generic(text, int) AS
SELECT
  id,
  description,
  paradedb.score(id) AS score
FROM mock_items
WHERE description @@@ $1        
AND $2 = 0
ORDER BY score DESC
LIMIT 5;
-- Show plan with forced generic plan (should still use Custom Scan)
EXPLAIN (COSTS OFF)
EXECUTE search_generic('keyboard', 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($2 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 5
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

-- This should return scores even with forced generic plan
EXECUTE search_generic('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

-- Test different search terms
EXECUTE search_generic('shoes', 0);
 id |     description     |   score   
----+---------------------+-----------
  5 | Generic shoes       | 2.8772602
  3 | Sleek running shoes | 2.4849067
  4 | White jogging shoes | 2.4849067
(3 rows)

DEALLOCATE search_generic;
-- Reset plan cache mode
RESET plan_cache_mode;
-- Test 3: Prepared statement without the parameter condition
-- This serves as a control to ensure basic functionality works
PREPARE search_simple(text) AS
SELECT
  id,
  description,
  paradedb.score(id) AS score
FROM mock_items
WHERE description @@@ $1        
ORDER BY score DESC
LIMIT 5;
SET plan_cache_mode = force_generic_plan;
-- Show plan for simple query with generic plan
EXPLAIN (COSTS OFF)
EXECUTE search_simple('keyboard');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on mock_items
         Table: mock_items
         Index: search_idx
         Exec Method: TopNScanExecState
         Scores: true
            TopN Order By: pdb.score() desc
            TopN Limit: 5
         Tantivy Query: {"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}}
(9 rows)

EXECUTE search_simple('keyboard');
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

DEALLOCATE search_simple;
-- Test 4: Using new pdb schema
PREPARE search_pdb(text, int) AS
SELECT
  id,
  description,
  pdb.score(id) AS score
FROM mock_items
WHERE description @@@ $1        
AND $2 = 0
ORDER BY score DESC
LIMIT 5;
SET plan_cache_mode = force_generic_plan;
-- Show plan with pdb.score() function
EXPLAIN (COSTS OFF)
EXECUTE search_pdb('keyboard', 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($2 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 5
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

EXECUTE search_pdb('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

DEALLOCATE search_pdb;
-- Test 5: Verify filter conditions are actually applied in generic plans
-- This tests that $2 = 0 is properly evaluated, not just ignored
SET plan_cache_mode = force_generic_plan;
PREPARE test_filter(text, int) AS
SELECT
  id,
  description,
  pdb.score(id) AS score
FROM mock_items
WHERE description @@@ $1
AND $2 = 0
ORDER BY score DESC
LIMIT 10;
-- When $2 = 0, should return results
EXPLAIN (COSTS OFF)
EXECUTE test_filter('shoes', 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($2 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 10
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

EXECUTE test_filter('shoes', 0);
 id |     description     |   score   
----+---------------------+-----------
  5 | Generic shoes       | 2.8772602
  3 | Sleek running shoes | 2.4849067
  4 | White jogging shoes | 2.4849067
(3 rows)

-- When $2 = 1, should return NO results (filter condition fails)
EXPLAIN (COSTS OFF)
EXECUTE test_filter('shoes', 1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($2 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 10
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

EXECUTE test_filter('shoes', 1);
 id | description | score 
----+-------------+-------
(0 rows)

-- When $2 = 0 again, should return results
EXPLAIN (COSTS OFF)
EXECUTE test_filter('keyboard', 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($2 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 10
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

EXECUTE test_filter('keyboard', 0);
 id |       description        |   score   
----+--------------------------+-----------
  2 | Plastic Keyboard         | 3.2668595
  1 | Ergonomic metal keyboard | 2.8213787
(2 rows)

DEALLOCATE test_filter;
-- Test 6: More complex filter with multiple parameters
PREPARE test_complex(text, int, int) AS
SELECT
  id,
  description,
  rating,
  pdb.score(id) AS score
FROM mock_items
WHERE description @@@ $1
AND rating > $2
AND $3 = 0
ORDER BY score DESC
LIMIT 10;
-- Should return shoes with rating > 3
EXPLAIN (COSTS OFF)
EXECUTE test_complex('shoes', 3, 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($3 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 10
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 521 :opfuncid 147 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 3 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varnosyn 1 :varattnosyn 3 :location -1} {PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1}) :location -1}","description":"OpExpr with operator OID 521"}]}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 3 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

EXECUTE test_complex('shoes', 3, 0);
 id |     description     | rating |   score   
----+---------------------+--------+-----------
  5 | Generic shoes       |      4 | 2.8772602
  3 | Sleek running shoes |      5 | 2.4849067
(2 rows)

-- Should return NO results (filter $3 = 1 fails)
EXPLAIN (COSTS OFF)
EXECUTE test_complex('shoes', 3, 1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($3 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 10
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 521 :opfuncid 147 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 3 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varnosyn 1 :varattnosyn 3 :location -1} {PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1}) :location -1}","description":"OpExpr with operator OID 521"}]}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 3 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

EXECUTE test_complex('shoes', 3, 1);
 id | description | rating | score 
----+-------------+--------+-------
(0 rows)

-- Should return shoes with rating > 2
EXPLAIN (COSTS OFF)
EXECUTE test_complex('shoes', 2, 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Result
         One-Time Filter: ($3 = 0)
         ->  Custom Scan (ParadeDB Scan) on mock_items
               Table: mock_items
               Index: search_idx
               Exec Method: TopNScanExecState
               Scores: true
                  TopN Order By: pdb.score() desc
                  TopN Limit: 10
               Tantivy Query: {"boolean":{"must":[{"postgres_expression":{"expr":{"expr_desc":"{FUNCEXPR :funcid 171079 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 2205 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 88 -91 2 0 0 0 0 0 ]} {FUNCEXPR :funcid 170928 :funcresulttype 170849 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({CONST :consttype 170845 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 16 [ 64 0 0 0 107 100 101 115 99 114 105 112 116 105 111 110 ]} {PARAM :paramkind 0 :paramid 1 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull true :location -1 :constvalue <>}) :location -1}) :location -1}"}}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 521 :opfuncid 147 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 3 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varnosyn 1 :varattnosyn 3 :location -1} {PARAM :paramkind 0 :paramid 2 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1}) :location -1}","description":"OpExpr with operator OID 521"}]}},{"heap_filter":{"indexed_query":"all","field_filters":[{"expr_node":"{OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({PARAM :paramkind 0 :paramid 3 :paramtype 23 :paramtypmod -1 :paramcollid 0 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"OpExpr with PARAM nodes (OID 96)"}]}}]}}
(11 rows)

EXECUTE test_complex('shoes', 2, 0);
 id |     description     | rating |   score   
----+---------------------+--------+-----------
  5 | Generic shoes       |      4 | 2.8772602
  3 | Sleek running shoes |      5 | 2.4849067
  4 | White jogging shoes |      3 | 2.4849067
(3 rows)

DEALLOCATE test_complex;
DROP TABLE mock_items;
\i common/common_cleanup.sql
-- Reset parallel workers setting to default
RESET max_parallel_workers_per_gather;
RESET enable_indexscan;
RESET paradedb.enable_mixed_fast_field_exec;
SELECT 'Common tests cleanup complete' AS status; 
            status             
-------------------------------
 Common tests cleanup complete
(1 row)

