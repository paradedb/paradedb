\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
DROP TABLE IF EXISTS pushdown;
CREATE TABLE pushdown(
    id SERIAL PRIMARY KEY,
    description TEXT[]
);
INSERT INTO pushdown(description)
VALUES (ARRAY['dog', 'cat', 'bird']), (ARRAY['fox', 'rabbit', 'squirrel']);
-- Test with literal tokenizer (should pushdown)
CREATE INDEX pushdown_idx ON pushdown USING bm25 (
    id, (description::pdb.literal)
) WITH (key_field = 'id');
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT * FROM pushdown
WHERE 'dog' = ANY(description)
AND id @@@ pdb.all()
ORDER BY id
LIMIT 10;
                                                                            QUERY PLAN                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on pushdown
         Table: pushdown
         Index: pushdown_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 10
         Tantivy Query: {"boolean":{"must":[{"term":{"field":"description","value":"dog","is_datetime":false}},{"with_index":{"query":{"all":{"field":"id"}}}}]}}
(9 rows)

SELECT * FROM pushdown
WHERE 'dog' = ANY(description)
AND id @@@ pdb.all()
ORDER BY id
LIMIT 10;
 id |  description   
----+----------------
  1 | {dog,cat,bird}
(1 row)

DROP INDEX pushdown_idx;
-- Test with non-literal tokenizer (should NOT pushdown)
CREATE INDEX pushdown_idx ON pushdown USING bm25 (
    id, description
) WITH (key_field = 'id');
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT * FROM pushdown
WHERE 'dog' = ANY(description)
AND id @@@ pdb.all()
ORDER BY id
LIMIT 10;
                                                                                                          QUERY PLAN                                                                                                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on pushdown
         Table: pushdown
         Index: pushdown_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: id asc
            TopN Limit: 10
         Tantivy Query: {"boolean":{"must":[{"heap_filter":{"indexed_query":{"boolean":{"must":[{"with_index":{"query":{"all":{"field":"id"}}}}]}},"field_filters":[{"heap_filter":"('dog'::text = ANY (description))"}]}}]}}
(9 rows)

DROP TABLE pushdown;
