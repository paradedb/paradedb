-- EXACT customer reproduction using their actual list_id patterns
-- Based on their sample data showing specific non-sequential list IDs
\set VERBOSITY verbose
\timing on
-- Match their EXACT settings
SET work_mem = '4MB';
Time: 0.206 ms
SET maintenance_work_mem = '60GB';
Time: 0.053 ms
SET max_parallel_workers = 120;
Time: 0.064 ms
SET max_parallel_maintenance_workers = 30;
Time: 0.072 ms
DROP TABLE IF EXISTS contacts_companies_combined_full_old CASCADE;
Time: 0.261 ms
CREATE TABLE contacts_companies_combined_full_old (
    contact_id INT PRIMARY KEY,
    list_id INT[]
);
Time: 11.477 ms
\echo '=== EXACT CUSTOMER REPRODUCTION ==='
=== EXACT CUSTOMER REPRODUCTION ===
\echo 'Using their actual list_id patterns from production'
Using their actual list_id patterns from production
\echo 'Arrays with 6000-6700 elements of non-sequential IDs'
Arrays with 6000-6700 elements of non-sequential IDs
\echo ''

-- Insert data matching their EXACT pattern:
-- Real list IDs from their sample: {407,434,638,769,1184,1202,1781,2012,2108,2270,...}
-- These are NOT random, they're specific list IDs with gaps
INSERT INTO contacts_companies_combined_full_old (contact_id, list_id)
SELECT
    i,
    -- Create arrays with similar pattern to customer's data:
    -- Non-sequential IDs with gaps, matching their distribution
    ARRAY(
        SELECT DISTINCT (
            CASE
                WHEN j % 10 = 0 THEN j * 100 + (random() * 50)::int
                WHEN j % 5 = 0 THEN j * 20 + (random() * 10)::int
                ELSE j * 3 + (random() * 5)::int
            END
        )::int
        FROM generate_series(1,
            -- Vary array sizes like customer: 6600-6700 elements
            6600 + (i % 100)
        ) j
        ORDER BY 1
        LIMIT 6700
    )
FROM generate_series(1, 100000) i;
Time: 219101.169 ms (03:39.101)
\echo ''

\echo 'Sample of actual data (matching customer format):'
Sample of actual data (matching customer format):
SELECT
    array_length(list_id, 1) as array_len,
    pg_column_size(list_id) as size_bytes,
    list_id[1:10] as first_10_elements
FROM contacts_companies_combined_full_old
WHERE list_id IS NOT NULL
ORDER BY array_length(list_id, 1) DESC
LIMIT 10;
 array_len | size_bytes |       first_10_elements        
-----------+------------+--------------------------------
      6400 |      25620 | {5,9,11,14,20,26,28,36,40,42}
      6400 |      25620 | {3,10,14,19,22,24,28,36,37,41}
      6400 |      25620 | {4,8,12,14,22,25,27,34,41,46}
      6398 |      25612 | {5,6,10,15,22,23,26,29,36,43}
      6397 |      25608 | {5,8,12,13,22,23,25,29,35,40}
      6395 |      25600 | {6,11,12,16,21,22,25,31,38,39}
      6395 |      25600 | {4,9,14,16,22,24,28,31,34,40}
      6395 |      25600 | {5,8,10,15,21,23,25,29,33,38}
      6394 |      25596 | {3,9,10,16,21,22,28,29,38,41}
      6394 |      25596 | {4,7,11,17,18,22,29,32,35,37}
(10 rows)

Time: 8912.829 ms (00:08.913)
\echo ''

\echo 'Memory settings:'
Memory settings:
SHOW work_mem;
 work_mem 
----------
 4MB
(1 row)

Time: 0.648 ms
SHOW maintenance_work_mem;
 maintenance_work_mem 
----------------------
 60GB
(1 row)

Time: 0.116 ms
SHOW max_parallel_workers;
 max_parallel_workers 
----------------------
 120
(1 row)

Time: 0.118 ms
SHOW max_parallel_maintenance_workers;
 max_parallel_maintenance_workers 
----------------------------------
 30
(1 row)

Time: 0.114 ms
\echo ''

\echo '=== CREATING INDEX (EXACT CUSTOMER COMMAND) ==='
=== CREATING INDEX (EXACT CUSTOMER COMMAND) ===
\echo 'Using their exact CREATE INDEX statement'
Using their exact CREATE INDEX statement
\echo ''

-- EXACT command from customer
CREATE INDEX contacts_companies_combined_full_old_list_id_idx ON contacts_companies_combined_full_old
USING bm25 (contact_id, list_id)
WITH (
    key_field=contact_id,
    numeric_fields='{"list_id": {"indexed": true}}'
);
Time: 1272158.396 ms (21:12.158)
\echo ''

\echo '=== INDEX CREATED SUCCESSFULLY ==='
=== INDEX CREATED SUCCESSFULLY ===
\echo 'If you see this, the bug was NOT reproduced'
If you see this, the bug was NOT reproduced
