-- Test for SegmentedTopKExec: per-segment Top-K pruning using term ordinals.
-- Verifies that SegmentedTopKExec is injected below TantivyLookupExec for
-- ORDER BY <deferred_string_column> LIMIT K queries, and that results are correct.
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
CREATE EXTENSION IF NOT EXISTS pg_search;
-- =============================================================================
-- SETUP
-- =============================================================================
DROP TABLE IF EXISTS stk_files CASCADE;
DROP TABLE IF EXISTS stk_documents CASCADE;
CREATE TABLE stk_documents (
    id TEXT PRIMARY KEY,
    category TEXT
);
-- 10 documents. 5 belong to PROJECT_ALPHA (scattered).
INSERT INTO stk_documents (id, category) VALUES
('doc-01', 'PROJECT_ALPHA design review'),
('doc-02', 'BETA_GROUP budget overview'),
('doc-03', 'PROJECT_ALPHA roadmap planning'),
('doc-04', 'GAMMA_DIVISION quarterly report'),
('doc-05', 'PROJECT_ALPHA feedback notes'),
('doc-06', 'BETA_GROUP marketing strategy'),
('doc-07', 'PROJECT_ALPHA milestone tracker'),
('doc-08', 'GAMMA_DIVISION vendor evaluation'),
('doc-09', 'PROJECT_ALPHA resource allocation'),
('doc-10', 'BETA_GROUP incident response');
CREATE TABLE stk_files (
    id SERIAL PRIMARY KEY,
    document_id TEXT,
    title TEXT,
    content TEXT
);
-- 100 files, each referencing one of the 10 documents via round-robin.
-- Titles are 'File Title NNN' for deterministic sort order.
INSERT INTO stk_files (document_id, title, content)
SELECT
    'doc-' || LPAD(((i - 1) % 10 + 1)::TEXT, 2, '0'),
    'File Title ' || LPAD(i::TEXT, 3, '0'),
    'file content for item ' || i
FROM generate_series(1, 100) AS i;
CREATE INDEX stk_documents_bm25_idx ON stk_documents USING bm25 (id, category)
WITH (key_field = 'id');
CREATE INDEX stk_files_bm25_idx ON stk_files USING bm25 (id, document_id, title, content)
WITH (key_field = 'id', text_fields = '{"document_id": {"tokenizer": {"type": "keyword"}, "fast": true}, "title": {"fast": true}, "content": {"fast": true}}');
SET paradedb.enable_join_custom_scan = on;
-- =============================================================================
-- TEST 1: ASC LIMIT — SegmentedTopKExec should appear in plan
-- =============================================================================
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC
LIMIT 3;
                                                                                             QUERY PLAN                                                                                             
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: f.id, f.title
   ->  Custom Scan (ParadeDB Join Scan)
         Output: f.id, f.title
         Join Type: Inner
         Relation 0: stk_documents (d)
         Relation 1: stk_files (f)
         Join Cond: f.document_id = d.id
         Limit: 3
         Order By: f.title asc
         DataFusion Physical Plan: 
           : ProjectionExec: expr=[NULL as col_1, title@2 as col_2, ctid_3@0 as ctid_3, ctid_1@1 as ctid_1]
           :   SortExec: TopK(fetch=3), expr=[title@2 ASC NULLS LAST], preserve_partitioning=[false]
           :     TantivyLookupExec: decode=[title]
           :       SegmentedTopKExec: sort_col=title, k=3, direction=ASC
           :         HashJoinExec: mode=CollectLeft, join_type=Inner, on=[(id@1, document_id@1)], projection=[ctid_3@0, ctid_1@2, title@4]
           :           ProjectionExec: expr=[ctid@0 as ctid_3, id@1 as id]
           :             CooperativeExec
           :               PgSearchScan: segments=1, query={"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"PROJECT_ALPHA","lenient":null,"conjunction_mode":null}}}}
           :           ProjectionExec: expr=[ctid@0 as ctid_1, document_id@1 as document_id, title@2 as title]
           :             CooperativeExec
           :               PgSearchScan: segments=1, dynamic_filters=2, query="all"
(22 rows)

SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC
LIMIT 3;
 id |     title      
----+----------------
  1 | File Title 001
  3 | File Title 003
  5 | File Title 005
(3 rows)

-- =============================================================================
-- TEST 2: DESC LIMIT — verify DESC direction works
-- =============================================================================
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title DESC
LIMIT 3;
                                                                                             QUERY PLAN                                                                                             
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: f.id, f.title
   ->  Custom Scan (ParadeDB Join Scan)
         Output: f.id, f.title
         Join Type: Inner
         Relation 0: stk_documents (d)
         Relation 1: stk_files (f)
         Join Cond: f.document_id = d.id
         Limit: 3
         Order By: f.title desc
         DataFusion Physical Plan: 
           : ProjectionExec: expr=[NULL as col_1, title@2 as col_2, ctid_3@0 as ctid_3, ctid_1@1 as ctid_1]
           :   SortExec: TopK(fetch=3), expr=[title@2 DESC], preserve_partitioning=[false]
           :     TantivyLookupExec: decode=[title]
           :       SegmentedTopKExec: sort_col=title, k=3, direction=DESC
           :         HashJoinExec: mode=CollectLeft, join_type=Inner, on=[(id@1, document_id@1)], projection=[ctid_3@0, ctid_1@2, title@4]
           :           ProjectionExec: expr=[ctid@0 as ctid_3, id@1 as id]
           :             CooperativeExec
           :               PgSearchScan: segments=1, query={"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"PROJECT_ALPHA","lenient":null,"conjunction_mode":null}}}}
           :           ProjectionExec: expr=[ctid@0 as ctid_1, document_id@1 as document_id, title@2 as title]
           :             CooperativeExec
           :               PgSearchScan: segments=1, dynamic_filters=2, query="all"
(22 rows)

SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title DESC
LIMIT 3;
 id |     title      
----+----------------
 99 | File Title 099
 97 | File Title 097
 95 | File Title 095
(3 rows)

-- =============================================================================
-- TEST 3: EXPLAIN ANALYZE — verify metrics (rows_input, rows_output, rows_pruned)
-- =============================================================================
EXPLAIN (ANALYZE, COSTS OFF, TIMING OFF, BUFFERS OFF, SUMMARY OFF)
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC
LIMIT 3;
                                                                                                                                                                            QUERY PLAN                                                                                                                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit (actual rows=3 loops=1)
   ->  Custom Scan (ParadeDB Join Scan) (actual rows=3 loops=1)
         Join Type: Inner
         Relation 0: stk_documents (d)
         Relation 1: stk_files (f)
         Join Cond: f.document_id = d.id
         Limit: 3
         Order By: f.title asc
         DataFusion Physical Plan: 
           : ProjectionExec: expr=[NULL as col_1, title@2 as col_2, ctid_3@0 as ctid_3, ctid_1@1 as ctid_1], metrics=[output_rows=3, output_bytes=152.0 B, output_batches=1]
           :   SortExec: TopK(fetch=3), expr=[title@2 ASC NULLS LAST], preserve_partitioning=[false], filter=[title@2 < File Title 005], metrics=[output_rows=3, output_bytes=152.0 B, output_batches=1, row_replacements=3]
           :     TantivyLookupExec: decode=[title], metrics=[output_rows=3, output_bytes=152.0 B, output_batches=1]
           :       SegmentedTopKExec: sort_col=title, k=3, direction=ASC, metrics=[rows_input=50, rows_output=3, segments_seen=1]
           :         HashJoinExec: mode=CollectLeft, join_type=Inner, on=[(id@1, document_id@1)], projection=[ctid_3@0, ctid_1@2, title@4], metrics=[output_rows=50, output_bytes=129.9 KB, output_batches=1, build_input_batches=1, build_input_rows=5, input_batches=1, input_rows=90, build_mem_used=344, avg_fanout=100% (50/50), probe_hit_rate=56% (50/90)]
           :           ProjectionExec: expr=[ctid@0 as ctid_3, id@1 as id], metrics=[output_rows=5, output_bytes=152.0 B, output_batches=1]
           :             CooperativeExec
           :               PgSearchScan: segments=1, query={"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"PROJECT_ALPHA","lenient":null,"conjunction_mode":null}}}}
           :           ProjectionExec: expr=[ctid@0 as ctid_1, document_id@1 as document_id, title@2 as title], metrics=[output_rows=90, output_bytes=5.5 KB, output_batches=1]
           :             CooperativeExec
           :               PgSearchScan: segments=1, dynamic_filters=2, query="all", metrics=[rows_pruned=10, rows_scanned=100]
(20 rows)

-- =============================================================================
-- TEST 4: K > total rows — no pruning, all rows survive
-- =============================================================================
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC
LIMIT 1000;
 id |     title      
----+----------------
  1 | File Title 001
  3 | File Title 003
  5 | File Title 005
  7 | File Title 007
  9 | File Title 009
 11 | File Title 011
 13 | File Title 013
 15 | File Title 015
 17 | File Title 017
 19 | File Title 019
 21 | File Title 021
 23 | File Title 023
 25 | File Title 025
 27 | File Title 027
 29 | File Title 029
 31 | File Title 031
 33 | File Title 033
 35 | File Title 035
 37 | File Title 037
 39 | File Title 039
 41 | File Title 041
 43 | File Title 043
 45 | File Title 045
 47 | File Title 047
 49 | File Title 049
 51 | File Title 051
 53 | File Title 053
 55 | File Title 055
 57 | File Title 057
 59 | File Title 059
 61 | File Title 061
 63 | File Title 063
 65 | File Title 065
 67 | File Title 067
 69 | File Title 069
 71 | File Title 071
 73 | File Title 073
 75 | File Title 075
 77 | File Title 077
 79 | File Title 079
 81 | File Title 081
 83 | File Title 083
 85 | File Title 085
 87 | File Title 087
 89 | File Title 089
 91 | File Title 091
 93 | File Title 093
 95 | File Title 095
 97 | File Title 097
 99 | File Title 099
(50 rows)

-- =============================================================================
-- TEST 5: K = 1 — maximum pruning
-- =============================================================================
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC
LIMIT 1;
 id |     title      
----+----------------
  1 | File Title 001
(1 row)

-- =============================================================================
-- TEST 6: Sort by non-deferred column (id, numeric) — SegmentedTopKExec
-- should NOT appear (only applies to deferred string/bytes columns)
-- =============================================================================
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.id ASC
LIMIT 3;
                                                                                                    QUERY PLAN                                                                                                     
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: f.id, f.title
   ->  Custom Scan (ParadeDB Join Scan)
         Output: f.id, f.title
         Join Type: Inner
         Relation 0: stk_documents (d)
         Relation 1: stk_files (f)
         Join Cond: f.document_id = d.id
         Limit: 3
         Order By: f.id asc
         DataFusion Physical Plan: 
           : ProjectionExec: expr=[id@2 as col_1, NULL as col_2, ctid_3@0 as ctid_3, ctid_1@1 as ctid_1]
           :   SortExec: TopK(fetch=3), expr=[id@2 ASC NULLS LAST], preserve_partitioning=[false]
           :     HashJoinExec: mode=CollectLeft, join_type=Inner, on=[(id@1, document_id@1)], projection=[ctid_3@0, ctid_1@2, id@4]
           :       ProjectionExec: expr=[ctid@0 as ctid_3, id@1 as id]
           :         CooperativeExec
           :           PgSearchScan: segments=1, dynamic_filters=1, query={"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"PROJECT_ALPHA","lenient":null,"conjunction_mode":null}}}}
           :       ProjectionExec: expr=[ctid@0 as ctid_1, document_id@1 as document_id, id@2 as id]
           :         CooperativeExec
           :           PgSearchScan: segments=1, dynamic_filters=2, query="all"
(20 rows)

-- =============================================================================
-- TEST 7: No LIMIT — SegmentedTopKExec should NOT appear
-- =============================================================================
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC;
WARNING:  JoinScan not used: query must have a LIMIT clause
                                                                                 QUERY PLAN                                                                                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Sort
   Output: f.id, f.title
   Sort Key: f.title
   ->  Hash Join
         Output: f.id, f.title
         Inner Unique: true
         Hash Cond: (f.document_id = d.id)
         ->  Seq Scan on public.stk_files f
               Output: f.id, f.document_id, f.title, f.content
         ->  Hash
               Output: d.id
               ->  Custom Scan (ParadeDB Scan) on public.stk_documents d
                     Output: d.id
                     Table: stk_documents
                     Index: stk_documents_bm25_idx
                     Exec Method: MixedFastFieldExecState
                     Fast Fields: id
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"PROJECT_ALPHA","lenient":null,"conjunction_mode":null}}}}
(19 rows)

-- =============================================================================
-- TEST 8: GUC toggle — disabling segmented_topk removes the node
-- =============================================================================
SET paradedb.enable_segmented_topk = off;
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC
LIMIT 3;
                                                                                            QUERY PLAN                                                                                            
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: f.id, f.title
   ->  Custom Scan (ParadeDB Join Scan)
         Output: f.id, f.title
         Join Type: Inner
         Relation 0: stk_documents (d)
         Relation 1: stk_files (f)
         Join Cond: f.document_id = d.id
         Limit: 3
         Order By: f.title asc
         DataFusion Physical Plan: 
           : ProjectionExec: expr=[NULL as col_1, title@2 as col_2, ctid_3@0 as ctid_3, ctid_1@1 as ctid_1]
           :   SortExec: TopK(fetch=3), expr=[title@2 ASC NULLS LAST], preserve_partitioning=[false]
           :     TantivyLookupExec: decode=[title]
           :       HashJoinExec: mode=CollectLeft, join_type=Inner, on=[(id@1, document_id@1)], projection=[ctid_3@0, ctid_1@2, title@4]
           :         ProjectionExec: expr=[ctid@0 as ctid_3, id@1 as id]
           :           CooperativeExec
           :             PgSearchScan: segments=1, query={"with_index":{"query":{"parse_with_field":{"field":"category","query_string":"PROJECT_ALPHA","lenient":null,"conjunction_mode":null}}}}
           :         ProjectionExec: expr=[ctid@0 as ctid_1, document_id@1 as document_id, title@2 as title]
           :           CooperativeExec
           :             PgSearchScan: segments=1, dynamic_filters=2, query="all"
(21 rows)

-- Verify results are the same with optimization disabled
SELECT f.id, f.title
FROM stk_files f
WHERE f.document_id IN (
    SELECT d.id FROM stk_documents d WHERE d.category @@@ 'PROJECT_ALPHA'
)
ORDER BY f.title ASC
LIMIT 3;
 id |     title      
----+----------------
  1 | File Title 001
  3 | File Title 003
  5 | File Title 005
(3 rows)

RESET paradedb.enable_segmented_topk;
-- =============================================================================
-- CLEANUP
-- =============================================================================
DROP TABLE stk_files CASCADE;
DROP TABLE stk_documents CASCADE;
