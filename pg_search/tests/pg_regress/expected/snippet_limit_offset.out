CREATE EXTENSION IF NOT EXISTS pg_search;
DROP TABLE IF EXISTS snippet_test;
CREATE TABLE snippet_test (
    id SERIAL PRIMARY KEY,
    content TEXT
);
INSERT INTO snippet_test (content) VALUES
('This is a test test of the snippet function with multiple test words'),
('Another test of the snippet snippet function with repeated snippet words'),
('Yet another test test test of the function function function'),
('test Lorem ipsum dolor sit amet...test');
CREATE INDEX ON snippet_test USING bm25 (
    id,
    content
) WITH (
    key_field = 'id'
);
SELECT pdb.snippet(content), pdb.snippet_positions(content) FROM snippet_test WHERE content @@@ 'test';
                                          snippet                                          |        snippet_positions        
-------------------------------------------------------------------------------------------+---------------------------------
 This is a <b>test</b> <b>test</b> of the snippet function with multiple <b>test</b> words | {"{10,14}","{15,19}","{58,62}"}
 Another <b>test</b> of the snippet snippet function with repeated snippet words           | {"{8,12}"}
 Yet another <b>test</b> <b>test</b> <b>test</b> of the function function function         | {"{12,16}","{17,21}","{22,26}"}
 <b>test</b> Lorem ipsum dolor sit amet...<b>test</b>                                      | {"{0,4}","{34,38}"}
(4 rows)

SELECT pdb.snippet(content, "limit" => 1), pdb.snippet_positions(content, "limit" => 1) FROM snippet_test WHERE content @@@ 'test';
                                     snippet                                     | snippet_positions 
---------------------------------------------------------------------------------+-------------------
 This is a <b>test</b> test of the snippet function with multiple test words     | {"{10,14}"}
 Another <b>test</b> of the snippet snippet function with repeated snippet words | {"{8,12}"}
 Yet another <b>test</b> test test of the function function function             | {"{12,16}"}
 <b>test</b> Lorem ipsum dolor sit amet...test                                   | {"{0,4}"}
(4 rows)

SELECT pdb.snippet(content, "limit" => 1, "offset" => 1), pdb.snippet_positions(content, "limit" => 1, "offset" => 1) FROM snippet_test WHERE content @@@ 'test';
                                   snippet                                   | snippet_positions 
-----------------------------------------------------------------------------+-------------------
 This is a test <b>test</b> of the snippet function with multiple test words | {"{15,19}"}
                                                                             | 
 Yet another test <b>test</b> test of the function function function         | {"{17,21}"}
 test Lorem ipsum dolor sit amet...<b>test</b>                               | {"{34,38}"}
(4 rows)

SELECT pdb.snippet(content, "limit" => 5, "offset" => 2), pdb.snippet_positions(content, "limit" => 5, "offset" => 2) FROM snippet_test WHERE content @@@ 'test';
                                   snippet                                   | snippet_positions 
-----------------------------------------------------------------------------+-------------------
 This is a test test of the snippet function with multiple <b>test</b> words | {"{58,62}"}
                                                                             | 
 Yet another test test <b>test</b> of the function function function         | {"{22,26}"}
                                                                             | 
(4 rows)

-- Edge cases
SELECT pdb.snippet(content, "limit" => 0), pdb.snippet_positions(content, "limit" => 0) FROM snippet_test WHERE content @@@ 'test';
 snippet | snippet_positions 
---------+-------------------
         | 
         | 
         | 
         | 
(4 rows)

SELECT pdb.snippet(content, "limit" => -1), pdb.snippet_positions(content, "limit" => -1) FROM snippet_test WHERE content @@@ 'test';
ERROR:  limit must not be negative
SELECT pdb.snippet(content, "offset" => 1000), pdb.snippet_positions(content, "offset" => 1000) FROM snippet_test WHERE content @@@ 'test';
 snippet | snippet_positions 
---------+-------------------
         | 
         | 
         | 
         | 
(4 rows)

SELECT pdb.snippet(content, "limit" => null), pdb.snippet_positions(content, "limit" => null) FROM snippet_test WHERE content @@@ 'test';
                                          snippet                                          |        snippet_positions        
-------------------------------------------------------------------------------------------+---------------------------------
 This is a <b>test</b> <b>test</b> of the snippet function with multiple <b>test</b> words | {"{10,14}","{15,19}","{58,62}"}
 Another <b>test</b> of the snippet snippet function with repeated snippet words           | {"{8,12}"}
 Yet another <b>test</b> <b>test</b> <b>test</b> of the function function function         | {"{12,16}","{17,21}","{22,26}"}
 <b>test</b> Lorem ipsum dolor sit amet...<b>test</b>                                      | {"{0,4}","{34,38}"}
(4 rows)

-- With max num chars
SELECT pdb.snippet(content, max_num_chars => 20, "offset" => 2) FROM snippet_test WHERE content @@@ 'test';
          snippet           
----------------------------
 multiple <b>test</b> words
 
 test <b>test</b> of the
 
(4 rows)

SELECT pdb.snippet(content, max_num_chars => 0, "offset" => 2) FROM snippet_test WHERE content @@@ 'test';
   snippet   
-------------
 <b>test</b>
 
 <b>test</b>
 
(4 rows)

DROP TABLE snippet_test;
