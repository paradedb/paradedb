-- Test scalar subquery pattern at larger scale
-- This tests the paging-string-max benchmark pattern with more realistic data volume
-- Cleanup
DROP TABLE IF EXISTS test_pages_scale CASCADE;
DROP TABLE IF EXISTS test_metadata_scale CASCADE;
-- Create test tables
CREATE TABLE test_pages_scale (
    id TEXT PRIMARY KEY,
    content TEXT
);
CREATE TABLE test_metadata_scale (
    name TEXT PRIMARY KEY,
    value TEXT
);
-- Create BM25 index on pages
CREATE INDEX test_pages_scale_idx ON test_pages_scale
USING bm25 (id, content)
WITH (key_field = 'id');
-- Insert larger dataset (10,000 rows to simulate scale)
-- This generates page IDs like 'page-0000001' through 'page-0010000'
INSERT INTO test_pages_scale (id, content)
SELECT 
    'page-' || LPAD(i::TEXT, 7, '0'),
    'content for page ' || i
FROM generate_series(1, 10000) i;
INSERT INTO test_metadata_scale (name, value) VALUES
    ('pages-row-id-max', 'page-0005000');
-- Test 1: Scalar subquery with large dataset (benchmark pattern)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT * FROM test_pages_scale 
WHERE id @@@ paradedb.all() 
  AND id >= (SELECT value FROM test_metadata_scale WHERE name = 'pages-row-id-max')
ORDER BY id 
LIMIT 100;
                                                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                                                         
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: test_pages_scale.id, test_pages_scale.content
   InitPlan 1
     ->  Index Scan using test_metadata_scale_pkey on public.test_metadata_scale
           Output: test_metadata_scale.value
           Index Cond: (test_metadata_scale.name = 'pages-row-id-max'::text)
   ->  Gather Merge
         Output: test_pages_scale.id, test_pages_scale.content
         Workers Planned: 1
         ->  Parallel Custom Scan (ParadeDB Scan) on public.test_pages_scale
               Output: test_pages_scale.id, test_pages_scale.content
               Table: test_pages_scale
               Index: test_pages_scale_idx
               Exec Method: TopNScanExecState
               Scores: false
                  TopN Order By: id asc
                  TopN Limit: 100
               Full Index Scan: true
               Tantivy Query: {"boolean":{"must":[{"heap_filter":{"indexed_query":{"boolean":{"must":[{"with_index":{"query":"all"}}]}},"field_filters":[{"expr_node":"{OPEXPR :opno 667 :opfuncid 743 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 100 :args ({VAR :varno 1 :varattno 1 :vartype 25 :vartypmod -1 :varcollid 100 :varnullingrels (b) :varlevelsup 0 :varnosyn 1 :varattnosyn 1 :location -1} {PARAM :paramkind 1 :paramid 0 :paramtype 25 :paramtypmod -1 :paramcollid 100 :location -1}) :location -1}","description":"OpExpr with operator OID 667"}]}}]}}
(19 rows)

SELECT * FROM test_pages_scale 
WHERE id @@@ paradedb.all() 
  AND id >= (SELECT value FROM test_metadata_scale WHERE name = 'pages-row-id-max')
ORDER BY id 
LIMIT 100;
WARNING:  terminating connection because of crash of another server process
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.
connection to server was lost
