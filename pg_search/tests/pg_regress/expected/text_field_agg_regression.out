-- =====================================================================
-- Regression Test: Text Field Aggregation Bug
-- Issue: "unexpected type Str. This should not happen"
-- Fixed in tantivy commit 65b5a1a3 (ParadeDB v0.21.3+)
--
-- The bug occurred when metric aggregations (value_count, count, etc.)
-- were used on TEXT fields as sub-aggregations inside bucket aggregations
-- (histogram, range, terms with high cardinality).
-- =====================================================================
CREATE EXTENSION IF NOT EXISTS pg_search;
SET paradedb.enable_aggregate_custom_scan TO on;
-- =====================================================================
-- SETUP: High cardinality text field (500 unique values)
-- This triggers the HashMap path in tantivy's terms aggregation
-- =====================================================================
DROP TABLE IF EXISTS test_text_agg CASCADE;
CREATE TABLE test_text_agg (
    id SERIAL PRIMARY KEY,
    name TEXT,
    score INTEGER
);
-- Insert 500 unique names to trigger high-cardinality code path
INSERT INTO test_text_agg (name, score)
SELECT 'language_' || i::text, (i % 100)
FROM generate_series(1, 500) AS i;
CREATE INDEX test_text_agg_idx ON test_text_agg
USING bm25 (id, name, score)
WITH (
    key_field = 'id',
    text_fields = '{"name": {"fast": true, "tokenizer": {"type": "default"}}}',
    numeric_fields = '{"score": {}}'
);
-- =====================================================================
-- TEST 1: GROUP BY on text field + ORDER BY count()
-- This was failing in v0.21.2 with "unexpected type Str"
-- =====================================================================
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT name AS value
FROM test_text_agg
WHERE id @@@ paradedb.all()
GROUP BY name
ORDER BY count(name) DESC, name DESC
LIMIT 5;
                                                                                 QUERY PLAN                                                                                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: name, (pdb.agg_fn('COUNT'::text))
   ->  Sort
         Output: name, (pdb.agg_fn('COUNT'::text))
         Sort Key: (pdb.agg_fn('COUNT'::text)) DESC, test_text_agg.name DESC
         ->  Custom Scan (ParadeDB Aggregate Scan) on public.test_text_agg
               Output: name, pdb.agg_fn('COUNT'::text)
               Index: test_text_agg_idx
               Tantivy Query: {"with_index":{"query":"all"}}
                 Applies to Aggregates: COUNT(name)
                 Group By: name
                 Limit: 5
                 Aggregate Definition: {"grouped":{"aggs":{"0":{"value_count":{"field":"name","missing":null}}},"terms":{"field":"name","segment_size":65000,"size":65000}}}
(13 rows)

SELECT name AS value
FROM test_text_agg
WHERE id @@@ paradedb.all()
GROUP BY name
ORDER BY count(name) DESC, name DESC
LIMIT 5;
    value    
-------------
 language_99
 language_98
 language_97
 language_96
 language_95
(5 rows)

-- =====================================================================
-- TEST 2: pdb.agg value_count on text field with GROUP BY
-- This was failing in v0.21.2 with "unexpected type Str"
-- =====================================================================
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT
    name AS value,
    pdb.agg('{"value_count": {"field": "name"}}') AS count
FROM test_text_agg
WHERE id @@@ paradedb.all()
GROUP BY name
ORDER BY 2 DESC, name DESC
LIMIT 5;
                                                                                 QUERY PLAN                                                                                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: name, (pdb.agg_fn('pdb.agg'::text))
   ->  Sort
         Output: name, (pdb.agg_fn('pdb.agg'::text))
         Sort Key: (pdb.agg_fn('pdb.agg'::text)) DESC, test_text_agg.name DESC
         ->  Custom Scan (ParadeDB Aggregate Scan) on public.test_text_agg
               Output: name, pdb.agg_fn('pdb.agg'::text)
               Index: test_text_agg_idx
               Tantivy Query: {"with_index":{"query":"all"}}
                 Applies to Aggregates: CUSTOM_AGG({"value_count":{"field":"name"}})
                 Group By: name
                 Limit: 5
                 Aggregate Definition: {"grouped":{"aggs":{"0":{"value_count":{"field":"name","missing":null}}},"terms":{"field":"name","segment_size":65000,"size":65000}}}
(13 rows)

SELECT
    name AS value,
    pdb.agg('{"value_count": {"field": "name"}}') AS count
FROM test_text_agg
WHERE id @@@ paradedb.all()
GROUP BY name
ORDER BY 2 DESC, name DESC
LIMIT 5;
    value    |     count      
-------------+----------------
 language_99 | {"value": 1.0}
 language_98 | {"value": 1.0}
 language_97 | {"value": 1.0}
 language_96 | {"value": 1.0}
 language_95 | {"value": 1.0}
(5 rows)

-- =====================================================================
-- TEST 3: Histogram + value_count sub-aggregation on text field
-- This was failing in v0.21.2 with "unexpected type Str"
-- =====================================================================
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT pdb.agg('{
    "histogram": {"field": "score", "interval": 25},
    "aggs": {
        "name_count": {"value_count": {"field": "name"}}
    }
}')
FROM test_text_agg
WHERE id @@@ paradedb.all();
                                                                                                                                  QUERY PLAN                                                                                                                                  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.test_text_agg
   Output: pdb.agg_fn('pdb.agg'::text)
   Index: test_text_agg_idx
   Tantivy Query: {"with_index":{"query":"all"}}
     Applies to Aggregates: CUSTOM_AGG({"aggs":{"name_count":{"value_count":{"field":"name"}}},"histogram":{"field":"score","interval":25}})
     Aggregate Definition: {"0":{"aggs":{"name_count":{"value_count":{"field":"name","missing":null}}},"histogram":{"extended_bounds":null,"field":"score","hard_bounds":null,"interval":25.0,"is_normalized_to_ns":false,"keyed":false,"min_doc_count":null,"offset":null}}}
(6 rows)

SELECT pdb.agg('{
    "histogram": {"field": "score", "interval": 25},
    "aggs": {
        "name_count": {"value_count": {"field": "name"}}
    }
}')
FROM test_text_agg
WHERE id @@@ paradedb.all();
                                                                                                                                       agg                                                                                                                                        
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"buckets": [{"key": 0.0, "doc_count": 125, "name_count": {"value": 125.0}}, {"key": 25.0, "doc_count": 125, "name_count": {"value": 125.0}}, {"key": 50.0, "doc_count": 125, "name_count": {"value": 125.0}}, {"key": 75.0, "doc_count": 125, "name_count": {"value": 125.0}}]}
(1 row)

-- =====================================================================
-- TEST 4: Range + value_count sub-aggregation on text field
-- This was failing in v0.21.2 with "unexpected type Str"
-- =====================================================================
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT pdb.agg('{
    "range": {"field": "score", "ranges": [{"to": 50}, {"from": 50}]},
    "aggs": {
        "name_count": {"value_count": {"field": "name"}}
    }
}')
FROM test_text_agg
WHERE id @@@ paradedb.all();
                                                                                      QUERY PLAN                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.test_text_agg
   Output: pdb.agg_fn('pdb.agg'::text)
   Index: test_text_agg_idx
   Tantivy Query: {"with_index":{"query":"all"}}
     Applies to Aggregates: CUSTOM_AGG({"aggs":{"name_count":{"value_count":{"field":"name"}}},"range":{"field":"score","ranges":[{"to":50},{"from":50}]}})
     Aggregate Definition: {"0":{"aggs":{"name_count":{"value_count":{"field":"name","missing":null}}},"range":{"field":"score","keyed":false,"ranges":[{"to":50.0},{"from":50.0}]}}}
(6 rows)

SELECT pdb.agg('{
    "range": {"field": "score", "ranges": [{"to": 50}, {"from": 50}]},
    "aggs": {
        "name_count": {"value_count": {"field": "name"}}
    }
}')
FROM test_text_agg
WHERE id @@@ paradedb.all();
                                                                                      agg                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"buckets": [{"to": 50.0, "key": "*-50", "doc_count": 250, "name_count": {"value": 250.0}}, {"key": "50-*", "from": 50.0, "doc_count": 250, "name_count": {"value": 250.0}}]}
(1 row)

-- =====================================================================
-- TEST 5: Simple value_count on text field (top-level, no bucket parent)
-- This worked in v0.21.2 and should continue to work
-- =====================================================================
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF, VERBOSE)
SELECT pdb.agg('{"value_count": {"field": "name"}}')
FROM test_text_agg
WHERE id @@@ paradedb.all();
                                   QUERY PLAN                                    
---------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.test_text_agg
   Output: pdb.agg_fn('pdb.agg'::text)
   Index: test_text_agg_idx
   Tantivy Query: {"with_index":{"query":"all"}}
     Applies to Aggregates: CUSTOM_AGG({"value_count":{"field":"name"}})
     Aggregate Definition: {"0":{"value_count":{"field":"name","missing":null}}}
(6 rows)

SELECT pdb.agg('{"value_count": {"field": "name"}}')
FROM test_text_agg
WHERE id @@@ paradedb.all();
       agg        
------------------
 {"value": 500.0}
(1 row)

-- =====================================================================
-- Cleanup
-- =====================================================================
DROP TABLE IF EXISTS test_text_agg CASCADE;
RESET paradedb.enable_aggregate_custom_scan;
