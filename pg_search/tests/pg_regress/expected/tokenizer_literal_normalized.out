\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
CREATE TABLE test_table (
    id SERIAL PRIMARY KEY,
    text TEXT
);
INSERT INTO test_table (text) VALUES
    ('Hello, world!'),
    ('Hello, world!');
CREATE INDEX idx_test_table ON test_table USING bm25 (id, (text::pdb.unicode_words('ascii_folding=true'))) WITH (key_field='id');
EXPLAIN SELECT text, pdb.agg('{"value_count": {"field": "id"}}') FROM test_table WHERE id @@@ pdb.all() GROUP BY text ORDER BY text LIMIT 5;
                                            QUERY PLAN                                            
--------------------------------------------------------------------------------------------------
 Limit  (cost=10.02..10.06 rows=2 width=64)
   ->  GroupAggregate  (cost=10.02..10.06 rows=2 width=64)
         Group Key: text
         ->  Sort  (cost=10.02..10.03 rows=2 width=32)
               Sort Key: text
               ->  Custom Scan (ParadeDB Scan) on test_table  (cost=10.00..10.01 rows=2 width=32)
                     Table: test_table
                     Index: idx_test_table
                     Segment Count: 1
                     Exec Method: NormalScanExecState
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"all":{"field":"id"}}}}
(12 rows)

EXPLAIN SELECT * FROM test_table WHERE id @@@ pdb.all() ORDER BY text LIMIT 5;
WARNING:  Query has LIMIT 5 but is not using TopN scan (using Normal instead). Reason: ORDER BY columns cannot be pushed down to the index. This may cause poor performance on large datasets. Remedies: Ensure ORDER BY columns are indexed. Numeric columns are fast by default. For string columns, use pdb::literal tokenizer. To disable this warning: SET paradedb.check_topn_scan = false
                                         QUERY PLAN                                         
--------------------------------------------------------------------------------------------
 Limit  (cost=10.02..10.03 rows=2 width=36)
   ->  Sort  (cost=10.02..10.03 rows=2 width=36)
         Sort Key: text
         ->  Custom Scan (ParadeDB Scan) on test_table  (cost=10.00..10.01 rows=2 width=36)
               Table: test_table
               Index: idx_test_table
               Segment Count: 1
               Exec Method: NormalScanExecState
               Scores: false
               Tantivy Query: {"with_index":{"query":{"all":{"field":"id"}}}}
(10 rows)

DROP INDEX idx_test_table;
CREATE INDEX idx_test_table ON test_table USING bm25 (id, (text::pdb.literal_normalized('ascii_folding=true'))) WITH (key_field='id');
EXPLAIN SELECT text, pdb.agg('{"value_count": {"field": "id"}}') FROM test_table WHERE id @@@ pdb.all() GROUP BY text ORDER BY text LIMIT 5;
                                                                                         QUERY PLAN                                                                                         
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.00..0.00 rows=1 width=64)
   ->  Custom Scan (ParadeDB Aggregate Scan) on test_table  (cost=0.00..0.00 rows=0 width=64)
         Index: idx_test_table
         Tantivy Query: {"with_index":{"query":{"all":{"field":"id"}}}}
           Applies to Aggregates: CUSTOM_AGG({"value_count":{"field":"id"}})
           Group By: text
           Limit: 5
           Aggregate Definition: {"grouped":{"aggs":{"0":{"value_count":{"field":"id","missing":null}}},"terms":{"field":"text","order":{"_key":"asc"},"segment_size":65000,"size":65000}}}
(8 rows)

EXPLAIN SELECT * FROM test_table WHERE id @@@ pdb.all() ORDER BY text LIMIT 5;
WARNING:  Query has LIMIT 5 but is not using TopN scan (using FastFieldMixed instead). Reason: ORDER BY columns cannot be pushed down to the index. This may cause poor performance on large datasets. Remedies: Ensure ORDER BY columns are indexed. Numeric columns are fast by default. For string columns, use pdb::literal tokenizer. To disable this warning: SET paradedb.check_topn_scan = false
                                         QUERY PLAN                                         
--------------------------------------------------------------------------------------------
 Limit  (cost=10.02..10.03 rows=2 width=36)
   ->  Sort  (cost=10.02..10.03 rows=2 width=36)
         Sort Key: text
         ->  Custom Scan (ParadeDB Scan) on test_table  (cost=10.00..10.01 rows=2 width=36)
               Table: test_table
               Index: idx_test_table
               Segment Count: 1
               Exec Method: MixedFastFieldExecState
               Fast Fields: text, id
               Scores: false
               Tantivy Query: {"with_index":{"query":{"all":{"field":"id"}}}}
(11 rows)

DROP INDEX idx_test_table;
CREATE INDEX idx_test_table ON test_table USING bm25 (id, (text::pdb.literal)) WITH (key_field='id');
EXPLAIN SELECT text, pdb.agg('{"value_count": {"field": "id"}}') FROM test_table WHERE id @@@ pdb.all() GROUP BY text ORDER BY text LIMIT 5;
                                                                                         QUERY PLAN                                                                                         
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.00..0.00 rows=1 width=64)
   ->  Custom Scan (ParadeDB Aggregate Scan) on test_table  (cost=0.00..0.00 rows=0 width=64)
         Index: idx_test_table
         Tantivy Query: {"with_index":{"query":{"all":{"field":"id"}}}}
           Applies to Aggregates: CUSTOM_AGG({"value_count":{"field":"id"}})
           Group By: text
           Limit: 5
           Aggregate Definition: {"grouped":{"aggs":{"0":{"value_count":{"field":"id","missing":null}}},"terms":{"field":"text","order":{"_key":"asc"},"segment_size":65000,"size":65000}}}
(8 rows)

EXPLAIN SELECT * FROM test_table WHERE id @@@ pdb.all() ORDER BY text LIMIT 5;
                                      QUERY PLAN                                      
--------------------------------------------------------------------------------------
 Limit  (cost=10.00..10.01 rows=2 width=36)
   ->  Custom Scan (ParadeDB Scan) on test_table  (cost=10.00..10.01 rows=2 width=36)
         Table: test_table
         Index: idx_test_table
         Segment Count: 1
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: text asc
            TopN Limit: 5
         Tantivy Query: {"with_index":{"query":{"all":{"field":"id"}}}}
(10 rows)

DROP TABLE test_table;
