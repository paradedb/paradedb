CREATE EXTENSION IF NOT EXISTS pg_search;
CREATE TABLE test (id int, content text, extra jsonb);
CREATE INDEX test_bm25 ON test USING bm25 (id, content, extra) WITH (key_field='id');
INSERT INTO test (id, content, extra) VALUES
(1, 'Beijing CBD area', '{"type": "business", "district": "Chaoyang"}'::jsonb),
(2, 'Beijing Palace Museum', '{"type": "landmark", "district": "Dongcheng"}'::jsonb),
(3, 'Shanghai Bund', '{"type": "tourism", "district": "Huangpu"}'::jsonb),
(4, 'Universal Studios Beijing', '{"type": "entertainment", "district": "Tongzhou"}'::jsonb);
EXPLAIN (COSTS OFF)
SELECT pdb.score(test.id), test.content, test.extra
FROM test
WHERE (test.content &&& 'Beijing') AND jsonb_path_exists(test.extra, '$.type')
ORDER BY pdb.score(test.id) DESC
LIMIT 10;
                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                           
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on test
         Table: test
         Index: test_bm25
         Exec Method: TopNScanExecState
         Scores: true
            TopN Order By: pdb.score() desc
            TopN Limit: 10
         Tantivy Query: {"boolean":{"must":[{"heap_filter":{"indexed_query":{"boolean":{"must":[{"with_index":{"query":{"match":{"field":"content","value":"Beijing","tokenizer":null,"distance":null,"transposition_cost_one":null,"prefix":null,"conjunction_mode":true}}}}]}},"field_filters":[{"heap_filter":"jsonb_path_exists(extra, '$.\"type\"'::jsonpath, '{}'::jsonb, false)"}]}}]}}
(9 rows)

SELECT pdb.score(test.id), test.content, test.extra
FROM test
WHERE (test.content &&& 'Beijing') AND jsonb_path_exists(test.extra, '$.type')
ORDER BY pdb.score(test.id) DESC
LIMIT 10;
   score    |          content          |                       extra                       
------------+---------------------------+---------------------------------------------------
 0.34388584 | Beijing CBD area          | {"type": "business", "district": "Chaoyang"}
 0.34388584 | Beijing Palace Museum     | {"type": "landmark", "district": "Dongcheng"}
 0.34388584 | Universal Studios Beijing | {"type": "entertainment", "district": "Tongzhou"}
(3 rows)

