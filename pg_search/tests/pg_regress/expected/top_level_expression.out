CREATE EXTENSION IF NOT EXISTS pg_search;
CREATE TABLE test (id int, content text, extra jsonb);
CREATE INDEX test_bm25 ON test USING bm25 (id, content, extra) WITH (key_field='id');
INSERT INTO test (id, content, extra) VALUES
(1, 'Beijing CBD area', '{"type": "business", "district": "Chaoyang"}'::jsonb),
(2, 'Beijing Palace Museum', '{"type": "landmark", "district": "Dongcheng"}'::jsonb),
(3, 'Shanghai Bund', '{"type": "tourism", "district": "Huangpu"}'::jsonb),
(4, 'Universal Studios Beijing', '{"type": "entertainment", "district": "Tongzhou"}'::jsonb);
EXPLAIN (COSTS OFF)
SELECT pdb.score(test.id), test.content, test.extra
FROM test
WHERE (test.content &&& 'Beijing') AND jsonb_path_exists(test.extra, '$.type')
ORDER BY pdb.score(test.id) DESC
LIMIT 10;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Custom Scan (ParadeDB Scan) on test
         Table: test
         Index: test_bm25
         Exec Method: TopNScanExecState
         Scores: true
            TopN Order By: pdb.score() desc
            TopN Limit: 10
         Tantivy Query: {"boolean":{"must":[{"heap_filter":{"indexed_query":{"boolean":{"must":[{"with_index":{"query":{"match":{"field":"content","value":"Beijing","tokenizer":null,"distance":null,"transposition_cost_one":null,"prefix":null,"conjunction_mode":true}}}}]}},"field_filters":[{"expr_node":"{FUNCEXPR :funcid 4005 :funcresulttype 16 :funcretset false :funcvariadic false :funcformat 0 :funccollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 3 :vartype 3802 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varnosyn 1 :varattnosyn 3 :location -1} {CONST :consttype 4072 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 33 [ -124 0 0 0 1 0 0 -128 27 0 0 0 8 0 0 0 25 0 0 0 0 0 0 0 4 0 0 0 116 121 112 101 0 ]} {CONST :consttype 3802 :consttypmod -1 :constcollid 0 :constlen -1 :constbyval false :constisnull false :location -1 :constvalue 8 [ 32 0 0 0 0 0 0 32 ]} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull false :location -1 :constvalue 1 [ 0 0 0 0 0 0 0 0 ]}) :location -1}","description":"FuncExpr with function OID 4005"}]}}]}}
(9 rows)

SELECT pdb.score(test.id), test.content, test.extra
FROM test
WHERE (test.content &&& 'Beijing') AND jsonb_path_exists(test.extra, '$.type')
ORDER BY pdb.score(test.id) DESC
LIMIT 10;
   score    |          content          |                       extra                       
------------+---------------------------+---------------------------------------------------
 0.34388584 | Beijing CBD area          | {"type": "business", "district": "Chaoyang"}
 0.34388584 | Beijing Palace Museum     | {"type": "landmark", "district": "Dongcheng"}
 0.34388584 | Universal Studios Beijing | {"type": "entertainment", "district": "Tongzhou"}
(3 rows)

