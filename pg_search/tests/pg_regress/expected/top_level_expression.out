CREATE EXTENSION IF NOT EXISTS pg_search;
CREATE TABLE test (id int, content text, extra jsonb);
CREATE INDEX test_bm25 ON test USING bm25 (id, content, extra) WITH (key_field='id');
INSERT INTO test (id, content, extra) VALUES
(1, 'Beijing CBD area', '{"type": "business", "district": "Chaoyang"}'::jsonb),
(2, 'Beijing Palace Museum', '{"type": "landmark", "district": "Dongcheng"}'::jsonb),
(3, 'Shanghai Bund', '{"type": "tourism", "district": "Huangpu"}'::jsonb),
(4, 'Universal Studios Beijing', '{"type": "entertainment", "district": "Tongzhou"}'::jsonb);
EXPLAIN (COSTS OFF)
SELECT pdb.score(test.id), test.content, test.extra
FROM test
WHERE (test.content &&& 'Beijing') AND jsonb_path_exists(test.extra, '$.type')
ORDER BY pdb.score(test.id) DESC
LIMIT 10;
                                                                                                                         QUERY PLAN                                                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Sort
         Sort Key: (pdb.score(id)) DESC
         ->  Index Scan using test_bm25 on test
               Index Cond: (id @@@ '{"with_index":{"oid":143531,"query":{"match":{"field":"content","value":"Beijing","tokenizer":null,"distance":null,"transposition_cost_one":null,"prefix":null,"conjunction_mode":true}}}}'::paradedb.searchqueryinput)
               Filter: jsonb_path_exists(extra, '$."type"'::jsonpath, '{}'::jsonb, false)
(6 rows)

SELECT test.content, test.extra
FROM test
WHERE (test.content &&& 'Beijing') AND jsonb_path_exists(test.extra, '$.type')
ORDER BY pdb.score(test.id) DESC
LIMIT 10;
ERROR:  Unsupported query shape. Please report at https://github.com/orgs/paradedb/discussions/3678
