-- Test TopN + Aggregates + Faceting
-- Phase 1: Basic TopN tests with window aggregate detection
CREATE EXTENSION IF NOT EXISTS pg_search;
DROP TABLE IF EXISTS products CASCADE;
-- Setup test data
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    description TEXT,
    category TEXT,
    brand TEXT,
    price NUMERIC,
    rating NUMERIC,
    in_stock BOOLEAN,
    sales INTEGER
);
-- Insert test data
INSERT INTO products (name, description, category, brand, price, rating, in_stock, sales) VALUES
    ('MacBook Pro', 'High-performance laptop for professionals', 'Laptops', 'Apple', 2499, 4.8, true, 150),
    ('Dell XPS 13', 'Compact and powerful ultrabook', 'Laptops', 'Dell', 1299, 4.6, true, 200),
    ('ThinkPad X1', 'Business laptop with great keyboard', 'Laptops', 'Lenovo', 1599, 4.5, true, 180),
    ('HP Spectre', 'Stylish convertible laptop', 'Laptops', 'HP', 1399, 4.4, true, 120),
    ('ASUS ROG', 'Gaming laptop with RTX graphics', 'Laptops', 'ASUS', 1899, 4.7, true, 90);
-- Create BM25 index
CREATE INDEX products_idx ON products
USING bm25(id, name, description, category, brand, price, rating, in_stock, sales)
WITH (
    key_field='id',
    text_fields='{
        "name": {},
        "description": {},
        "brand": {"fast": true}
    }',
    numeric_fields='{
        "price": {"fast": true},
        "rating": {"fast": true},
        "sales": {"fast": true}
    }',
    boolean_fields='{
        "in_stock": {"fast": true}
    }'
);
-- Test 1: Basic TopN without window aggregates
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
                                                                         QUERY PLAN                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, rating
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, rating
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    category,
    rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
 id |    name     | category | rating 
----+-------------+----------+--------
  1 | MacBook Pro | Laptops  |    4.8
  5 | ASUS ROG    | Laptops  |    4.7
  3 | ThinkPad X1 | Laptops  |    4.5
(3 rows)

-- Test 2: TopN with COUNT(*) OVER () - Basic window aggregate
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 3: Multiple window aggregates (COUNT, SUM, AVG)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER () as total_count,
    SUM(price) OVER () as total_price,
    AVG(rating) OVER () as avg_rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 7 total exprs (4 base + 3 window funcs)
WARNING:    TargetList: starting to process 7 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=7 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER () as total_count,
    SUM(price) OVER () as total_price,
    AVG(rating) OVER () as avg_rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 7 total exprs (4 base + 3 window funcs)
WARNING:    TargetList: starting to process 7 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=7 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 4: Window aggregate with PARTITION BY (not supported yet, but should extract)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    rating,
    COUNT(*) OVER (PARTITION BY category) as category_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                  QUERY PLAN                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, rating, (count(*) OVER (?))
   ->  Sort
         Output: id, name, category, rating, (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, category, rating, count(*) OVER (?)
               ->  Sort
                     Output: category, id, name, rating
                     Sort Key: products.category
                     ->  Custom Scan (ParadeDB Scan) on public.products
                           Output: category, id, name, rating
                           Table: products
                           Index: products_idx
                           Exec Method: NormalScanExecState
                           Scores: false
                           Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(17 rows)

SELECT 
    id,
    name,
    category,
    rating,
    COUNT(*) OVER (PARTITION BY category) as category_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | category | rating | category_count 
----+-------------+----------+--------+----------------
  1 | MacBook Pro | Laptops  |    4.8 |              4
  5 | ASUS ROG    | Laptops  |    4.7 |              4
  3 | ThinkPad X1 | Laptops  |    4.5 |              4
(3 rows)

-- Test 5: Window aggregate with ORDER BY in OVER clause
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    SUM(price) OVER (ORDER BY rating DESC) as running_total
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, price, (sum(price) OVER (?))
   ->  WindowAgg
         Output: id, name, rating, price, sum(price) OVER (?)
         ->  Sort
               Output: rating, id, name, price
               Sort Key: products.rating DESC
               ->  Custom Scan (ParadeDB Scan) on public.products
                     Output: rating, id, name, price
                     Table: products
                     Index: products_idx
                     Exec Method: NormalScanExecState
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(14 rows)

SELECT 
    id,
    name,
    rating,
    price,
    SUM(price) OVER (ORDER BY rating DESC) as running_total
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | rating | price | running_total 
----+-------------+--------+-------+---------------
  1 | MacBook Pro |    4.8 |  2499 |          2499
  5 | ASUS ROG    |    4.7 |  1899 |          4398
  3 | ThinkPad X1 |    4.5 |  1599 |          5997
(3 rows)

-- Test 6: Window aggregate with ROWS frame
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    AVG(rating) OVER (ORDER BY rating DESC ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) as moving_avg
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (avg(rating) OVER (?))
   ->  WindowAgg
         Output: id, name, rating, avg(rating) OVER (?)
         ->  Sort
               Output: rating, id, name
               Sort Key: products.rating DESC
               ->  Custom Scan (ParadeDB Scan) on public.products
                     Output: rating, id, name
                     Table: products
                     Index: products_idx
                     Exec Method: NormalScanExecState
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(14 rows)

SELECT 
    id,
    name,
    rating,
    AVG(rating) OVER (ORDER BY rating DESC ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) as moving_avg
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | rating |     moving_avg     
----+-------------+--------+--------------------
  1 | MacBook Pro |    4.8 | 4.7500000000000000
  5 | ASUS ROG    |    4.7 | 4.6666666666666667
  3 | ThinkPad X1 |    4.5 | 4.5333333333333333
(3 rows)

-- Test 7: MIN and MAX window aggregates
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    MIN(price) OVER () as min_price,
    MAX(price) OVER () as max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 6 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 6 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    rating,
    price,
    MIN(price) OVER () as min_price,
    MAX(price) OVER () as max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 6 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 6 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 8: Window aggregate with FILTER clause
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    in_stock,
    COUNT(*) FILTER (WHERE in_stock = true) OVER () as in_stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=8
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, in_stock, (count(*) FILTER (WHERE in_stock) OVER (?))
   ->  Sort
         Output: id, name, rating, in_stock, (count(*) FILTER (WHERE in_stock) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, rating, in_stock, count(*) FILTER (WHERE in_stock) OVER (?)
               ->  Custom Scan (ParadeDB Scan) on public.products
                     Output: id, name, rating, in_stock
                     Table: products
                     Index: products_idx
                     Exec Method: NormalScanExecState
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(14 rows)

SELECT 
    id,
    name,
    rating,
    in_stock,
    COUNT(*) FILTER (WHERE in_stock = true) OVER () as in_stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=8
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | rating | in_stock | in_stock_count 
----+-------------+--------+----------+----------------
  1 | MacBook Pro |    4.8 | t        |              4
  5 | ASUS ROG    |    4.7 | t        |              4
  3 | ThinkPad X1 |    4.5 | t        |              4
(3 rows)

-- Test 9: COUNT with specific column (not *)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(brand) OVER () as brand_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=5
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
ERROR:  variable not found in subplan target list
SELECT 
    id,
    name,
    rating,
    COUNT(brand) OVER () as brand_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=5
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
ERROR:  variable not found in subplan target list
-- Test 10: Complex PARTITION BY and ORDER BY combination
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    brand,
    rating,
    COUNT(*) OVER (PARTITION BY category ORDER BY rating DESC) as category_rank_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=7
WARNING:      base column 2: Var with varno=1, varattno=1
WARNING:      base column 3: Var with varno=1, varattno=2
WARNING:      base column 4: Var with varno=1, varattno=5
WARNING:    TargetList: combined 6 total exprs (5 base + 1 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                  QUERY PLAN                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, brand, rating, (count(*) OVER (?))
   ->  Sort
         Output: id, name, category, brand, rating, (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, category, brand, rating, count(*) OVER (?)
               ->  Sort
                     Output: category, rating, id, name, brand
                     Sort Key: products.category, products.rating DESC
                     ->  Custom Scan (ParadeDB Scan) on public.products
                           Output: category, rating, id, name, brand
                           Table: products
                           Index: products_idx
                           Exec Method: NormalScanExecState
                           Scores: false
                           Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(17 rows)

SELECT 
    id,
    name,
    category,
    brand,
    rating,
    COUNT(*) OVER (PARTITION BY category ORDER BY rating DESC) as category_rank_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=7
WARNING:      base column 2: Var with varno=1, varattno=1
WARNING:      base column 3: Var with varno=1, varattno=2
WARNING:      base column 4: Var with varno=1, varattno=5
WARNING:    TargetList: combined 6 total exprs (5 base + 1 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | category | brand  | rating | category_rank_count 
----+-------------+----------+--------+--------+---------------------
  1 | MacBook Pro | Laptops  | Apple  |    4.8 |                   1
  5 | ASUS ROG    | Laptops  | ASUS   |    4.7 |                   2
  3 | ThinkPad X1 | Laptops  | Lenovo |    4.5 |                   3
(3 rows)

-- Test 11: Window aggregate without ORDER BY on base query
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop';
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
                                                                      QUERY PLAN                                                                       
-------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.products
   Output: id, name, rating, paradedb.window_func()
   Index: products_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: 
     Aggregate Definition: {"_doc_count":{"value_count":{"field":"ctid","missing":null}}}
(6 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop';
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  PassThrough columns not yet implemented in AggregateScan execution
-- Test 12: Window aggregate with RANGE frame
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    SUM(price) OVER (ORDER BY rating RANGE BETWEEN 0.5 PRECEDING AND 0.5 FOLLOWING) as range_sum
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                  QUERY PLAN                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, price, (sum(price) OVER (?))
   ->  Sort
         Output: id, name, rating, price, (sum(price) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, rating, price, sum(price) OVER (?)
               ->  Sort
                     Output: rating, id, name, price
                     Sort Key: products.rating
                     ->  Custom Scan (ParadeDB Scan) on public.products
                           Output: rating, id, name, price
                           Table: products
                           Index: products_idx
                           Exec Method: NormalScanExecState
                           Scores: false
                           Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(17 rows)

SELECT 
    id,
    name,
    rating,
    price,
    SUM(price) OVER (ORDER BY rating RANGE BETWEEN 0.5 PRECEDING AND 0.5 FOLLOWING) as range_sum
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | rating | price | range_sum 
----+-------------+--------+-------+-----------
  1 | MacBook Pro |    4.8 |  2499 |      7396
  5 | ASUS ROG    |    4.7 |  1899 |      7396
  3 | ThinkPad X1 |    4.5 |  1599 |      7396
(3 rows)

-- Test 13: Multiple different PARTITION BY clauses
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    brand,
    rating,
    COUNT(*) OVER (PARTITION BY category) as by_category,
    COUNT(*) OVER (PARTITION BY brand) as by_brand,
    COUNT(*) OVER () as total
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 3 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 8 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=5
WARNING:      base column 2: Var with varno=1, varattno=1
WARNING:      base column 3: Var with varno=1, varattno=2
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                           QUERY PLAN                                                                                            
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, brand, rating, (count(*) OVER (?)), (count(*) OVER (?)), (count(*) OVER (?))
   ->  Sort
         Output: id, name, category, brand, rating, (count(*) OVER (?)), (count(*) OVER (?)), (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, category, brand, rating, (count(*) OVER (?)), (count(*) OVER (?)), count(*) OVER (?)
               ->  WindowAgg
                     Output: category, brand, id, name, rating, (count(*) OVER (?)), count(*) OVER (?)
                     ->  Sort
                           Output: category, brand, id, name, rating, (count(*) OVER (?))
                           Sort Key: products.category
                           ->  WindowAgg
                                 Output: category, brand, id, name, rating, count(*) OVER (?)
                                 ->  Sort
                                       Output: category, brand, id, name, rating
                                       Sort Key: products.brand
                                       ->  Custom Scan (ParadeDB Scan) on public.products
                                             Output: category, brand, id, name, rating
                                             Table: products
                                             Index: products_idx
                                             Exec Method: NormalScanExecState
                                             Scores: false
                                             Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(24 rows)

SELECT 
    id,
    name,
    category,
    brand,
    rating,
    COUNT(*) OVER (PARTITION BY category) as by_category,
    COUNT(*) OVER (PARTITION BY brand) as by_brand,
    COUNT(*) OVER () as total
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 3 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 8 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=5
WARNING:      base column 2: Var with varno=1, varattno=1
WARNING:      base column 3: Var with varno=1, varattno=2
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | category | brand  | rating | by_category | by_brand | total 
----+-------------+----------+--------+--------+-------------+----------+-------
  1 | MacBook Pro | Laptops  | Apple  |    4.8 |           4 |        1 |     4
  5 | ASUS ROG    | Laptops  | ASUS   |    4.7 |           4 |        1 |     4
  3 | ThinkPad X1 | Laptops  | Lenovo |    4.5 |           4 |        1 |     4
(3 rows)

-- Test 14: Window aggregate with GROUPS frame (PG17+)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER (ORDER BY rating GROUPS BETWEEN 1 PRECEDING AND CURRENT ROW) as group_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                  QUERY PLAN                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (count(*) OVER (?))
   ->  Sort
         Output: id, name, rating, (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, rating, count(*) OVER (?)
               ->  Sort
                     Output: rating, id, name
                     Sort Key: products.rating
                     ->  Custom Scan (ParadeDB Scan) on public.products
                           Output: rating, id, name
                           Table: products
                           Index: products_idx
                           Exec Method: NormalScanExecState
                           Scores: false
                           Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(17 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER (ORDER BY rating GROUPS BETWEEN 1 PRECEDING AND CURRENT ROW) as group_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=7
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | rating | group_count 
----+-------------+--------+-------------
  1 | MacBook Pro |    4.8 |           2
  5 | ASUS ROG    |    4.7 |           2
  3 | ThinkPad X1 |    4.5 |           2
(3 rows)

-- Test 15: TopN with no @@@ operator (should not trigger window function handling)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE rating > 4.5
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Returning None: no @@@ operator found (quals=false, targetlist=false)
WARNING:    AggregateScan returned None
                        QUERY PLAN                         
-----------------------------------------------------------
 Limit
   Output: id, name, rating, (count(*) OVER (?))
   ->  Sort
         Output: id, name, rating, (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, rating, count(*) OVER (?)
               ->  Seq Scan on public.products
                     Output: id, name, rating
                     Filter: (products.rating > 4.5)
(10 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE rating > 4.5
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Returning None: no @@@ operator found (quals=false, targetlist=false)
WARNING:    AggregateScan returned None
 id |    name     | rating | total_count 
----+-------------+--------+-------------
  1 | MacBook Pro |    4.8 |           3
  5 | ASUS ROG    |    4.7 |           3
  2 | Dell XPS 13 |    4.6 |           3
(3 rows)

-- Test 16: Window aggregate with multiple base table columns
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    brand,
    price,
    rating,
    sales,
    COUNT(*) OVER () as total_count,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 2;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 7 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 7 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:      input path expr 5: type=T_Var
WARNING:      input path expr 6: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 9 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (7 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=4
WARNING:      base column 3: Var with varno=1, varattno=5
WARNING:      base column 4: Var with varno=1, varattno=6
WARNING:      base column 5: Var with varno=1, varattno=7
WARNING:      base column 6: Var with varno=1, varattno=9
WARNING:    TargetList: combined 9 total exprs (7 base + 2 window funcs)
WARNING:    TargetList: starting to process 9 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_Var
WARNING:    TargetList: processing expr 6 with node_tag=T_Var
WARNING:    TargetList: processing expr 7 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 8 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 9 entries
WARNING:        Replacing WindowFunc at resno=8 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=9 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 9 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    category,
    brand,
    price,
    rating,
    sales,
    COUNT(*) OVER () as total_count,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 2;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 7 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 7 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:      input path expr 5: type=T_Var
WARNING:      input path expr 6: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 9 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (7 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=4
WARNING:      base column 3: Var with varno=1, varattno=5
WARNING:      base column 4: Var with varno=1, varattno=6
WARNING:      base column 5: Var with varno=1, varattno=7
WARNING:      base column 6: Var with varno=1, varattno=9
WARNING:    TargetList: combined 9 total exprs (7 base + 2 window funcs)
WARNING:    TargetList: starting to process 9 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_Var
WARNING:    TargetList: processing expr 6 with node_tag=T_Var
WARNING:    TargetList: processing expr 7 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 8 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 9 entries
WARNING:        Replacing WindowFunc at resno=8 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=9 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 9 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 17: Window aggregate in a subquery (TopN in outer query)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT * FROM (
    SELECT 
        id,
        name,
        rating,
        price,
        COUNT(*) OVER () as total_count
    FROM products
    WHERE description @@@ 'laptop'
    ORDER BY rating DESC
    LIMIT 5
) sub
ORDER BY price DESC
LIMIT 2;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 5 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 5 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 2
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT * FROM (
    SELECT 
        id,
        name,
        rating,
        price,
        COUNT(*) OVER () as total_count
    FROM products
    WHERE description @@@ 'laptop'
    ORDER BY rating DESC
    LIMIT 5
) sub
ORDER BY price DESC
LIMIT 2;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 5 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 5 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 2
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 18: Value Facet - Category distribution (like Elasticsearch value facets)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    rating,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY category) as category_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                     QUERY PLAN                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, rating, (count(*) OVER (?)), (count(*) OVER (?))
   ->  Sort
         Output: id, name, category, rating, (count(*) OVER (?)), (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, category, rating, count(*) OVER (?), (count(*) OVER (?))
               ->  WindowAgg
                     Output: category, id, name, rating, count(*) OVER (?)
                     ->  Sort
                           Output: category, id, name, rating
                           Sort Key: products.category
                           ->  Custom Scan (ParadeDB Scan) on public.products
                                 Output: category, id, name, rating
                                 Table: products
                                 Index: products_idx
                                 Exec Method: NormalScanExecState
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(19 rows)

SELECT 
    id,
    name,
    category,
    rating,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY category) as category_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | category | rating | total_results | category_count 
----+-------------+----------+--------+---------------+----------------
  1 | MacBook Pro | Laptops  |    4.8 |             4 |              4
  5 | ASUS ROG    | Laptops  |    4.7 |             4 |              4
  3 | ThinkPad X1 | Laptops  |    4.5 |             4 |              4
(3 rows)

-- Test 19: Range Facet - Price buckets (like Elasticsearch range facets)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    price,
    CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END as price_bucket,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END) as bucket_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_CaseExpr
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 7 total exprs (5 base + 2 window funcs)
WARNING:    TargetList: starting to process 7 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_CaseExpr
WARNING:    AggregateScan returned None
                                                                                                           QUERY PLAN                                                                                                            
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, price, (CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END), (count(*) OVER (?)), (count(*) OVER (?)), rating
   ->  Sort
         Output: id, name, price, (CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END), (count(*) OVER (?)), (count(*) OVER (?)), rating
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, price, (CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END), count(*) OVER (?), (count(*) OVER (?)), rating
               ->  WindowAgg
                     Output: (CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END), id, name, price, rating, count(*) OVER (?)
                     ->  Sort
                           Output: (CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END), id, name, price, rating
                           Sort Key: (CASE WHEN (products.price < '1000'::numeric) THEN 'Budget'::text WHEN (products.price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END)
                           ->  Custom Scan (ParadeDB Scan) on public.products
                                 Output: CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END, id, name, price, rating
                                 Table: products
                                 Index: products_idx
                                 Exec Method: NormalScanExecState
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(19 rows)

SELECT 
    id,
    name,
    price,
    CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END as price_bucket,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END) as bucket_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_CaseExpr
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 7 total exprs (5 base + 2 window funcs)
WARNING:    TargetList: starting to process 7 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_CaseExpr
WARNING:    AggregateScan returned None
 id |    name     | price | price_bucket | total_results | bucket_count 
----+-------------+-------+--------------+---------------+--------------
  1 | MacBook Pro |  2499 | Premium      |             4 |            3
  5 | ASUS ROG    |  1899 | Premium      |             4 |            3
  3 | ThinkPad X1 |  1599 | Premium      |             4 |            3
  4 | HP Spectre  |  1399 | Mid-range    |             4 |            1
(4 rows)

-- Test 20: Multi-facet - Brand + Price range (combining multiple facets)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    brand,
    price,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    AVG(price) OVER (PARTITION BY brand) as avg_brand_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 8 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=5
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                     QUERY PLAN                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, brand, price, (count(*) OVER (?)), (count(*) OVER (?)), (avg(price) OVER (?)), rating
   ->  Sort
         Output: id, name, brand, price, (count(*) OVER (?)), (count(*) OVER (?)), (avg(price) OVER (?)), rating
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, brand, price, count(*) OVER (?), (count(*) OVER (?)), (avg(price) OVER (?)), rating
               ->  WindowAgg
                     Output: brand, id, name, price, rating, count(*) OVER (?), avg(price) OVER (?)
                     ->  Sort
                           Output: brand, id, name, price, rating
                           Sort Key: products.brand
                           ->  Custom Scan (ParadeDB Scan) on public.products
                                 Output: brand, id, name, price, rating
                                 Table: products
                                 Index: products_idx
                                 Exec Method: NormalScanExecState
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(19 rows)

SELECT 
    id,
    name,
    brand,
    price,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    AVG(price) OVER (PARTITION BY brand) as avg_brand_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 8 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=5
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | brand  | price | total_results | brand_count |    avg_brand_price    
----+-------------+--------+-------+---------------+-------------+-----------------------
  1 | MacBook Pro | Apple  |  2499 |             4 |           1 | 2499.0000000000000000
  5 | ASUS ROG    | ASUS   |  1899 |             4 |           1 | 1899.0000000000000000
  3 | ThinkPad X1 | Lenovo |  1599 |             4 |           1 | 1599.0000000000000000
(3 rows)

-- Test 21: Facet with aggregates - MIN/MAX price per category
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    price,
    COUNT(*) OVER () as total_results,
    MIN(price) OVER (PARTITION BY category) as category_min_price,
    MAX(price) OVER (PARTITION BY category) as category_max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 8 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                     QUERY PLAN                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, price, (count(*) OVER (?)), (min(price) OVER (?)), (max(price) OVER (?)), rating
   ->  Sort
         Output: id, name, category, price, (count(*) OVER (?)), (min(price) OVER (?)), (max(price) OVER (?)), rating
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, category, price, count(*) OVER (?), (min(price) OVER (?)), (max(price) OVER (?)), rating
               ->  WindowAgg
                     Output: category, id, name, price, rating, min(price) OVER (?), max(price) OVER (?)
                     ->  Sort
                           Output: category, id, name, price, rating
                           Sort Key: products.category
                           ->  Custom Scan (ParadeDB Scan) on public.products
                                 Output: category, id, name, price, rating
                                 Table: products
                                 Index: products_idx
                                 Exec Method: NormalScanExecState
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(19 rows)

SELECT 
    id,
    name,
    category,
    price,
    COUNT(*) OVER () as total_results,
    MIN(price) OVER (PARTITION BY category) as category_min_price,
    MAX(price) OVER (PARTITION BY category) as category_max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 8 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=4
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=7
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | category | price | total_results | category_min_price | category_max_price 
----+-------------+----------+-------+---------------+--------------------+--------------------
  1 | MacBook Pro | Laptops  |  2499 |             4 |               1399 |               2499
  5 | ASUS ROG    | Laptops  |  1899 |             4 |               1399 |               2499
  3 | ThinkPad X1 | Laptops  |  1599 |             4 |               1399 |               2499
(3 rows)

-- Test 22: Boolean facet - In-stock availability
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    in_stock,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=8
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                                     QUERY PLAN                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, in_stock, (count(*) OVER (?)), (count(*) OVER (?)), rating
   ->  Sort
         Output: id, name, in_stock, (count(*) OVER (?)), (count(*) OVER (?)), rating
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, in_stock, count(*) OVER (?), (count(*) OVER (?)), rating
               ->  WindowAgg
                     Output: in_stock, id, name, rating, count(*) OVER (?)
                     ->  Sort
                           Output: in_stock, id, name, rating
                           Sort Key: products.in_stock
                           ->  Custom Scan (ParadeDB Scan) on public.products
                                 Output: in_stock, id, name, rating
                                 Table: products
                                 Index: products_idx
                                 Exec Method: NormalScanExecState
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(19 rows)

SELECT 
    id,
    name,
    in_stock,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=8
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | in_stock | total_results | stock_count 
----+-------------+----------+---------------+-------------
  1 | MacBook Pro | t        |             4 |           4
  5 | ASUS ROG    | t        |             4 |           4
  3 | ThinkPad X1 | t        |             4 |           4
(3 rows)

-- Test 23: Popularity facet - Sales volume buckets
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    sales,
    CASE 
        WHEN sales < 100 THEN 'Low'
        WHEN sales < 150 THEN 'Medium'
        ELSE 'High'
    END as sales_volume,
    COUNT(*) OVER () as total_results,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=9
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    sales,
    CASE 
        WHEN sales < 100 THEN 'Low'
        WHEN sales < 150 THEN 'Medium'
        ELSE 'High'
    END as sales_volume,
    COUNT(*) OVER () as total_results,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=9
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 24: Rating histogram - Rating distribution
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END as rating_tier,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END) as tier_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_CaseExpr
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_CaseExpr
WARNING:    AggregateScan returned None
                                                                                                                                  QUERY PLAN                                                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END), (count(*) OVER (?)), (count(*) OVER (?))
   ->  Sort
         Output: id, name, rating, (CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END), (count(*) OVER (?)), (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, rating, (CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END), count(*) OVER (?), (count(*) OVER (?))
               ->  WindowAgg
                     Output: (CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END), id, name, rating, count(*) OVER (?)
                     ->  Sort
                           Output: (CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END), id, name, rating
                           Sort Key: (CASE WHEN (products.rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (products.rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (products.rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END)
                           ->  Custom Scan (ParadeDB Scan) on public.products
                                 Output: CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END, id, name, rating
                                 Table: products
                                 Index: products_idx
                                 Exec Method: NormalScanExecState
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(19 rows)

SELECT 
    id,
    name,
    rating,
    CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END as rating_tier,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END) as tier_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_CaseExpr
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 2 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 1: Var with varno=1, varattno=1
WARNING:      base column 2: Var with varno=1, varattno=2
WARNING:      base column 3: Var with varno=1, varattno=7
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_CaseExpr
WARNING:    AggregateScan returned None
 id |    name     | rating |     rating_tier     | total_results | tier_count 
----+-------------+--------+---------------------+---------------+------------
  1 | MacBook Pro |    4.8 | Excellent (4.7+)    |             4 |          2
  5 | ASUS ROG    |    4.7 | Excellent (4.7+)    |             4 |          2
  3 | ThinkPad X1 |    4.5 | Very Good (4.5-4.7) |             4 |          1
  4 | HP Spectre  |    4.4 | Good (4.0-4.5)      |             4 |          1
(4 rows)

-- Test 25: Complete faceting scenario - Combining all facet types
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    brand,
    price,
    rating,
    in_stock,
    -- Overall metrics
    COUNT(*) OVER () as total_results,
    AVG(price) OVER () as avg_price,
    AVG(rating) OVER () as avg_rating,
    -- Brand facets
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    -- Price range facets
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1500 THEN 'Under $1500'
        ELSE '$1500+'
    END) as price_range_count,
    -- Stock facets
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 7 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 7 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_CaseExpr
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:      input path expr 5: type=T_Var
WARNING:      input path expr 6: type=T_Var
WARNING:    parse.windowClause has 4 entries
WARNING:    parse.targetList has 6 WindowFunc nodes
WARNING:    root.processed_tlist has 13 entries
WARNING:    root.processed_tlist has 6 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (7 base columns)
WARNING:      base column 0: Var with varno=1, varattno=5
WARNING:      base column 1: Var with varno=1, varattno=8
WARNING:      base column 3: Var with varno=1, varattno=1
WARNING:      base column 4: Var with varno=1, varattno=2
WARNING:      base column 5: Var with varno=1, varattno=6
WARNING:      base column 6: Var with varno=1, varattno=7
WARNING:    TargetList: combined 13 total exprs (7 base + 6 window funcs)
WARNING:    TargetList: starting to process 13 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_CaseExpr
WARNING:    AggregateScan returned None
                                                                                                                                     QUERY PLAN                                                                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, brand, price, rating, in_stock, (count(*) OVER (?)), (avg(price) OVER (?)), (avg(rating) OVER (?)), (count(*) OVER (?)), (count(*) OVER (?)), (count(*) OVER (?)), (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END)
   ->  Sort
         Output: id, name, brand, price, rating, in_stock, (count(*) OVER (?)), (avg(price) OVER (?)), (avg(rating) OVER (?)), (count(*) OVER (?)), (count(*) OVER (?)), (count(*) OVER (?)), (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END)
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, brand, price, rating, in_stock, count(*) OVER (?), avg(price) OVER (?), avg(rating) OVER (?), (count(*) OVER (?)), (count(*) OVER (?)), (count(*) OVER (?)), (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END)
               ->  WindowAgg
                     Output: brand, in_stock, (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END), id, name, price, rating, (count(*) OVER (?)), (count(*) OVER (?)), count(*) OVER (?)
                     ->  Sort
                           Output: brand, in_stock, (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END), id, name, price, rating, (count(*) OVER (?)), (count(*) OVER (?))
                           Sort Key: products.brand
                           ->  WindowAgg
                                 Output: brand, in_stock, (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END), id, name, price, rating, (count(*) OVER (?)), count(*) OVER (?)
                                 ->  Sort
                                       Output: brand, in_stock, (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END), id, name, price, rating, (count(*) OVER (?))
                                       Sort Key: (CASE WHEN (products.price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END)
                                       ->  WindowAgg
                                             Output: brand, in_stock, (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END), id, name, price, rating, count(*) OVER (?)
                                             ->  Sort
                                                   Output: brand, in_stock, (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END), id, name, price, rating
                                                   Sort Key: products.in_stock
                                                   ->  Custom Scan (ParadeDB Scan) on public.products
                                                         Output: brand, in_stock, CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END, id, name, price, rating
                                                         Table: products
                                                         Index: products_idx
                                                         Exec Method: NormalScanExecState
                                                         Scores: false
                                                         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(29 rows)

SELECT 
    id,
    name,
    brand,
    price,
    rating,
    in_stock,
    -- Overall metrics
    COUNT(*) OVER () as total_results,
    AVG(price) OVER () as avg_price,
    AVG(rating) OVER () as avg_rating,
    -- Brand facets
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    -- Price range facets
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1500 THEN 'Under $1500'
        ELSE '$1500+'
    END) as price_range_count,
    -- Stock facets
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 7 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 7 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_CaseExpr
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:      input path expr 5: type=T_Var
WARNING:      input path expr 6: type=T_Var
WARNING:    parse.windowClause has 4 entries
WARNING:    parse.targetList has 6 WindowFunc nodes
WARNING:    root.processed_tlist has 13 entries
WARNING:    root.processed_tlist has 6 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (7 base columns)
WARNING:      base column 0: Var with varno=1, varattno=5
WARNING:      base column 1: Var with varno=1, varattno=8
WARNING:      base column 3: Var with varno=1, varattno=1
WARNING:      base column 4: Var with varno=1, varattno=2
WARNING:      base column 5: Var with varno=1, varattno=6
WARNING:      base column 6: Var with varno=1, varattno=7
WARNING:    TargetList: combined 13 total exprs (7 base + 6 window funcs)
WARNING:    TargetList: starting to process 13 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_CaseExpr
WARNING:    AggregateScan returned None
 id |    name     | brand  | price | rating | in_stock | total_results |       avg_price       |     avg_rating     | brand_count | price_range_count | stock_count 
----+-------------+--------+-------+--------+----------+---------------+-----------------------+--------------------+-------------+-------------------+-------------
  1 | MacBook Pro | Apple  |  2499 |    4.8 | t        |             4 | 1849.0000000000000000 | 4.6000000000000000 |           1 |                 3 |           4
  5 | ASUS ROG    | ASUS   |  1899 |    4.7 | t        |             4 | 1849.0000000000000000 | 4.6000000000000000 |           1 |                 3 |           4
  3 | ThinkPad X1 | Lenovo |  1599 |    4.5 | t        |             4 | 1849.0000000000000000 | 4.6000000000000000 |           1 |                 3 |           4
(3 rows)

-- =============================================================================
-- QUERY CONTEXT FEATURE FLAG TESTS
-- Testing HAVING_SUPPORT, JOIN_SUPPORT, and SUBQUERY_SUPPORT feature flags
-- =============================================================================
-- Test 26: Window function with HAVING clause (should NOT use custom scan - HAVING_SUPPORT=false)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    category,
    AVG(price) as avg_price,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop'
GROUP BY category
HAVING AVG(price) > 1000
ORDER BY avg_price DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_GROUP_AGG stage, calling AggregateScan
WARNING:    aggregate custom scan disabled, returning
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 4
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 2 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 2 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Aggref
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 3 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    input_rel is not a base relation, returning None
WARNING:    AggregateScan returned None
                                                                                     QUERY PLAN                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: category, (avg(price)), (count(*) OVER (?))
   ->  Sort
         Output: category, (avg(price)), (count(*) OVER (?))
         Sort Key: (avg(products.price)) DESC
         ->  WindowAgg
               Output: category, (avg(price)), count(*) OVER (?)
               ->  GroupAggregate
                     Output: category, avg(price)
                     Group Key: products.category
                     Filter: (avg(products.price) > '1000'::numeric)
                     ->  Sort
                           Output: category, price
                           Sort Key: products.category
                           ->  Custom Scan (ParadeDB Scan) on public.products
                                 Output: category, price
                                 Table: products
                                 Index: products_idx
                                 Exec Method: NormalScanExecState
                                 Scores: false
                                 Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(21 rows)

SELECT 
    category,
    AVG(price) as avg_price,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop'
GROUP BY category
HAVING AVG(price) > 1000
ORDER BY avg_price DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_GROUP_AGG stage, calling AggregateScan
WARNING:    aggregate custom scan disabled, returning
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 4
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 2 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 2 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Aggref
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 3 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    input_rel is not a base relation, returning None
WARNING:    AggregateScan returned None
 category |       avg_price       | total_count 
----------+-----------------------+-------------
 Laptops  | 1849.0000000000000000 |           1
(1 row)

-- Test 27: Window function with JOIN (should NOT use custom scan - JOIN_SUPPORT=false)
-- Create a second table for JOIN testing
CREATE TABLE product_categories (
    name TEXT PRIMARY KEY,
    description TEXT,
    priority INTEGER
);
INSERT INTO product_categories VALUES 
('Laptops', 'Portable computing devices', 1);
CREATE INDEX product_categories_idx ON product_categories
USING bm25(name, description, priority)
WITH (key_field='name');
WARNING:  the `raw` tokenizer is deprecated
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    p.id,
    p.name,
    p.rating,
    pc.description as category_desc,
    COUNT(*) OVER() AS total_count
FROM products p
JOIN product_categories pc ON p.category = pc.name
WHERE p.description @@@ 'laptop'
ORDER BY p.rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 1
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    input_rel is not a base relation, returning None
WARNING:    AggregateScan returned None
                                                                                  QUERY PLAN                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: p.id, p.name, p.rating, pc.description, (count(*) OVER (?))
   ->  Sort
         Output: p.id, p.name, p.rating, pc.description, (count(*) OVER (?))
         Sort Key: p.rating DESC
         ->  WindowAgg
               Output: p.id, p.name, p.rating, pc.description, count(*) OVER (?)
               ->  Nested Loop
                     Output: p.id, p.name, p.rating, pc.description
                     Join Filter: (p.category = pc.name)
                     ->  Seq Scan on public.product_categories pc
                           Output: pc.name, pc.description, pc.priority
                     ->  Custom Scan (ParadeDB Scan) on public.products p
                           Output: p.id, p.name, p.rating, p.category
                           Table: products
                           Index: products_idx
                           Exec Method: NormalScanExecState
                           Scores: false
                           Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(19 rows)

SELECT 
    p.id,
    p.name,
    p.rating,
    pc.description as category_desc,
    COUNT(*) OVER() AS total_count
FROM products p
JOIN product_categories pc ON p.category = pc.name
WHERE p.description @@@ 'laptop'
ORDER BY p.rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 1
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    input_rel is not a base relation, returning None
WARNING:    AggregateScan returned None
 id |    name     | rating |       category_desc        | total_count 
----+-------------+--------+----------------------------+-------------
  1 | MacBook Pro |    4.8 | Portable computing devices |           4
  5 | ASUS ROG    |    4.7 | Portable computing devices |           4
  3 | ThinkPad X1 |    4.5 | Portable computing devices |           4
(3 rows)

-- Test 28: Window function in subquery
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT *
FROM (
    SELECT 
        id,
        name,
        rating,
        price,
        COUNT(*) OVER() AS total_count
    FROM products
    WHERE description @@@ 'laptop'
    ORDER BY rating DESC
    LIMIT 5
) subq
WHERE total_count > 0
ORDER BY price DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 5 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 5 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 2
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT *
FROM (
    SELECT 
        id,
        name,
        rating,
        price,
        COUNT(*) OVER() AS total_count
    FROM products
    WHERE description @@@ 'laptop'
    ORDER BY rating DESC
    LIMIT 5
) subq
WHERE total_count > 0
ORDER BY price DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 5 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 5 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 2
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 29: Nested subqueries with window functions
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT outer_query.*
FROM (
    SELECT 
        inner_query.*,
        ROW_NUMBER() OVER(ORDER BY total_count DESC) as rank
    FROM (
        SELECT 
            id,
            name,
            rating,
            COUNT(*) OVER() AS total_count
        FROM products
        WHERE description @@@ 'laptop'
        ORDER BY rating DESC
        LIMIT 4
    ) inner_query
) outer_query
WHERE rank <= 2;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateScan returned None
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 3
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT outer_query.*
FROM (
    SELECT 
        inner_query.*,
        ROW_NUMBER() OVER(ORDER BY total_count DESC) as rank
    FROM (
        SELECT 
            id,
            name,
            rating,
            COUNT(*) OVER() AS total_count
        FROM products
        WHERE description @@@ 'laptop'
        ORDER BY rating DESC
        LIMIT 4
    ) inner_query
) outer_query
WHERE rank <= 2;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateScan returned None
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 3
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 30: Window function with HAVING + JOIN
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    p.category,
    pc.description,
    AVG(p.price) as avg_price,
    COUNT(*) OVER() AS total_count
FROM products p
JOIN product_categories pc ON p.category = pc.name
WHERE p.description @@@ 'laptop'
GROUP BY p.category, pc.description
HAVING AVG(p.price) > 1000
ORDER BY avg_price DESC
LIMIT 2;
WARNING:  Hook: UPPERREL_GROUP_AGG stage, calling AggregateScan
WARNING:    aggregate custom scan disabled, returning
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 4
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Aggref
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    input_rel is not a base relation, returning None
WARNING:    AggregateScan returned None
                                                                                        QUERY PLAN                                                                                         
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: p.category, pc.description, (avg(p.price)), (count(*) OVER (?))
   ->  Sort
         Output: p.category, pc.description, (avg(p.price)), (count(*) OVER (?))
         Sort Key: (avg(p.price)) DESC
         ->  WindowAgg
               Output: p.category, pc.description, (avg(p.price)), count(*) OVER (?)
               ->  GroupAggregate
                     Output: p.category, pc.description, avg(p.price)
                     Group Key: p.category, pc.description
                     Filter: (avg(p.price) > '1000'::numeric)
                     ->  Sort
                           Output: p.category, pc.description, p.price
                           Sort Key: p.category, pc.description
                           ->  Nested Loop
                                 Output: p.category, pc.description, p.price
                                 Join Filter: (p.category = pc.name)
                                 ->  Seq Scan on public.product_categories pc
                                       Output: pc.name, pc.description, pc.priority
                                 ->  Custom Scan (ParadeDB Scan) on public.products p
                                       Output: p.category, p.price
                                       Table: products
                                       Index: products_idx
                                       Exec Method: NormalScanExecState
                                       Scores: false
                                       Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(26 rows)

SELECT 
    p.category,
    pc.description,
    AVG(p.price) as avg_price,
    COUNT(*) OVER() AS total_count
FROM products p
JOIN product_categories pc ON p.category = pc.name
WHERE p.description @@@ 'laptop'
GROUP BY p.category, pc.description
HAVING AVG(p.price) > 1000
ORDER BY avg_price DESC
LIMIT 2;
WARNING:  Hook: UPPERREL_GROUP_AGG stage, calling AggregateScan
WARNING:    aggregate custom scan disabled, returning
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 4
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 1 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Aggref
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    input_rel is not a base relation, returning None
WARNING:    AggregateScan returned None
 category |        description         |       avg_price       | total_count 
----------+----------------------------+-----------------------+-------------
 Laptops  | Portable computing devices | 1849.0000000000000000 |           1
(1 row)

-- Test 31: Window function with FILTER clause in different contexts
-- Simple case
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    in_stock,
    COUNT(*) FILTER (WHERE rating > 4.5) OVER() AS high_rating_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=8
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
                                                                               QUERY PLAN                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, in_stock, (count(*) FILTER (WHERE (rating > 4.5)) OVER (?))
   ->  Sort
         Output: id, name, rating, in_stock, (count(*) FILTER (WHERE (rating > 4.5)) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, rating, in_stock, count(*) FILTER (WHERE (rating > 4.5)) OVER (?)
               ->  Custom Scan (ParadeDB Scan) on public.products
                     Output: id, name, rating, in_stock
                     Table: products
                     Index: products_idx
                     Exec Method: NormalScanExecState
                     Scores: false
                     Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(14 rows)

SELECT 
    id,
    name,
    rating,
    in_stock,
    COUNT(*) FILTER (WHERE rating > 4.5) OVER() AS high_rating_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 5 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=8
WARNING:    TargetList: combined 5 total exprs (4 base + 1 window funcs)
WARNING:    TargetList: starting to process 5 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    AggregateScan returned None
 id |    name     | rating | in_stock | high_rating_count 
----+-------------+--------+----------+-------------------
  1 | MacBook Pro |    4.8 | t        |                 2
  5 | ASUS ROG    |    4.7 | t        |                 2
  3 | ThinkPad X1 |    4.5 | t        |                 2
(3 rows)

-- With HAVING
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    category,
    AVG(rating) as avg_rating,
    COUNT(*) FILTER (WHERE price > 1500) OVER() AS expensive_count
FROM products
WHERE description @@@ 'laptop'
GROUP BY category
HAVING AVG(rating) > 4.0
ORDER BY avg_rating DESC
LIMIT 2;
ERROR:  column "products.price" must appear in the GROUP BY clause or be used in an aggregate function at character 122
SELECT 
    category,
    AVG(rating) as avg_rating,
    COUNT(*) FILTER (WHERE price > 1500) OVER() AS expensive_count
FROM products
WHERE description @@@ 'laptop'
GROUP BY category
HAVING AVG(rating) > 4.0
ORDER BY avg_rating DESC
LIMIT 2;
ERROR:  column "products.price" must appear in the GROUP BY clause or be used in an aggregate function at character 81
-- Test 32: Mixed supported and unsupported window functions (all-or-nothing test)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER() AS total_count,                    -- Supported (COUNT_ANY=true)
    SUM(price) OVER() AS total_price,                  -- Not supported (SUM=false)
    COUNT(brand) OVER() AS brand_count                 -- Not supported (COUNT=false)
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=5
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 7 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=7 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
ERROR:  variable not found in subplan target list
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER() AS total_count,                    -- Supported (COUNT_ANY=true)
    SUM(price) OVER() AS total_price,                  -- Not supported (SUM=false)
    COUNT(brand) OVER() AS brand_count                 -- Not supported (COUNT=false)
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 5 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 5 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:      input path expr 4: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (5 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:      base column 4: Var with varno=1, varattno=5
WARNING:    TargetList: combined 8 total exprs (5 base + 3 window funcs)
WARNING:    TargetList: starting to process 8 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_Var
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 7 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=7 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
ERROR:  variable not found in subplan target list
-- Test 33: Only supported window functions (should use custom scan)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER() AS total_count1,                   -- Supported (COUNT_ANY=true)
    COUNT(*) OVER() AS total_count2                    -- Supported (COUNT_ANY=true)
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 6 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 6 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER() AS total_count1,
    COUNT(*) OVER() AS total_count2
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 2 WindowFunc nodes
WARNING:    root.processed_tlist has 6 entries
WARNING:    root.processed_tlist has 2 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 6 total exprs (4 base + 2 window funcs)
WARNING:    TargetList: starting to process 6 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 6 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 6 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 34: Query without ORDER BY and LIMIT (should NOT use custom scan - ONLY_ALLOW_TOP_N=true)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop';
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
                                                                      QUERY PLAN                                                                       
-------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Aggregate Scan) on public.products
   Output: id, name, rating, paradedb.window_func()
   Index: products_idx
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
     Applies to Aggregates: 
     Aggregate Definition: {"_doc_count":{"value_count":{"field":"ctid","missing":null}}}
(6 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop';
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  PassThrough columns not yet implemented in AggregateScan execution
-- Test 35: Query with ORDER BY but no LIMIT (should NOT use custom scan - ONLY_ALLOW_TOP_N=true)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Test 36: Query with LIMIT but no ORDER BY (should NOT use custom scan - ONLY_ALLOW_TOP_N=true)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop'
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
                                                                         QUERY PLAN                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (paradedb.window_func())
   ->  Custom Scan (ParadeDB Aggregate Scan) on public.products
         Output: id, name, rating, paradedb.window_func()
         Index: products_idx
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
           Applies to Aggregates: 
           Limit: 3
           Aggregate Definition: {"_doc_count":{"value_count":{"field":"ctid","missing":null}}}
(9 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER() AS total_count
FROM products
WHERE description @@@ 'laptop'
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 3 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 3 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 1 WindowFunc nodes
WARNING:    root.processed_tlist has 4 entries
WARNING:    root.processed_tlist has 1 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (3 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:    TargetList: combined 4 total exprs (3 base + 1 window funcs)
WARNING:    TargetList: starting to process 4 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 4 entries
WARNING:        Replacing WindowFunc at resno=4 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 4 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  PassThrough columns not yet implemented in AggregateScan execution
-- Test 37: Window function with COALESCE
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER() AS total_count,
    SUM(COALESCE(price, 0.0)) OVER() AS total_price_with_default,
    AVG(COALESCE(rating, 4.0)) OVER() AS avg_rating_with_default
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 7 total exprs (4 base + 3 window funcs)
WARNING:    TargetList: starting to process 7 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=7 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER() AS total_count,
    SUM(COALESCE(price, 0.0)) OVER() AS total_price_with_default,
    AVG(COALESCE(rating, 4.0)) OVER() AS avg_rating_with_default
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  Hook: UPPERREL_WINDOW stage, calling AggregateScan
WARNING:  AggregateScan::create_custom_path called at stage 3
WARNING:    input_rel.reloptkind = 0
WARNING:    UPPERREL_WINDOW: checking available target lists
WARNING:    input_rel.reltarget has 4 exprs
WARNING:    output_rel.reltarget has 0 exprs
WARNING:    output_rel.pathlist has 1 paths
WARNING:    input_rel.pathlist has 2 paths
WARNING:    input_rel.cheapest_total_path.pathtarget has 4 exprs
WARNING:      input path expr 0: type=T_Var
WARNING:      input path expr 1: type=T_Var
WARNING:      input path expr 2: type=T_Var
WARNING:      input path expr 3: type=T_Var
WARNING:    parse.windowClause has 1 entries
WARNING:    parse.targetList has 3 WindowFunc nodes
WARNING:    root.processed_tlist has 7 entries
WARNING:    root.processed_tlist has 3 WindowFunc nodes
WARNING:    AggregateCSClause::build starting
WARNING:    TargetList::from_pg starting
WARNING:    TargetList: is_window_stage = true
WARNING:    TargetList: got schema
WARNING:    TargetList: UPPERREL_WINDOW using input_rel.reltarget (4 base columns)
WARNING:      base column 0: Var with varno=1, varattno=1
WARNING:      base column 1: Var with varno=1, varattno=2
WARNING:      base column 2: Var with varno=1, varattno=7
WARNING:      base column 3: Var with varno=1, varattno=6
WARNING:    TargetList: combined 7 total exprs (4 base + 3 window funcs)
WARNING:    TargetList: starting to process 7 expressions
WARNING:    TargetList: processing expr 0 with node_tag=T_Var
WARNING:    TargetList: processing expr 1 with node_tag=T_Var
WARNING:    TargetList: processing expr 2 with node_tag=T_Var
WARNING:    TargetList: processing expr 3 with node_tag=T_Var
WARNING:    TargetList: processing expr 4 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 5 with node_tag=T_WindowFunc
WARNING:    TargetList: processing expr 6 with node_tag=T_WindowFunc
WARNING:    targetlist extracted
WARNING:    orderby extracted
WARNING:    limit_offset extracted
WARNING:    quals extracted
WARNING:    Creating AggregateCSClause (quals=true, targetlist=false)
WARNING:    AggregateScan returned a path, adding it
WARNING:  AggregateScan::plan_custom_path called
WARNING:    Setting scanrelid = 1 (base scan)
WARNING:    rel.relid = 0
WARNING:    tlist has 0 entries
WARNING:    tlist is empty at UPPERREL_WINDOW, building our own
WARNING:      processed_tlist has 7 entries
WARNING:        Replacing WindowFunc at resno=5 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=6 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        Replacing WindowFunc at resno=7 with placeholder
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Built new tlist with 7 entries (WindowFunc replaced with placeholders)
WARNING:    About to call new_tlist.into_pg()
WARNING:    Called new_tlist.into_pg() successfully
WARNING:    Replacing WindowFunc in root.processed_tlist
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in root.processed_tlist
WARNING:    WARNING: parse.windowClause is not null - this might contain WindowFunc references
WARNING:    Cleared parse.windowClause
WARNING:    Replacing WindowFunc in parse.targetList
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:        make_window_func_placeholder_without_accessing_windowfunc called
WARNING:    Replaced WindowFunc in parse.targetList
WARNING:    Setting new target list on plan (WindowFunc already replaced)
WARNING:  AggregateScan::plan_custom_path returning CustomScan
WARNING:  AggregateScan::begin_custom_scan called - THIS IS A BUG if query has window functions!
WARNING:    execution_rti = 1
ERROR:  WindowFunc found in non-WindowAgg plan node
-- Cleanup
DROP TABLE product_categories CASCADE;
DROP TABLE products CASCADE;
