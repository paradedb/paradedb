-- Test TopN scan validation feature
-- This test validates that paradedb.check_topn_scan correctly warns when
-- queries with LIMIT cannot use TopN scan optimization
\i common/common_setup.sql
CREATE EXTENSION IF NOT EXISTS pg_search;
-- Disable parallel workers to avoid differences in plans
SET max_parallel_workers_per_gather = 0;
SET enable_indexscan to OFF;
SET paradedb.enable_mixed_fast_field_exec = true;
-- Create test table with appropriate data
CALL paradedb.create_bm25_test_table(
  schema_name => 'public',
  table_name => 'test_products'
);
-- Scenario 1: Index WITHOUT lower() but query uses lower() in ORDER BY
-- This should trigger a warning when check_topn_scan is enabled
CREATE INDEX products_base_idx ON test_products
USING bm25 (id, description, category, rating)
WITH (
    key_field='id',
    text_fields='{
        "category": {"fast": true, "tokenizer": {"type": "raw"}},
        "description": {"fast": false}
    }',
    numeric_fields='{"rating": {"fast": true}}'
);
-- Test 1: Validation OFF (default) - should not warn
\echo 'Test 1: Validation OFF (no warning expected)'
Test 1: Validation OFF (no warning expected)
SET paradedb.check_topn_scan = false;
SELECT id, description FROM test_products
WHERE description @@@ 'shoes'
ORDER BY description  -- Missing fast field
LIMIT 5;
 id |     description     
----+---------------------
  5 | Generic shoes
  3 | Sleek running shoes
  4 | White jogging shoes
(3 rows)

-- Test 2: Enable validation - should warn about missing fast field
\echo 'Test 2: Validation ON - warning expected (ORDER BY not a fast field)'
Test 2: Validation ON - warning expected (ORDER BY not a fast field)
SET paradedb.check_topn_scan = true;
SELECT id, description FROM test_products
WHERE description @@@ 'shoes'
ORDER BY description  -- Not marked as fast
LIMIT 5;
WARNING:  Query has LIMIT 5 but is not using TopN scan (using Normal instead). Reason: pathkeys are unusable. This may cause poor performance on large datasets. Consider: (1) ensuring ORDER BY columns are indexed with fast=true, (2) verifying normalizer matches (e.g., use lower() in index if used in ORDER BY), or (3) reducing ORDER BY columns to 3 or fewer.
 id |     description     
----+---------------------
  5 | Generic shoes
  3 | Sleek running shoes
  4 | White jogging shoes
(3 rows)

-- Test 3: Proper TopN - should NOT warn
\echo 'Test 3: Valid TopN query (no warning expected)'
Test 3: Valid TopN query (no warning expected)
SELECT id, category,rating FROM test_products
WHERE category @@@ 'electronics'
ORDER BY rating DESC  -- rating is fast
LIMIT 5;
 id |  category   | rating 
----+-------------+--------
 12 | Electronics |      5
  1 | Electronics |      4
  2 | Electronics |      4
 22 | Electronics |      4
 32 | Electronics |      3
(5 rows)

-- Test 4: Too many ORDER BY columns
DROP INDEX products_base_idx;
CREATE INDEX products_multi_idx ON test_products
USING bm25 (id, description, category, rating, created_at)
WITH (
    key_field='id',
    text_fields='{"category": {"fast": true}}',
    numeric_fields='{"rating": {"fast": true}}',
    datetime_fields='{"created_at": {"fast": true}}'
);
\echo 'Test 4: Too many ORDER BY columns (warning expected)'
Test 4: Too many ORDER BY columns (warning expected)
SELECT id FROM test_products
WHERE category @@@ 'electronics'
ORDER BY rating DESC, created_at DESC, id DESC, category DESC  -- 4 columns, max is 3
LIMIT 10;
WARNING:  Query has LIMIT 10 but is not using TopN scan (using Normal instead). Reason: pathkeys are unusable. This may cause poor performance on large datasets. Consider: (1) ensuring ORDER BY columns are indexed with fast=true, (2) verifying normalizer matches (e.g., use lower() in index if used in ORDER BY), or (3) reducing ORDER BY columns to 3 or fewer.
 id 
----
 12
  1
 22
  2
 32
(5 rows)

-- Test 5: Query with lower() mismatch
DROP INDEX products_multi_idx;
CREATE INDEX products_lower_idx ON test_products
USING bm25 (id, description, (lower(category)::pdb.literal), rating)
WITH (
    key_field='id'
);
\echo 'Test 5a: ORDER BY with lower() - should use TopN (no warning)'
Test 5a: ORDER BY with lower() - should use TopN (no warning)
SELECT id, category FROM test_products
WHERE category === 'Electronics'
ORDER BY lower(category) DESC  -- Matches index
LIMIT 5;
 id | category 
----+----------
(0 rows)

\echo 'Test 5b: ORDER BY without lower() - warning expected'
Test 5b: ORDER BY without lower() - warning expected
SELECT id, category FROM test_products
WHERE category === 'Electronics'
ORDER BY category DESC  -- Doesn't match - index has lower()
LIMIT 5;
WARNING:  Query has LIMIT 5 but is not using TopN scan (using FastFieldMixed instead). Reason: pathkeys are unusable. This may cause poor performance on large datasets. Consider: (1) ensuring ORDER BY columns are indexed with fast=true, (2) verifying normalizer matches (e.g., use lower() in index if used in ORDER BY), or (3) reducing ORDER BY columns to 3 or fewer.
 id | category 
----+----------
(0 rows)

-- Test 6: No LIMIT - should not validate or warn
\echo 'Test 6: No LIMIT (no validation, no warning)'
Test 6: No LIMIT (no validation, no warning)
SELECT id FROM test_products
WHERE category === 'Electronics'
ORDER BY rating DESC;  -- No LIMIT, so TopN not expected
 id 
----
(0 rows)

-- Test 7: EXPLAIN should show warning in logs
\echo 'Test 7: EXPLAIN with validation warning'
Test 7: EXPLAIN with validation warning
EXPLAIN (FORMAT TEXT, COSTS OFF, TIMING OFF)
SELECT id FROM test_products
WHERE category === 'Electronics'
ORDER BY category DESC  -- Should warn
LIMIT 10;
WARNING:  Query has LIMIT 10 but is not using TopN scan (using FastFieldMixed instead). Reason: pathkeys are unusable. This may cause poor performance on large datasets. Consider: (1) ensuring ORDER BY columns are indexed with fast=true, (2) verifying normalizer matches (e.g., use lower() in index if used in ORDER BY), or (3) reducing ORDER BY columns to 3 or fewer.
                                                          QUERY PLAN                                                           
-------------------------------------------------------------------------------------------------------------------------------
 Limit
   ->  Sort
         Sort Key: category DESC
         ->  Custom Scan (ParadeDB Scan) on test_products
               Table: test_products
               Index: products_lower_idx
               Exec Method: MixedFastFieldExecState
               Fast Fields: id, category
               Scores: false
               Tantivy Query: {"with_index":{"query":{"term":{"field":"category","value":"Electronics","is_datetime":false}}}}
(10 rows)

-- Test 8: Disable validation mid-session
\echo 'Test 8: Disable validation (no warning)'
Test 8: Disable validation (no warning)
SET paradedb.check_topn_scan = false;
SELECT id FROM test_products
WHERE category === 'Electronics'
ORDER BY category DESC  -- No warning now
LIMIT 10;
 id 
----
(0 rows)

-- Cleanup
DROP INDEX products_lower_idx;
DROP TABLE test_products;
\i common/common_cleanup.sql
-- Reset parallel workers setting to default
RESET max_parallel_workers_per_gather;
RESET enable_indexscan;
RESET paradedb.enable_mixed_fast_field_exec;
SELECT 'Common tests cleanup complete' AS status; 
            status             
-------------------------------
 Common tests cleanup complete
(1 row)

